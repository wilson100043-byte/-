<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å¤§åƒè²¨ç”Ÿå­˜æˆ°ï¼šäººæ ¼è¦ºé†’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* ç›¤å­æ¨£å¼ */
        .plate-container { width: 220px; height: 220px; border-radius: 50%; position: relative; background: radial-gradient(circle at 30% 30%, #fff, #f0f0f0); border: 6px solid #f8f9fa; margin: 0 auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.05), 0 10px 20px rgba(0,0,0,0.1); }
        .plate-slot { position: absolute; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .slot-0 { top: 10px; left: 50%; transform: translateX(-50%); }
        .slot-1 { top: 45px; right: 10px; }
        .slot-2 { bottom: 45px; right: 10px; }
        .slot-3 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .slot-4 { bottom: 45px; left: 10px; }
        .slot-5 { top: 45px; left: 10px; }

        .locked-persona { filter: brightness(0) opacity(0.3) grayscale(100%); }

        @keyframes unlockPop {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .unlock-animation {
            animation: unlockPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* --- çµç®—åœ–ç‰‡çš„è·³å‹•å‹•ç•« --- */
        @keyframes celebrate-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        
        .img-bounce {
            animation: celebrate-bounce 2s infinite ease-in-out;
        }

        /* è®“ç›¤å­ä¸Šçš„é£Ÿç‰© Hover æ™‚æ™ƒå‹• */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        .hover-wiggle:hover {
            animation: wiggle 0.3s ease-in-out infinite;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.4;
            width: max-content;
            max-width: 220px;
            white-space: normal;
            text-align: center;
            z-index: 50;
            pointer-events: none;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        };

        const foodDatabase = [
            { id: 4, name: "å°æœ¨å±‹é¬†é¤…(é®®å¥¶æ²¹)", emoji: "ğŸ§‡", calories: 450, p: 8, c: 55, f: 22, health: -8, mood: 15, tags: ['snack', 'restaurant'], desc: "ç”œèœœçš„ä¸‹åˆèŒ¶é¦–é¸ï¼Œä½†é®®å¥¶æ²¹ç†±é‡ä¸å®¹å°è¦·ã€‚" },
            { id: 6, name: "é³³åŸä¸‰å¯¶é£¯", emoji: "ğŸ›", calories: 900, p: 35, c: 110, f: 35, health: -10, mood: 20, tags: ['restaurant', 'night_market'], desc: "è‚‰é‡åè¶³çš„æ¸¯å¼ç‡’è‡˜ï¼Œé†¬æ±ä¸‹é£¯ä½†æ²¹è„‚çˆ†è¡¨ã€‚" },
            { id: 8, name: "è‡ªåŠ©é¤ç‡™é’èœ", emoji: "ğŸ¥¬", calories: 50, p: 2, c: 8, f: 1, health: 20, mood: -5, tags: ['restaurant', 'side'], desc: "å¤–é£Ÿæ—çš„æ•‘æ˜Ÿï¼Œæ¸…æ·¡å¥åº·è£œè¶³çº–ç¶­ã€‚" },
            { id: 9, name: "7-11 é›èƒ¸è‚‰", emoji: "ğŸ’ª", calories: 130, p: 24, c: 2, f: 2, health: 15, mood: -5, tags: ['convenience', 'tutorial_correct'], desc: "å¥èº«æ—å¿…å‚™ï¼Œéš¨æ™‚è£œå……å„ªè³ªä½è„‚è›‹ç™½ã€‚" },
            { id: 10, name: "è¶…å•†èŒ¶è‘‰è›‹", emoji: "ğŸ¥š", calories: 75, p: 7, c: 1, f: 5, health: 15, mood: 5, tags: ['convenience', 'breakfast', 'snack'], desc: "24å°æ™‚éƒ½èƒ½è²·åˆ°çš„å„ªè³ªè›‹ç™½ï¼Œæ¸›è„‚æ•‘æ˜Ÿã€‚" },
            { id: 19, name: "å°éœ¸ç‹-å¥½åƒçƒ¤é›é£¯", emoji: "ğŸ±", calories: 741, p: 42, c: 78, f: 29, health: 10, mood: 25, tags: ['restaurant', 'night_market'], desc: "é®®å«©çƒ¤é›é…ä¸ŠåŠç†Ÿè›‹ï¼Œç‡Ÿé¤Šè±å¯Œä½†ä»½é‡ä¹Ÿä¸å°ã€‚" },
            { id: 20, name: "å®‰å¥½é£Ÿ-é†¬ç‡’ç‰›è›‹é¤…", emoji: "ğŸŒ¯", calories: 476, p: 20, c: 36, f: 28, health: -5, mood: 30, tags: ['breakfast', 'restaurant'], desc: "é…¥è„†è›‹é¤…é…ä¸Šæ¿ƒéƒé†¬ç‡’ç‰›ï¼Œæ—©é¤çš„è±ªè¯äº«å—ã€‚" },
            { id: 21, name: "å–¬å“-é¤›é£©æ¹¯", emoji: "ğŸ¥£", calories: 150, p: 8, c: 10, f: 6, health: 5, mood: -10, tags: ['restaurant', 'night_market'], desc: "èƒ¡æ¤’åŠ çˆ†ä¸å°å¿ƒé£„é€²é¼»å­ç‹‚æ‰“å™´åšï¼Œä½†æ¹¯é ­ä¸éŒ¯ã€‚" },
            { id: 22, name: "è«å®°ç¾Š-ç¾Šè‚‰ç‚’éºµ", emoji: "ğŸ", calories: 800, p: 25, c: 70, f: 40, health: -15, mood: 10, tags: ['restaurant', 'night_market'], desc: "æœªæ¥é›»è©±é¡¯ç¤ºè¢å¹•ä¸Šï¼Œæ²™èŒ¶è¾£æ¤’ç‰¹åˆ¥é¦™ã€‚" },
            { id: 23, name: "ç¦æ¨‚å¯å¯è›‹ç™½ç‰›ä¹³", emoji: "ğŸ¥›", calories: 200, p: 21, c: 24, f: 3, health: 15, mood: 15, tags: ['convenience', 'drink'], desc: "è›‹ç™½è³ªè£œå……çš„å¥½é¸æ“‡ï¼Œä½†ç³–åˆ†åé«˜è¦æ³¨æ„ã€‚" },
            { id: 24, name: "è”¥ç‡‰-ç‰›è‚‰é¤›é£©éºµ", emoji: "ğŸœ", calories: 430, p: 30, c: 65, f: 12, health: 10, mood: 20, tags: ['restaurant'], desc: "ä¸€æ¬¡æ»¿è¶³ç‰›è‚‰èˆ‡é¤›é£©çš„é¡˜æœ›ï¼Œæ¹¯é ­æ¿ƒéƒæš–èƒƒã€‚" },
            { id: 25, name: "uPoke-é›èƒ¸è‚‰é¤ç›’", emoji: "ğŸ¥—", calories: 558, p: 45, c: 60, f: 12, health: 25, mood: 10, tags: ['restaurant'], desc: "æ¸…çˆ½ä½è² æ“”çš„å¥åº·é¤ï¼Œå¢è‚Œæ¸›è„‚çš„å¥½å¹«æ‰‹ã€‚" },
            { id: 26, name: "å…¨å®¶-çƒ¤è›‹ç™½é¤ç›’", emoji: "ğŸ±", calories: 438, p: 28, c: 58, f: 11, health: 20, mood: 15, tags: ['convenience'], desc: "å¥èº«å¾Œçš„æ–¹ä¾¿é¸æ“‡ï¼Œæ–¹å¡Šè›‹ç™½å£æ„Ÿç¨ç‰¹ã€‚" },
            { id: 27, name: "æ‘©æ–¯-æµ·æ´‹çç å ¡", emoji: "ğŸ¦", calories: 404, p: 10, c: 72, f: 8, health: -5, mood: 10, tags: ['fastfood'], desc: "å»ºè­°ä¸è¦ä¿®æ—ç§‹ç‡•çš„æ”¿åºœæª”æ¡ˆç®¡ç†ï¼Œå¥¹æœƒå«ä½ è‡ªå·±æƒ³è¾¦æ³•è·‘åˆ°æ—å£ã€‚" },
            { id: 28, name: "éº¥ç•¶å‹-éº¥é¦™é›", emoji: "ğŸ”", calories: 380, p: 15, c: 45, f: 16, health: -10, mood: 10, tags: ['fastfood'], desc: "ç¶“å…¸å¹³åƒ¹é¸æ“‡ï¼Œä½†ç¾ä¹ƒæ»‹æ˜¯ç†±é‡ä¾†æºã€‚" },
            { id: 29, name: "éº¥ç•¶å‹-ä¸­è–¯", emoji: "ğŸŸ", calories: 350, p: 5, c: 45, f: 17, health: -15, mood: 20, tags: ['fastfood', 'snack', 'tutorial_trap'], desc: "ç¾ç‚¸é…¥è„†ç„¡æ³•æ“‹ï¼Œæ²¹è„‚èˆ‡æ¾±ç²‰æ˜¯æ¸›è‚¥å¤§æ•µã€‚" },
            { id: 30, name: "éº¥ç•¶å‹-4å¡Šé›å¡Š", emoji: "ğŸ—", calories: 180, p: 10, c: 12, f: 11, health: -5, mood: 15, tags: ['fastfood', 'snack', 'tutorial_wrong'], desc: "è§£å˜´é¥çš„å°é»å¿ƒï¼Œæ³¨æ„éˆ‰å«é‡ã€‚" },
            { id: 31, name: "éº¥ç•¶å‹-å››ç›å¸ç‰›è‚‰å ¡", emoji: "ğŸ¥©", calories: 540, p: 30, c: 35, f: 28, health: -10, mood: 25, tags: ['fastfood'], desc: "åšå¯¦ç‰›è‚‰å¤šæ±æ»¿è¶³ï¼Œä½†é£½å’Œè„‚è‚ªè¼ƒé«˜ã€‚" },
            { id: 32, name: "éº¥ç•¶å‹-å¤§éº¥å…‹", emoji: "ğŸ”", calories: 530, p: 27, c: 45, f: 26, health: -20, mood: 30, tags: ['fastfood'], desc: "é›™å±¤ç‰›è‚‰çš„ç¶“å…¸ç¾å‘³ï¼Œé†¬æ–™ç†±é‡é«˜ã€‚" },
            { id: 33, name: "éº¥ç•¶å‹-éº¥è„†é›è…¿(1å¡Š)", emoji: "ğŸ—", calories: 370, p: 20, c: 15, f: 25, health: -15, mood: 25, tags: ['fastfood'], desc: "çš®è„†è‚‰å«©è¶…èª˜äººï¼Œå»çš®åƒèƒ½æ¸›å°‘å¾ˆå¤šç†±é‡ã€‚" },
            { id: 34, name: "7-11-é»ƒé‡‘ç‰ç±³æ£’", emoji: "ğŸŒ½", calories: 150, p: 5, c: 28, f: 2, health: 15, mood: 10, tags: ['convenience', 'snack'], desc: "ç”œè„†å¤šæ±ï¼Œæ¯”èµ·æ´‹èŠ‹ç‰‡å¥åº·ä¸€ç™¾å€çš„è¿½åŠ‡é›¶é£Ÿã€‚" },
            { id: 35, name: "å…¨å®¶-å¤¯ç•ªè–¯(ä¸­)", emoji: "ğŸ ", calories: 240, p: 3, c: 56, f: 1, health: 20, mood: 15, tags: ['convenience', 'snack'], desc: "ç¶¿å¯†é¦™ç”œï¼Œé€£çš®ä¸€èµ·åƒï¼Œçº–ç¶­è³ªå¤§çˆ†ç™¼ï¼" },
            { id: 36, name: "7-11-é¡†ç²’ç‡•éº¥é£²", emoji: "ğŸŒ¾", calories: 125, p: 4, c: 22, f: 1, health: 15, mood: 5, tags: ['convenience', 'drink'], desc: "å–å®Œè¦ºå¾—æœ‰é»å¥åº·ï¼Œç„¡è² æ“”çš„ç‡•éº¥é¡†ç²’å£æ„Ÿã€‚" },
            { id: 37, name: "YuPoke-é›è‚‰Poke", emoji: "ğŸ¥—", calories: 572, p: 28, c: 70, f: 20, health: 20, mood: 15, tags: ['restaurant'], desc: "å…¬é¤¨ç¶“å…¸åº—å®¶ï¼Œé…èœå†·é£Ÿæ¸…çˆ½é–‹èƒƒã€‚" },
            { id: 38, name: "7-11-åŒ—æµ·é“è•éº¥æ²¾éºµ", emoji: "ğŸœ", calories: 336, p: 14, c: 59, f: 5, health: 10, mood: 15, tags: ['convenience'], desc: "æ‰“æŠ˜æ™‚çš„é«˜CPå€¼é¸æ“‡ï¼Œæ²¾é†¬é…å†·éºµåƒèµ·ä¾†å¾ˆæœ‰å‘³ã€‚" }
        ];

        // --- 2. é£²é£Ÿäººæ ¼ ---
        const personaDatabase = [
            { id: 'protein_hunter', name: 'è›‹ç™½è³ªçµäºº', emoji: 'ğŸ’ª', image: './achievement_protein_hunter.png', desc: 'ä½ çš„çœ¼è£¡åªæœ‰é›èƒ¸è‚‰ï¼Œé€£å–æ°´éƒ½æƒ³åŠ è›‹ç™½ç²‰ã€‚', color: 'bg-red-100 text-red-800' },
            { id: 'oil_king', name: 'å…¬é¤¨æ²¹ç‹', emoji: 'ğŸ›¢ï¸', image: './achievement_oil_king.png', desc: 'ä½ çš„è¡€ç®¡è£¡æµçš„ä¸æ˜¯è¡€ï¼Œæ˜¯é¦™æ¿ƒçš„é›æ²¹èˆ‡æ»·è‚‰æ±ã€‚', color: 'bg-yellow-100 text-yellow-800' },
            { id: 'carb_cultist', name: 'æ¾±ç²‰æ•™å¾’', emoji: 'ğŸš', image: './achievement_carb_cultist.png', desc: 'é£¯ã€éºµã€éºµåŒ…...æ²’æœ‰æ¾±ç²‰çš„ä¸€é¤å°ä½ ä¾†èªªåªæ˜¯é»å¿ƒã€‚', color: 'bg-orange-100 text-orange-800' },
            { id: 'faster', name: 'çµ•é£Ÿç³»ä¿®ä»™è€…', emoji: 'ğŸ§˜', image: './achievement_faster.png', desc: 'åƒé€™éº¼å°‘ï¼Œä½ æ˜¯æº–å‚™å¾—é“æˆä»™äº†å—ï¼Ÿ', color: 'bg-gray-100 text-gray-800' },
            { id: 'nutritionist', name: 'ç‡Ÿé¤Šç²¾ç®—å¸«', emoji: 'ğŸ¥—', image: './achievement_nutritionist.png', desc: 'ä¸‰å¤§ç‡Ÿé¤Šç´ æ¯”ä¾‹å®Œç¾ï¼Œä½ æ˜¯ AI å§ï¼Ÿ', color: 'bg-green-100 text-green-800' },
            { id: 'happy_chubby', name: 'å¿«æ¨‚è‚¥å®…', emoji: 'ğŸ˜ˆ', image: './achievement_happy_chubby.png', desc: 'äººç”Ÿè‹¦çŸ­ï¼ŒåŠæ™‚è¡Œæ¨‚ï¼Œé«”é‡è¨ˆä»€éº¼çš„å…ˆä¸Ÿæ‰å§ã€‚', color: 'bg-purple-100 text-purple-800' },
        ];

        // --- 3. é—œå¡è¨­å®š ---
        const stages = {
            TUTORIAL: {
                id: 'TUTORIAL',
                title: 'Stage 0ï¼šç‡Ÿé¤Šæ–°æ‰‹æ‘',
                desc: 'æŒæ¡ä¸‰å¤§ç‡Ÿé¤Šç´ çš„å¥§ç§˜ï¼',
                type: 'tutorial_menu', 
                subLevels: [
                    {
                        id: 'tutorial_protein',
                        title: 'é—œå¡ 1ï¼šè›‹ç™½è³ªçµäºº',
                        desc: 'å¢è‚Œæ¸›è„‚çš„ç¬¬ä¸€æ­¥ï¼è«‹åœ¨æ‰€æœ‰é£Ÿç‰©ä¸­ï¼Œæ‰¾å‡ºè›‹ç™½è³ªå«é‡è±å¯Œçš„çµ„åˆã€‚',
                        objective: 'è›‹ç™½è³ªæ¯”ä¾‹ > 30%',
                        hint: "ç›®æ¨™ï¼šè›‹ç™½è³ªç†±é‡ä½”æ¯”è¶…é 30%",
                        criteria: (stats) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return pRatio > 0.3;
                        },
                        failMsg: "è›‹ç™½è³ªæ¯”ä¾‹ä¸è¶³å–”ï¼è©¦è‘—æ‰¾æ‰¾é›è‚‰ã€è›‹æˆ–è±†æ¼¿ï¼Œé¿å…å¤ªå¤šæ¾±ç²‰å’Œæ²¹ã€‚",
                        successMsg: "å¤ªæ£’äº†ï¼ä½ å·²ç¶“æŒæ¡äº†å°‹æ‰¾è›‹ç™½è³ªçš„æŠ€å·§ï¼"
                    },
                    {
                        id: 'tutorial_fat',
                        title: 'é—œå¡ 2ï¼šæ²¹è†©è†©æŒ‘æˆ°',
                        desc: 'é«”é©—ä»€éº¼å«åšè¡€ç®¡å µå¡ï¼è«‹çµ„å‡ºä¸€å€‹è¶…ç´šæ²¹è†©çš„é¤ç›¤ã€‚',
                        objective: 'æ²¹è„‚æ¯”ä¾‹ > 45%',
                        hint: "ç›®æ¨™ï¼šè„‚è‚ªç†±é‡ä½”æ¯”è¶…é 45%",
                        criteria: (stats) => {
                            const fRatio = (stats.totalF * 9) / (stats.calories || 1);
                            return fRatio > 0.45;
                        },
                        failMsg: "é‚„ä¸å¤ æ²¹å–”ï¼æ‰¾æ‰¾çœ‹ç‚¸ç‰©ã€é…¥çš®æˆ–æ˜¯åŸ¹æ ¹é¡çš„é£Ÿç‰©ã€‚",
                        successMsg: "å“‡ï¼é€™é¤çœŸçš„è¶…ç´šæ²¹ï¼è¡€ç®¡åœ¨å°–å«äº†ï¼"
                    }
                ]
            },
            WARMUP: {
                id: 'WARMUP',
                title: 'Stage 1ï¼šè‡ªç”±é£Ÿç¿’',
                desc: 'å…ˆä¾†åƒä¸€é¤è©¦è©¦æ°´æº«ï¼Œç†Ÿæ‚‰ä¸€ä¸‹æ“ä½œä»‹é¢ã€‚',
                type: 'meal',
                tags: [],
                hint: "é»æ“Š (i) å¯ä»¥æŸ¥çœ‹è©³ç´°æ•¸å€¼èˆ‡æè¿°å–”ï¼"
            },
            STORY: {
                id: 'STORY',
                title: 'Stage 2ï¼šä¸€æ—¥ç”Ÿå­˜æˆ°',
                desc: 'é¸æ“‡ä½ çš„ç›®æ¨™ï¼ŒæŒ‘æˆ°ä¸€æ—¥ä¸‰é¤ï¼',
                type: 'story_menu', // æ–°å¢çš„é¸å–®é¡å‹
                meals: [
                    { 
                        name: "æ—©é¤", 
                        tags: ['breakfast'], 
                        hint: "åªèƒ½é¸æ—©é¤åº—",
                        storyTitle: "â° 8:10 AM - ç¡éé ­å•¦ï¼",
                        storyDesc: "é¬§é˜éŸ¿äº†ä¸‰æ¬¡ä½ éƒ½æ²’è½åˆ°ï¼Œé†’ä¾†ç™¼ç¾è·é›¢ç¬¬ä¸€å ‚é¤¨è—ç™¼å±•åªå‰© 10 åˆ†é˜ï¼\n\næ²’æ™‚é–“å„ªé›…åœ°æ‰‹æ²–å’–å•¡äº†ï¼Œä½ å¿…é ˆåœ¨å»ç³»é¤¨çš„è·¯ä¸Šï¼Œç”¨æœ€å¿«çš„é€Ÿåº¦è§£æ±ºæ—©é¤ã€‚\n\nã€ä»»å‹™ç›®æ¨™ã€‘ è«‹åœ¨ã€Œæ—©é¤åº—ã€è¿…é€ŸæŠ“å–é£Ÿç‰©ï¼"
                    },
                    { 
                        name: "åˆé¤", 
                        tags: ['convenience', 'fastfood'], 
                        hint: "è¶•æ™‚é–“ï¼åªèƒ½åƒè¶…å•†æˆ–é€Ÿé£Ÿ",
                        storyTitle: "ğŸ•› 12:20 PM - è¦“é£Ÿçš„æˆ°å ´",
                        storyDesc: "çµ‚æ–¼ä¸‹èª²äº†ï¼Œä½†ä¸‹åˆ 1:20 é‚„æœ‰é€šè­˜èª²è¦è¶•ã€‚\n\næ ¡åœ’è£¡åˆ°è™•éƒ½æ˜¯äººï¼Œå°ç¦å‰é¢æ’éšŠæ’åˆ°å¤©è’åœ°è€ã€‚ä½ åªæœ‰ä¸åˆ°ä¸€å°æ™‚çš„æ™‚é–“ï¼Œå¿…é ˆæ±‚å¿«ã€æ±‚é£½ï¼Œé‡é»æ˜¯ä¸èƒ½è®“ä¸‹åˆçš„è‡ªå·±é¤“æ­»æˆ–æƒ³ç¡è¦ºï¼\n\nã€ä»»å‹™ç›®æ¨™ã€‘ é¸æ“‡å¿«é€Ÿå–å¾—çš„ã€Œè¶…å•†ã€æˆ–ã€Œé€Ÿé£Ÿã€è£œå……èƒ½é‡ï¼"
                    },
                    { 
                        name: "æ™šé¤", 
                        tags: [], 
                        hint: "çµ‚æ–¼ä¸‹èª²äº†ï¼å…¬é¤¨ç¾é£Ÿä»»ä½ åƒ",
                        storyTitle: "ğŸ•• 6:30 PM - è‡ªç”±çš„ç©ºæ°£",
                        storyDesc: "æ­å–œä½ ï¼çµ‚æ–¼æ’éäº†å……æ»¿æ‘§æ®˜çš„ä¸€å¤©ã€‚\n\næ­¤åˆ»çš„ä½ èº«å¿ƒä¿±ç–²ï¼Œåªæœ‰å…¬é¤¨å¤œå¸‚çš„ç‡ˆå…‰èƒ½æº«æš–ä½ çš„å¿ƒã€‚é€™æ™‚å€™ä¸ç”¨ç®¡ä»€éº¼æ•ˆç‡äº†ï¼Œæƒ³åƒä»€éº¼å°±åƒä»€éº¼ï¼Œé€™æ˜¯å±¬æ–¼å‹åˆ©è€…çš„æ™šé¤ï¼\n\nã€ä»»å‹™ç›®æ¨™ã€‘ å…¨ç¨®é¡è§£é–ï¼å»ã€Œå…¬é¤¨å•†åœˆã€æˆ–ã€Œé¤å»³ã€å¥½å¥½çŠ’è³è‡ªå·±å§ï¼"
                    }
                ],
                subLevels: [
                    {
                        id: 'story_fat_loss',
                        title: 'ğŸ”¥ ç›®æ¨™ï¼šæ¸›è„‚è¨ˆç•«',
                        desc: 'æ§åˆ¶ç†±é‡ï¼Œä¿æŒé£½è¶³æ„Ÿï¼Œç‡ƒç‡’è„‚è‚ªå§ï¼',
                        objective: 'ç†±é‡<TDEE ä¸” è›‹ç™½è³ªå……è¶³',
                        // åˆ¤å®šå‡½å¼: ç†±é‡ 60%~95% TDEE, è›‹ç™½è³ªæ¯”ä¾‹ > 25%
                        criteria: (stats, tdee) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return stats.calories < tdee * 0.95 && stats.calories > tdee * 0.6 && pRatio > 0.25;
                        },
                        successMsg: "æ¸›è„‚æŒ‘æˆ°æˆåŠŸï¼ç†±é‡æ§åˆ¶å¾—å®œï¼Œè›‹ç™½è³ªä¹Ÿè¶³å¤ ï¼Œæ˜¯å®Œç¾çš„æ¸›è„‚æ—¥ï¼",
                        failMsg: "æ¸›è„‚æŒ‘æˆ°å¤±æ•—ã€‚ç†±é‡å¯èƒ½è¶…æ¨™ï¼Œæˆ–æ˜¯è›‹ç™½è³ªæ”å–ä¸è¶³å°è‡´è‚Œè‚‰æµå¤±å–”ã€‚"
                    },
                    {
                        id: 'story_balanced',
                        title: 'âš–ï¸ ç›®æ¨™ï¼šç‡Ÿé¤Šå‡è¡¡',
                        desc: 'ä¸æ¥µç«¯é£²é£Ÿï¼Œè¿½æ±‚èº«å¿ƒéˆçš„å¹³è¡¡ã€‚',
                        objective: 'ç†±é‡ç¶­æŒ TDEEï¼ŒP/C/F å‡è¡¡',
                        // åˆ¤å®šå‡½å¼: ç†±é‡ 90%~110% TDEE, æ¯”ä¾‹ä¸æ¥µç«¯
                        criteria: (stats, tdee) => {
                             const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                             const fRatio = (stats.totalF * 9) / (stats.calories || 1);
                             const cRatio = (stats.totalC * 4) / (stats.calories || 1);
                             const calOk = stats.calories >= tdee * 0.9 && stats.calories <= tdee * 1.1;
                             const ratioOk = pRatio > 0.15 && pRatio < 0.4 && fRatio > 0.15 && fRatio < 0.45 && cRatio > 0.3 && cRatio < 0.65;
                             return calOk && ratioOk;
                        },
                        successMsg: "å‡è¡¡é£²é£ŸæˆåŠŸï¼ä½ çš„èº«é«”æ„Ÿè¬ä½ ï¼Œç¶­æŒäº†å®Œç¾çš„å¹³è¡¡ç‹€æ…‹ã€‚",
                        failMsg: "æŒ‘æˆ°å¤±æ•—ã€‚å¯èƒ½ç†±é‡å¤ªé«˜/å¤ªä½ï¼Œæˆ–è€…æŸä¸€é …ç‡Ÿé¤Šç´ æ¯”ä¾‹å¤±è¡¡å›‰ã€‚"
                    },
                    {
                        id: 'story_muscle',
                        title: 'ğŸ’ª ç›®æ¨™ï¼šå¢è‚Œç‰¹è¨“',
                        desc: 'ç‚ºäº†è®Šå¾—æ›´å¼·å£¯ï¼éœ€è¦ç†±é‡ç›ˆé¤˜èˆ‡å¤§é‡è›‹ç™½è³ªã€‚',
                        objective: 'ç†±é‡ > TDEE ä¸” é«˜è›‹ç™½',
                        // åˆ¤å®šå‡½å¼: ç†±é‡ 105%~130% TDEE, è›‹ç™½è³ªæ¯”ä¾‹ > 25%
                        criteria: (stats, tdee) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return stats.calories > tdee * 1.05 && stats.calories < tdee * 1.4 && pRatio > 0.25;
                        },
                        successMsg: "å¢è‚ŒæŒ‘æˆ°æˆåŠŸï¼ç†±é‡ç›ˆé¤˜åŠ ä¸Šå……è¶³è›‹ç™½ï¼Œè‚Œè‚‰æ­£åœ¨ç”Ÿé•·ï¼",
                        failMsg: "æŒ‘æˆ°å¤±æ•—ã€‚ç†±é‡ä¸è¶³ä»¥æ”¯æŒè‚Œè‚‰ç”Ÿé•·ï¼Œæˆ–è€…è›‹ç™½è³ªåƒå¤ªå°‘å›‰ã€‚"
                    }
                ]
            }
        };

        const calculatePersona = (totalStats) => {
            if (totalStats.calories === 0) return 'faster';
            const pRatio = (totalStats.totalP * 4) / totalStats.calories;
            const fRatio = (totalStats.totalF * 9) / totalStats.calories;
            const cRatio = (totalStats.totalC * 4) / totalStats.calories;
            
            if (totalStats.calories < 800) return 'faster';
            if (totalStats.calories > 2500 || (totalStats.mood > 85 && totalStats.health < 30)) return 'happy_chubby';
            if (fRatio > 0.45 || totalStats.totalF > 80) return 'oil_king';
            if (pRatio > 0.30) return 'protein_hunter';
            if (cRatio > 0.60) return 'carb_cultist';
            if (pRatio >= 0.2 && pRatio <= 0.4 && fRatio >= 0.2 && fRatio <= 0.4) {
                return 'nutritionist';
            }
            return 'happy_chubby'; 
        };

        const calculateStats = (gender, age, height, weight, activityLevel) => {
            let bmr = 10 * weight + 6.25 * height - 5 * age;
            if (gender === 'male') bmr += 5; else bmr -= 161;
            return Math.round(bmr * activityLevel);
        };

        const getNutritionFeedback = (stats, targetCalories) => {
            const { calories, totalP, totalC, totalF } = stats;
            const advice = [];
            
            if (calories < targetCalories * 0.5) {
                advice.push("âš ï¸ ç†±é‡ï¼šåš´é‡ä¸è¶³ (é€™æ¨£æœƒæ‰è‚Œè‚‰è®Šæ˜“èƒ–é«”è³ªå–”ï¼)");
            } else if (calories < targetCalories * 0.8) {
                advice.push("ğŸ“‰ ç†±é‡ï¼šåä½ (èƒ½é‡ä¸è¶³å®¹æ˜“ç–²å‹ï¼Œä¸‹é¤è£œå›ä¾†)");
            } else if (calories > targetCalories * 1.4) {
                advice.push("ğŸ”¥ ç†±é‡ï¼šåš´é‡è¶…æ¨™ (é€™é¤åƒå¾—å¤ªæ”¾ç¸±å›‰ï¼Œæ³¨æ„é«”è„‚ï¼)");
            } else if (calories > targetCalories * 1.1) {
                advice.push("âš ï¸ ç†±é‡ï¼šç¨å¾®è¶…æ¨™ (å¶çˆ¾æ”¾ç¸±æ²’é—œä¿‚ï¼Œå¤šå–æ°´)");
            } else {
                advice.push("âœ… ç†±é‡ï¼šæ§åˆ¶å®Œç¾ (ç¶­æŒå¾—å¾ˆæ£’ï¼Œè«‹ç¹¼çºŒä¿æŒ)");
            }

            const pRatio = (totalP * 4) / (calories || 1);
            const fRatio = (totalF * 9) / (calories || 1);
            const cRatio = (totalC * 4) / (calories || 1);

            if (pRatio < 0.15) advice.push(`ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ï¼šå¤ªå°‘ (è‚Œè‚‰ä¿®å¾©åŸæ–™ä¸è¶³ï¼Œæ˜“æµå¤±è‚Œè‚‰)`);
            else if (pRatio > 0.4) advice.push(`ğŸ’ª è›‹ç™½è³ªæ¯”ä¾‹ï¼šåé«˜ (æ²’é‡è¨“çš„è©±æœƒè®Šè…è‡Ÿè² æ“”å–”)`);
            else advice.push(`ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ï¼šé©ä¸­ (ä¿®å¾©è‚Œè‚‰å‰›å‰›å¥½)`);

            if (fRatio > 0.45) advice.push(`ğŸ›¢ï¸ æ²¹è„‚æ¯”ä¾‹ï¼šå¤ªé«˜ (è¡€ç®¡åœ¨å°–å«äº†ï¼å°å¿ƒç™¼ç‚)`);
            else if (fRatio < 0.15) advice.push(`ğŸ¥‘ æ²¹è„‚æ¯”ä¾‹ï¼šå¤ªå°‘ (çš®è†šæœƒè®Šä¹¾æ¾€ï¼Œè·çˆ¾è’™éœ€è¦å¥½æ²¹)`);
            else advice.push(`ğŸ¥‘ æ²¹è„‚æ¯”ä¾‹ï¼šé©ä¸­ (å¾ˆæ£’ï¼ç¶­æŒèº«é«”æ©Ÿèƒ½é‹ä½œ)`);

            if (cRatio > 0.65) advice.push(`ğŸš æ¾±ç²‰æ¯”ä¾‹ï¼šéé‡ (è¡€ç³–æ³¢å‹•å¤§ï¼Œä¸‹åˆå®¹æ˜“æƒ³ç¡)`);
            else if (cRatio < 0.3) advice.push(`ğŸ æ¾±ç²‰æ¯”ä¾‹ï¼šä¸è¶³ (å¤§è…¦åæ‡‰æœƒè®Šæ…¢ï¼Œä¹Ÿå®¹æ˜“æ²’åŠ›æ°£)`);
            else advice.push(`ğŸ æ¾±ç²‰æ¯”ä¾‹ï¼šé©ä¸­ (ç²¾ç¥é«”åŠ›ç¶­æŒå¾—å®œ)`);

            return advice;
        };

        const TypewriterText = ({ text, speed = 30, onComplete }) => {
            const [displayedText, setDisplayedText] = useState("");
            const [index, setIndex] = useState(0);
            useEffect(() => {
                if (index < text.length) {
                    const timer = setTimeout(() => { setDisplayedText(prev => prev + text.charAt(index)); setIndex(prev => prev + 1); }, speed);
                    return () => clearTimeout(timer);
                } else if(onComplete) onComplete();
            }, [index, text, speed, onComplete]);
            return <div className="whitespace-pre-line leading-relaxed">{displayedText}<span className="cursor-blink"></span></div>;
        };

        const StoryModal = ({ title, desc, onClose }) => {
            const [isTypingComplete, setIsTypingComplete] = useState(false);
            const handleClick = () => {
                if (!isTypingComplete) { setIsTypingComplete(true); } else { onClose(); }
            };
            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6 fade-in" onClick={handleClick}>
                    <div className="bg-white rounded-xl w-full max-w-md p-8 relative min-h-[300px] flex flex-col cursor-pointer">
                        <h2 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">{title}</h2>
                        <div className="flex-1 text-gray-700 text-lg mb-6 overflow-y-auto">
                            {isTypingComplete ? <div className="whitespace-pre-line leading-relaxed">{desc}</div> : <TypewriterText text={desc} onComplete={() => setIsTypingComplete(true)} />}
                        </div>
                        <div className="text-center text-gray-400 text-xs mt-auto animate-pulse border-t pt-4">{isTypingComplete ? "é»æ“Šä»»æ„è™•é–‹å§‹" : "é»æ“ŠåŠ é€Ÿé¡¯ç¤º..."}</div>
                    </div>
                </div>
            );
        };

        const MacroDistribution = ({ p, c, f, calories }) => {
            if (calories === 0) return null;
            const pPct = Math.round((p * 4 / calories) * 100);
            const cPct = Math.round((c * 4 / calories) * 100);
            const fPct = Math.round((f * 9 / calories) * 100);
            
            return (
                <div className="w-full mt-4">
                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                        <span>ç†±é‡åˆ†ä½ˆ</span>
                        <span>{calories} kcal</span>
                    </div>
                    <div className="h-4 w-full flex rounded-full overflow-hidden bg-gray-800">
                        <div style={{ width: `${pPct}%` }} className="bg-red-500" title={`è›‹ç™½è³ª ${pPct}%`}></div>
                        <div style={{ width: `${cPct}%` }} className="bg-yellow-500" title={`ç¢³æ°´ ${cPct}%`}></div>
                        <div style={{ width: `${fPct}%` }} className="bg-blue-500" title={`è„‚è‚ª ${fPct}%`}></div>
                    </div>
                    <div className="flex gap-4 mt-1 text-[10px] justify-center text-gray-400">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div>P {pPct}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-yellow-500"></div>C {cPct}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div>F {fPct}%</div>
                    </div>
                </div>
            );
        };

        const NutritionRatioBar = ({ p, c, f, calories }) => {
            if (!calories || calories === 0) return <div className="h-6"></div>; 

            const calFromP = p * 4;
            const calFromC = c * 4;
            const calFromF = f * 9;
            const totalCalCalc = calFromP + calFromC + calFromF;
            
            const pPct = totalCalCalc > 0 ? (calFromP / totalCalCalc) * 100 : 0;
            const cPct = totalCalCalc > 0 ? (calFromC / totalCalCalc) * 100 : 0;
            const fPct = totalCalCalc > 0 ? (calFromF / totalCalCalc) * 100 : 0;

            return (
                <div className="w-full px-4 mb-2">
                    <div className="flex justify-between text-xs text-gray-500 font-bold mb-1">
                        <span>ç‡Ÿé¤Šæ¯”ä¾‹</span>
                        <span className="font-mono">{Math.round(calories)} kcal</span>
                    </div>
                    <div className="h-3 w-full flex rounded-full overflow-hidden bg-gray-200 shadow-inner">
                        <div style={{ width: `${pPct}%` }} className="bg-red-500 transition-all duration-300"></div>
                        <div style={{ width: `${cPct}%` }} className="bg-yellow-500 transition-all duration-300"></div>
                        <div style={{ width: `${fPct}%` }} className="bg-blue-500 transition-all duration-300"></div>
                    </div>
                    <div className="flex justify-between text-[10px] font-mono mt-1 text-gray-400">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div>P {Math.round(pPct)}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-yellow-500"></div>C {Math.round(cPct)}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div>F {Math.round(fPct)}%</div>
                    </div>
                </div>
            );
        };

        const CurrentPlateAdvice = ({ tray }) => {
            if (tray.length === 0) return <div className="text-center text-gray-400 text-xs mt-2 h-6 flex items-center justify-center">è«‹é¸æ“‡é£Ÿç‰©æ”¾å…¥é¤ç›¤</div>;

            const totalCalories = tray.reduce((acc, f) => acc + (f.calories || 0), 0);
            const totalF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
            const totalC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
            const totalP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
            
            const fRatio = (totalF * 9) / (totalCalories || 1);
            const cRatio = (totalC * 4) / (totalCalories || 1);
            
            const warnings = [];
            
            if (fRatio > 0.45 && totalF > 12) warnings.push("ğŸ›¢ï¸æ²¹è„‚æ¯”ä¾‹åé«˜");
            if (cRatio > 0.65 && totalC > 30) warnings.push("ğŸšæ¾±ç²‰æ¯”ä¾‹éé‡");
            if (totalCalories > 800) warnings.push("ğŸ”¥ç†±é‡åé«˜");

            let displayContent = "";
            let colorClass = "text-gray-500";

            if (warnings.length > 0) {
                displayContent = warnings.join(" â€§ ");
                colorClass = "text-red-500 font-bold animate-pulse";
            } else {
                if (tray.length === 1 && totalCalories < 300) {
                    displayContent = "ğŸ’¡ å¤ªå–®èª¿å›‰ï¼Œå†å¤šé¸å¹¾æ¨£ä¸ä¸€æ¨£çš„ï¼";
                    colorClass = "text-blue-500";
                } else if (totalP > 25 && fRatio < 0.3) { 
                    displayContent = "ğŸ’ª å„ªè³ªè›‹ç™½ï¼å¾ˆæ£’çš„é¸æ“‡ï¼";
                    colorClass = "text-green-600 font-bold";
                } else {
                    displayContent = "âœ… ç‡Ÿé¤Šæ¯”ä¾‹é‚„ä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒ";
                    colorClass = "text-gray-500";
                }
            }

            return <div className={`text-center text-xs mt-2 h-6 flex items-center justify-center ${colorClass} transition-all duration-300`}>{displayContent}</div>;
        };

        const FoodCard = ({ food, onClick, onInfo }) => {
            const getTags = () => {
                const t = [];
                const cal = food.calories;
                if (!cal) return t;
                const pRatio = (food.p * 4) / cal;
                const cRatio = (food.c * 4) / cal;
                const fRatio = (food.f * 9) / cal;
                if (pRatio > 0.2 && cRatio > 0.4 && food.health < 10) t.push({ text: "âš ï¸é«˜ç³–é™·é˜±", color: "text-white bg-red-500 border-red-600 font-bold" });
                if (fRatio >= 0.45 && food.f > 10) t.push({ text: "è¶…æ²¹è†©", color: "text-purple-700 bg-purple-100 border-purple-200" });
                else if (fRatio >= 0.35 && food.f > 10) t.push({ text: "æ²¹è†©", color: "text-blue-700 bg-blue-100 border-blue-200" });
                if (pRatio >= 0.30) t.push({ text: "é«˜è›‹ç™½", color: "text-red-700 bg-red-100 border-red-200" });
                else if (pRatio >= 0.20) t.push({ text: "è›‹ç™½", color: "text-red-600 bg-red-50 border-red-100" });
                if (cRatio >= 0.60) t.push({ text: "é«˜ç¢³æ°´", color: "text-yellow-700 bg-yellow-100 border-yellow-200" });
                if (food.health >= 15) t.push({ text: "å¥åº·", color: "text-green-700 bg-green-100 border-green-200" });
                if (food.mood >= 25) t.push({ text: "å¿«æ¨‚", color: "text-pink-700 bg-pink-100 border-pink-200" });
                if (cRatio < 0.2 && fRatio < 0.2) t.push({ text: "æ¸…æ·¡", color: "text-gray-600 bg-gray-100 border-gray-200" });
                return t.slice(0, 2); 
            };
            const tags = getTags();

            return (
                <button 
                    onClick={() => onClick(food)}
                    className="relative flex flex-col p-2 rounded-xl bg-white border-2 border-slate-100 hover:border-yellow-400 hover:shadow-lg transition-all active:scale-95 group text-left h-full shadow-sm overflow-hidden"
                >
                    <div 
                        onClick={(e) => { e.stopPropagation(); onInfo(food); }}
                        className="absolute top-2 left-2 z-20 w-7 h-7 bg-white hover:bg-blue-50 border border-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:text-blue-500 shadow-sm transition-colors"
                    >
                        <Icons.Info />
                    </div>
                    <div className="absolute top-2 right-2 z-10">
                        <span className="text-[10px] text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded-full border border-gray-200">{food.calories} kcal</span>
                    </div>
                    <div className="w-full flex justify-center mt-8 mb-2">
                        <span className="text-4xl group-hover:scale-110 transition-transform filter drop-shadow-sm">{food.emoji}</span>
                    </div>
                    <span className="text-sm text-gray-800 font-bold w-full line-clamp-2 mb-1 leading-tight h-10 flex items-center justify-center text-center px-1">{food.name}</span>
                    <div className="flex flex-wrap gap-1 mb-2 h-5 content-center justify-center w-full">
                        {tags.map((tag, i) => (
                            <span key={i} className={`text-[9px] px-1.5 py-0.5 rounded border font-medium ${tag.color}`}>
                                {tag.text}
                            </span>
                        ))}
                    </div>
                    <div className="w-full grid grid-cols-3 gap-1 text-[9px] font-mono text-gray-500 mt-auto bg-slate-50 p-1 rounded text-center">
                        <div className="text-red-500 font-bold">P:{Math.round(food.p)}</div>
                        <div className="text-yellow-600 font-bold">C:{Math.round(food.c)}</div>
                        <div className="text-blue-500 font-bold">F:{Math.round(food.f)}</div>
                    </div>
                </button>
            );
        };

        const RoundPlate = ({ tray, onRemove }) => {
            const slots = [0, 1, 2, 3, 4, 5]; 
            const totalP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
            const totalC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
            const totalF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
            const totalCalories = tray.reduce((acc, f) => acc + (f.calories || 0), 0);

            return (
                <div className="flex flex-col items-center mb-2">
                    <div className="plate-container">
                        <div className="absolute inset-0 border-4 border-dashed border-gray-200 rounded-full opacity-50 m-2"></div>
                        
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center bg-white/95 rounded-full w-24 h-24 shadow-md z-0 pointer-events-none border border-gray-100 p-1">
                            <span className="text-[10px] text-gray-400 mb-0.5 font-bold">æœ¬é¤çµ±è¨ˆ</span>
                            <div className="flex items-center gap-1 text-xs font-mono mb-1">
                                <span className="text-gray-700 font-bold">{Math.round(totalCalories)}</span> 
                                <span className="text-[8px] text-gray-400">kcal</span>
                            </div>
                            <div className="w-full px-2 space-y-0.5">
                                <div className="flex justify-between text-[8px] text-red-500 font-bold"><span>P</span><span>{Math.round(totalP)}g</span></div>
                                <div className="flex justify-between text-[8px] text-yellow-500 font-bold"><span>C</span><span>{Math.round(totalC)}g</span></div>
                                <div className="flex justify-between text-[8px] text-blue-500 font-bold"><span>F</span><span>{Math.round(totalF)}g</span></div>
                            </div>
                        </div>

                        {slots.map((slotIndex) => {
                            const food = tray[slotIndex];
                            return (
                                <div 
                                    key={slotIndex} 
                                    className={`plate-slot slot-${slotIndex} cursor-pointer hover:bg-black/5 rounded-full z-10`}
                                    onClick={() => food && onRemove(slotIndex)}
                                >
                                    {food ? (
                                        <div className="flex flex-col items-center pop-in relative group">
                                            <span className="text-4xl drop-shadow-lg filter transition-transform transform group-hover:scale-105 duration-200">{food.emoji}</span>
                                            {/* X ç–ŠåŠ å±¤ */}
                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-white/60 backdrop-blur-[1px] rounded-full duration-200">
                                                <div className="text-red-500 w-8 h-8 drop-shadow-md">
                                                    <Icons.X />
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="w-10 h-10 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center opacity-40 hover:opacity-80 transition-opacity hover:scale-110 hover:border-yellow-400">
                                            <span className="text-lg text-gray-300">+</span>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onComplete }) => {
            const [gender, setGender] = useState('male');
            const [age, setAge] = useState(20);
            const [height, setHeight] = useState(170);
            const [weight, setWeight] = useState(65);
            const [activityLevel, setActivityLevel] = useState(1.375);
            const [error, setError] = useState(""); 
            const activityOptions = [
                { value: 1.2, label: "ä¹…å", desc: "å¹¾ä¹ä¸é‹å‹•" },
                { value: 1.375, label: "è¼•åº¦", desc: "æ¯é€±é‹å‹• 1-3 å¤©" },
                { value: 1.55, label: "ä¸­åº¦", desc: "æ¯é€±é‹å‹• 3-5 å¤©" },
                { value: 1.725, label: "é«˜åº¦", desc: "æ¯é€±é‹å‹• 6-7 å¤©" },
                { value: 1.9, label: "è¶…ç´š", desc: "æ¯å¤©å…©ç·´/å‹åŠ›å·¥ä½œ" },
            ];
            const handleSubmit = (e) => {
                e.preventDefault();
                if (age < 10 || age > 100) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„å¹´é½¡ (10 - 100æ­²)"); return; }
                if (height < 50 || height > 250) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„èº«é«˜ (50 - 250å…¬åˆ†)"); return; }
                if (weight < 20 || weight > 300) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„é«”é‡ (20 - 300å…¬æ–¤)"); return; }
                setError(""); 
                const tdee = calculateStats(gender, age, height, weight, activityLevel);
                const proteinTarget = Math.round(weight * 2.0);
                onComplete({ isCustom: true, gender, age, height, weight, tdee, proteinTarget });
            };
            const handleSkip = () => { onComplete({ isCustom: false, gender: 'male', age: 20, height: 170, weight: 65, tdee: 2000, proteinTarget: 130 }); };
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-yellow-50 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border-2 border-yellow-200 overflow-y-auto max-h-screen">
                        <div className="text-center mb-4"><div className="text-5xl mb-2">ğŸ“‹</div><h1 className="text-2xl font-bold text-gray-800">å…¥å­¸å¥åº·æª¢æŸ¥</h1><p className="text-sm text-gray-500 mt-1">è¼¸å…¥è³‡æ–™ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è¨ˆç®— TDEE èˆ‡ç‡Ÿé¤Šç›®æ¨™ã€‚</p></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {error && <div className="bg-red-50 text-red-500 text-xs p-2 rounded text-center font-bold animate-pulse">{error}</div>}
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">ç”Ÿç†æ€§åˆ¥</label><div className="flex gap-2"><button type="button" onClick={() => setGender('male')} className={`flex-1 py-2 rounded-lg border ${gender === 'male' ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>ç”·</button><button type="button" onClick={() => setGender('female')} className={`flex-1 py-2 rounded-lg border ${gender === 'female' ? 'bg-pink-100 border-pink-400 text-pink-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>å¥³</button></div></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-700 mb-1">å¹´é½¡ (æ­²)</label><input type="number" value={age} onChange={(e) => setAge(Number(e.target.value))} className="w-full p-2 border border-gray-300 rounded-lg text-center" /></div><div><label className="block text-xs font-bold text-gray-700 mb-1">é«”é‡ (kg)</label><input type="number" value={weight} onChange={(e) => setWeight(Number(e.target.value))} className="w-full p-2 border border-gray-300 rounded-lg text-center" /></div></div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">èº«é«˜ (cm)</label><input type="number" value={height} onChange={(e) => setHeight(Number(e.target.value))} className="w-full p-2 border border-gray-300 rounded-lg text-center" /></div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">æ¯é€±é‹å‹•é‡</label><div className="grid grid-cols-1 gap-1">{activityOptions.map((opt) => (<button key={opt.value} type="button" onClick={() => setActivityLevel(opt.value)} className={`py-2 px-3 rounded-lg border text-left flex justify-between items-center ${activityLevel === opt.value ? 'bg-yellow-100 border-yellow-400 text-yellow-800' : 'bg-white border-gray-200 text-gray-600'}`}><span className="font-bold text-sm">{opt.label}</span><span className="text-xs opacity-70">{opt.desc}</span></button>))}</div></div>
                            <button type="submit" className="w-full bg-yellow-400 text-black font-bold py-3 rounded-xl hover:bg-yellow-300 transition-colors shadow-md mt-4">é–‹å§‹ç”Ÿæˆåˆ†æå ±å‘Š</button>
                        </form>
                        <button onClick={handleSkip} className="w-full mt-3 text-gray-400 text-xs hover:text-gray-600 underline">ç•¥éï¼Œä½¿ç”¨é è¨­å€¼ (è·¯äººç”²)</button>
                    </div>
                </div>
            );
        };

        const AnalysisResult = ({ profile, onConfirm, onBack }) => {
            const dailyC = Math.round((profile.tdee * 0.5) / 4);
            const dailyP = Math.round((profile.tdee * 0.3) / 4);
            const dailyF = Math.round((profile.tdee * 0.2) / 9);
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden pop-in border-4 border-slate-800">
                        <div className="bg-slate-800 text-white p-4 text-center"><h2 className="text-xl font-bold">èº«é«”ç´ è³ªåˆ†æå ±å‘Š</h2><p className="text-xs text-slate-400">PERSONAL NUTRITION REPORT</p></div>
                        <div className="p-6 space-y-6">
                            <div className="text-center"><p className="text-sm text-gray-500 font-bold mb-1">æ‚¨çš„æ¯æ—¥ç¸½æ¶ˆè€—ç†±é‡ (TDEE)</p><div className="text-5xl font-black text-yellow-500 tracking-tighter">{profile.tdee} <span className="text-base font-normal text-gray-400">kcal</span></div><div className="text-xs text-gray-400 mt-1 bg-yellow-50 inline-block px-2 py-1 rounded">æ³¨æ„ï¼šéŠæˆ²ä¸­å–®é¤è¶…é {(profile.tdee * 0.5).toFixed(0)} kcal å³è¦–ç‚ºæš´é£Ÿ</div></div><hr className="border-gray-100"/>
                            <div><p className="text-xs text-gray-500 font-bold mb-3 text-center">å»ºè­°æ¯æ—¥æ”å–é‡ (C50/P30/F20)</p><div className="grid grid-cols-3 gap-3 text-center"><div className="bg-yellow-50 p-2 rounded-xl border border-yellow-100"><div className="text-xl font-bold text-yellow-600">{dailyC}g</div><div className="text-[10px] text-gray-500">ç¢³æ°´ 50%</div></div><div className="bg-red-50 p-2 rounded-xl border border-red-100"><div className="text-xl font-bold text-red-500">{dailyP}g</div><div className="text-[10px] text-gray-500">è›‹ç™½è³ª 30%</div></div><div className="bg-blue-50 p-2 rounded-xl border border-blue-100"><div className="text-xl font-bold text-blue-500">{dailyF}g</div><div className="text-[10px] text-gray-500">è„‚è‚ª 20%</div></div></div></div>
                            <div className="text-xs text-gray-400 text-center leading-relaxed">*é€™äº›æ•¸å€¼å°‡ç›´æ¥å½±éŸ¿éŠæˆ²é›£åº¦ã€‚<br/>è«‹åœ¨ã€Œäº«å—ç¾é£Ÿã€èˆ‡ã€Œç¶­æŒæ•¸å€¼ã€é–“å–å¾—å¹³è¡¡ï¼</div>
                            <div className="flex gap-3"><button onClick={onBack} className="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">è¿”å›ä¿®æ”¹</button><button onClick={onConfirm} className="flex-[2] bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-700 transition-colors shadow-lg flex items-center justify-center gap-2"><span>é€²å…¥éŠæˆ²</span><div className="w-4 h-4"><Icons.ArrowRight /></div></button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const FoodInfoModal = ({ food, onClose }) => {
            if (!food) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative" onClick={e=>e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><div className="w-6 h-6"><Icons.X/></div></button>
                        <div className="text-center">
                            <div className="text-6xl mb-4">{food.emoji}</div>
                            <h3 className="text-2xl font-bold mb-2">{food.name}</h3>
                            <div className="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-mono mb-4">{food.calories} kcal</div>
                            <p className="text-gray-600 text-sm leading-relaxed mb-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100 text-left">{food.desc || "æš«ç„¡æè¿°"}</p>
                            <div className="grid grid-cols-3 gap-3 text-sm font-mono">
                                <div className="bg-red-50 p-3 rounded-xl"><div className="text-red-500 font-bold text-xl">{food.p}g</div><div className="text-[10px] text-gray-500">è›‹ç™½è³ª</div></div>
                                <div className="bg-yellow-50 p-3 rounded-xl"><div className="text-yellow-600 font-bold text-xl">{food.c}g</div><div className="text-[10px] text-gray-500">ç¢³æ°´</div></div>
                                <div className="bg-blue-50 p-3 rounded-xl"><div className="text-blue-500 font-bold text-xl">{food.f}g</div><div className="text-[10px] text-gray-500">è„‚è‚ª</div></div>
                            </div>
                        </div>
                        <button onClick={onClose} className="w-full bg-gray-100 text-gray-600 py-3 font-bold hover:bg-gray-200 transition-colors">é—œé–‰</button>
                    </div>
                </div>
            );
        };

        const TutorialFeedbackModal = ({ feedback, onClose, onRetry, onNext, onBack }) => {
            if (!feedback) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative text-center" onClick={e=>e.stopPropagation()}>
                        <div className="text-6xl mb-4">{feedback.isCorrect ? 'ğŸ‰' : 'âŒ'}</div>
                        <h3 className={`text-2xl font-bold mb-2 ${feedback.isCorrect ? 'text-green-600' : 'text-red-600'}`}>{feedback.title}</h3>
                        <p className="text-gray-600 mb-6">{feedback.desc}</p>
                        <div className="space-y-3">
                            {feedback.isCorrect ? (
                                <button onClick={onNext} className="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-600 transition-transform active:scale-95">å®ŒæˆæŒ‘æˆ°</button>
                            ) : (
                                <button onClick={onRetry} className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold hover:bg-red-200 transition-colors">æ¸…ç©ºé‡è©¦</button>
                            )}
                            <button onClick={onBack} className="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">è¿”å›é—œå¡åˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const PersonaDetailModal = ({ persona, onClose }) => {
            if (!persona) return null;
            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-sm p-8 relative text-center" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><div className="w-6 h-6"><Icons.X /></div></button>
                        
                        <div className="mb-6 flex justify-center">
                            {persona.image && persona.image.length > 0 ? (
                                <img src={persona.image} alt={persona.name} className="w-48 h-48 object-contain drop-shadow-2xl unlock-animation" />
                            ) : (
                                <div className="text-8xl animate-bounce">{persona.emoji}</div>
                            )}
                        </div>

                        <h3 className={`text-3xl font-bold mb-4 ${persona.color.split(' ')[1]}`}>{persona.name}</h3>
                        <div className={`p-4 rounded-xl mb-6 ${persona.color.split(' ')[0]} bg-opacity-30`}>
                            <p className="text-gray-700 text-lg leading-relaxed">{persona.desc}</p>
                        </div>
                        <div className="text-xs text-gray-400 uppercase tracking-widest">Dietary Persona</div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState("ONBOARDING"); 
            const [userProfile, setUserProfile] = useState(null);
            const [currentStage, setCurrentStage] = useState(null);
            const [currentSubLevel, setCurrentSubLevel] = useState(null); 
            const [storyMealIndex, setStoryMealIndex] = useState(0); 
            const [dailyStats, setDailyStats] = useState({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
            const [unlockedPersonas, setUnlockedPersonas] = useState([]); 
            const [tray, setTray] = useState([]);
            const [selectedFoodInfo, setSelectedFoodInfo] = useState(null);
            const [tutorialFeedback, setTutorialFeedback] = useState(null); 
            const [selectedPersona, setSelectedPersona] = useState(null); 
            const [storyModalOpen, setStoryModalOpen] = useState(false);

            const addFood = (food) => {
                if (tray.length < 6) {
                    setTray([...tray, food]);
                }
            };
            
            const removeFromTray = (index) => {
                const newTray = [...tray];
                newTray.splice(index, 1);
                setTray(newTray);
            };

            const unlockPersona = (personaId) => {
                if (!unlockedPersonas.includes(personaId)) {
                    setUnlockedPersonas([...unlockedPersonas, personaId]);
                }
            };

            const startLevel = (stageKey) => {
                const stage = stages[stageKey];
                setCurrentStage(stage);
                setTray([]);
                setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
                
                if (stage.type === 'tutorial_menu') {
                    setGameState("TUTORIAL_MENU");
                } else if (stage.type === 'meal') {
                    setGameState("WARMUP_PLAY");
                } else if (stage.type === 'story_menu') { // ä¿®æ­£ç‚º story_menu
                     setGameState("STORY_MENU");
                } else if (stage.type === 'story') {
                    setStoryMealIndex(0);
                    setGameState("STORY_PLAY");
                    setStoryModalOpen(true);
                }
            };

            const startSubLevel = (subLevel) => {
                setCurrentSubLevel(subLevel);
                setTray([]);
                
                if (currentStage.id === 'TUTORIAL') {
                    setGameState("TUTORIAL_PLAY");
                } else if (currentStage.id === 'STORY') {
                    setStoryMealIndex(0);
                    setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 }); // Reset
                    setGameState("STORY_PLAY");
                    setStoryModalOpen(true);
                }
            };

            const confirmMeal = () => {
                if (tray.length === 0) return;

                const mP = tray.reduce((a, f) => a + f.p, 0); const mC = tray.reduce((a, f) => a + f.c, 0); const mF = tray.reduce((a, f) => a + f.f, 0); const mCal = tray.reduce((a, f) => a + f.calories, 0);
                const currentStats = { calories: mCal, totalP: mP, totalC: mC, totalF: mF };

                if (gameState === "TUTORIAL_PLAY") {
                    if (currentSubLevel && currentSubLevel.criteria(currentStats)) {
                        setTutorialFeedback({ isCorrect: true, title: "æŒ‘æˆ°æˆåŠŸï¼", desc: currentSubLevel.successMsg });
                    } else {
                        setTutorialFeedback({ isCorrect: false, title: "æŒ‘æˆ°å¤±æ•—", desc: currentSubLevel.failMsg });
                    }
                    return; 
                }

                const mHealth = tray.reduce((a, f) => a + f.health, 0); const mMood = tray.reduce((a, f) => a + f.mood, 0);
                const newStats = { ...dailyStats, calories: dailyStats.calories + mCal, totalP: dailyStats.totalP + mP, totalC: dailyStats.totalC + mC, totalF: dailyStats.totalF + mF, health: Math.min(100, Math.max(0, dailyStats.health + mHealth)), mood: Math.min(100, Math.max(0, dailyStats.mood + mMood)) };
                
                setDailyStats(newStats); setTray([]);
                if (gameState === "WARMUP_PLAY") { setGameState("WARMUP_RESULT"); } 
                else if (gameState === "STORY_PLAY") { 
                    if (storyMealIndex < 2) { 
                        setStoryMealIndex(storyMealIndex + 1); 
                        setStoryModalOpen(true);
                    } else { 
                        const personaId = calculatePersona(newStats); 
                        unlockPersona(personaId); 
                        setGameState("RESULT"); 
                    } 
                }
            };

            const handleOnboardingComplete = (profile) => { setUserProfile(profile); setGameState("ANALYSIS"); };

            if (gameState === "ONBOARDING") { return <Onboarding onComplete={handleOnboardingComplete} />; }
            if (gameState === "ANALYSIS") { return <AnalysisResult profile={userProfile} onConfirm={() => setGameState("STAGES")} onBack={() => setGameState("ONBOARDING")} />; }

            if (gameState === "MENU" || gameState === "STAGES") {
                return (
                    <div className="min-h-screen p-6 bg-yellow-50 flex flex-col items-center justify-center fade-in relative">
                        <div className="absolute top-0 left-0 w-full p-4 flex justify-between items-center">
                            <button onClick={() => setGameState("ONBOARDING")} className="bg-gray-200/80 backdrop-blur px-3 py-2 rounded-lg text-xs font-bold text-gray-600 shadow-sm hover:bg-white flex items-center gap-2"><div className="w-4 h-4"><Icons.Refresh /></div> é‡æ¸¬</button>
                            <button onClick={() => setGameState("GALLERY")} className="bg-gray-200/80 backdrop-blur px-3 py-2 rounded-lg text-gray-700 shadow-sm hover:bg-yellow-100 hover:text-yellow-700 transition-colors flex items-center gap-2"><div className="w-5 h-5"><Icons.Book /></div><span className="text-xs font-bold">åœ–é‘‘</span></button>
                        </div>
                        <h1 className="text-4xl font-bold mb-2 text-gray-800">å°å¤§åƒè²¨ç”Ÿå­˜æˆ°</h1>
                        <p className="text-gray-500 mb-8">ä½ èƒ½æ´»éæœŸæœ«è€ƒå—ï¼Ÿ</p>
                        <div className="space-y-4 w-full max-w-sm">
                            <button onClick={() => startLevel('TUTORIAL')} className="w-full bg-white p-4 rounded-xl shadow border-l-4 border-blue-400 text-left hover:shadow-lg transition transform hover:-translate-y-1"><div className="font-bold text-lg">ğŸ”° Stage 0ï¼šç‡Ÿé¤Šæ–°æ‰‹æ‘</div><div className="text-sm text-gray-500">å¯¦æˆ°æ¼”ç·´ï¼šæ‰¾å‡ºé«˜è›‹ç™½</div></button>
                            <button onClick={() => startLevel('WARMUP')} className="w-full bg-white p-4 rounded-xl shadow border-l-4 border-green-400 text-left hover:shadow-lg transition transform hover:-translate-y-1"><div className="font-bold text-lg">âš”ï¸ Stage 1ï¼šè‡ªç”±é£Ÿç¿’</div><div className="text-sm text-gray-500">ç·´ç¿’åƒä¸€é¤ (ç„¡é™åˆ¶)</div></button>
                            <button onClick={() => startLevel('STORY')} className="w-full bg-white p-4 rounded-xl shadow border-l-4 border-purple-400 text-left hover:shadow-lg transition transform hover:-translate-y-1"><div className="font-bold text-lg">ğŸ† Stage 2ï¼šä¸€æ—¥ç”Ÿå­˜æˆ°</div><div className="text-sm text-gray-500">æŒ‘æˆ°ä¸€æ—¥ä¸‰é¤ä»»å‹™ï¼Œè§£é–äººæ ¼ï¼</div></button>
                        </div>
                    </div>
                );
            }

            if (gameState === "TUTORIAL_MENU") {
                return (
                    <div className="min-h-screen p-6 bg-blue-50 flex flex-col items-center justify-center text-center fade-in">
                        <div className="w-full max-w-sm">
                            <h2 className="text-3xl font-bold mb-6 text-blue-900">ğŸ”° ç‡Ÿé¤Šæ–°æ‰‹æ‘</h2>
                            <div className="space-y-4">
                                {stages.TUTORIAL.subLevels.map(level => (
                                    <button 
                                        key={level.id}
                                        onClick={() => startSubLevel(level)}
                                        className="w-full bg-white p-6 rounded-xl shadow-md border-2 border-blue-100 hover:border-blue-400 text-left hover:shadow-lg transition-all group"
                                    >
                                        <div className="font-bold text-xl text-gray-800 mb-1 group-hover:text-blue-600">{level.title}</div>
                                        <div className="text-sm text-gray-500 mb-2">{level.desc}</div>
                                        <div className="text-xs font-mono bg-blue-50 text-blue-600 inline-block px-2 py-1 rounded">ğŸ¯ {level.objective}</div>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setGameState("STAGES")} className="mt-8 text-gray-400 hover:text-gray-600 text-sm font-bold">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            }

            if (gameState === "STORY_MENU") {
                return (
                    <div className="min-h-screen p-6 bg-purple-50 flex flex-col items-center justify-center text-center fade-in">
                        <div className="w-full max-w-sm">
                            <h2 className="text-3xl font-bold mb-6 text-purple-900">ğŸ† ä¸€æ—¥ç”Ÿå­˜æˆ°</h2>
                            <p className="text-gray-600 mb-6 text-sm">è«‹é¸æ“‡ä»Šå¤©çš„é£²é£Ÿç›®æ¨™ï¼š</p>
                            <div className="space-y-4">
                                {stages.STORY.subLevels.map(level => (
                                    <button 
                                        key={level.id}
                                        onClick={() => startSubLevel(level)}
                                        className="w-full bg-white p-6 rounded-xl shadow-md border-2 border-purple-100 hover:border-purple-400 text-left hover:shadow-lg transition-all group"
                                    >
                                        <div className="font-bold text-xl text-gray-800 mb-1 group-hover:text-purple-600">{level.title}</div>
                                        <div className="text-sm text-gray-500 mb-2">{level.desc}</div>
                                        <div className="text-xs font-mono bg-purple-50 text-purple-600 inline-block px-2 py-1 rounded">ğŸ¯ {level.objective}</div>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setGameState("STAGES")} className="mt-8 text-gray-400 hover:text-gray-600 text-sm font-bold">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            }

            if (["TUTORIAL_PLAY", "WARMUP_PLAY", "STORY_PLAY"].includes(gameState)) {
                let title = "";
                let hint = "";
                let storyInfo = null;

                if (gameState === "TUTORIAL_PLAY") { 
                    title = currentSubLevel.title; 
                    hint = currentSubLevel.hint; 
                } 
                else if (gameState === "WARMUP_PLAY") { title = "è‡ªç”±é£Ÿç¿’"; hint = currentStage.hint; } 
                else { 
                    const meal = currentStage.meals[storyMealIndex]; 
                    title = `Day 1 - ${meal.name}`; 
                    hint = meal.hint;
                    storyInfo = { title: meal.storyTitle, desc: meal.storyDesc };
                }
                
                let visibleFoods = foodDatabase;
                if (gameState === "STORY_PLAY") {
                    const meal = currentStage.meals[storyMealIndex];
                    if (meal.tags && meal.tags.length > 0) {
                        visibleFoods = foodDatabase.filter(f => f.tags.some(t => meal.tags.includes(t)));
                    }
                }

                const trayP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
                const trayC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
                const trayF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
                const trayCal = tray.reduce((acc, f) => acc + (f.calories || 0), 0);

                const handleBack = () => {
                    if (gameState === "TUTORIAL_PLAY") setGameState("TUTORIAL_MENU");
                    else if (gameState === "STORY_PLAY") setGameState("STORY_MENU");
                    else setGameState("STAGES");
                };

                return (
                    <div className="h-screen bg-slate-50 flex flex-col relative fade-in overflow-hidden">
                        <div className="bg-white shadow-md z-20 flex-shrink-0 flex flex-col items-center pb-2">
                            <div className="w-full p-2 flex justify-between items-center border-b">
                                <button onClick={handleBack} className="text-gray-400"><div className="w-6 h-6"><Icons.X /></div></button>
                                <h2 className="font-bold text-gray-800 line-clamp-1">{title}</h2>
                                <div className="w-6"></div>
                            </div>
                            
                            {/* æ¯”ä¾‹æ¢ç§»è‡³ä¸Šæ–¹ (æ‰€æœ‰é—œå¡é€šç”¨) */}
                            <div className="w-full mt-2">
                                <NutritionRatioBar p={trayP} c={trayC} f={trayF} calories={trayCal} />
                            </div>

                            <div className="bg-yellow-50 text-yellow-800 text-xs px-3 py-1 rounded-full my-1 font-bold">ğŸ’¡ {hint}</div>
                            
                            <div className="transform scale-90 -my-2">
                                <RoundPlate tray={tray} onRemove={removeFromTray} />
                            </div>

                            <CurrentPlateAdvice tray={tray} />

                            <button onClick={confirmMeal} disabled={tray.length === 0} className={`w-11/12 py-2 rounded-xl font-bold shadow-md text-sm ${tray.length > 0 ? 'bg-yellow-400 text-black' : 'bg-gray-200 text-gray-400'}`}>
                                {gameState === "STORY_PLAY" && storyMealIndex < 2 ? "ä¸‹ä¸€é¤" : "å®Œé£Ÿçµç®—"}
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50">
                            <h3 className="font-bold text-gray-500 mb-2 text-sm">é¸æ“‡é£Ÿç‰©</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 pb-8">
                                {visibleFoods.map(food => (
                                    <FoodCard key={food.id} food={food} onClick={() => addFood(food)} onInfo={setSelectedFoodInfo} />
                                ))}
                            </div>
                            <div className="h-4"></div>
                        </div>

                        <FoodInfoModal food={selectedFoodInfo} onClose={() => setSelectedFoodInfo(null)} />
                        
                        {gameState === "TUTORIAL_PLAY" && (
                            <TutorialFeedbackModal 
                                feedback={tutorialFeedback} 
                                onClose={() => setTutorialFeedback(null)} 
                                onRetry={() => { setTutorialFeedback(null); setTray([]); }} 
                                onNext={() => { setTutorialFeedback(null); setGameState("TUTORIAL_MENU"); }} 
                                onBack={() => { setTutorialFeedback(null); setGameState("TUTORIAL_MENU"); }} 
                            />
                        )}
                        
                        {gameState === "STORY_PLAY" && storyModalOpen && storyInfo && (
                            <StoryModal 
                                title={storyInfo.title} 
                                desc={storyInfo.desc} 
                                onClose={() => setStoryModalOpen(false)} 
                            />
                        )}
                    </div>
                );
            }

            if (gameState === "WARMUP_RESULT") {
                const userTDEE = userProfile?.tdee || 2000;
                const mealTarget = Math.round(userTDEE / 3); 
                const advices = getNutritionFeedback(dailyStats, mealTarget);

                return (
                    <div className="min-h-screen p-6 bg-slate-900 text-white flex flex-col items-center justify-center text-center fade-in overflow-y-auto">
                        <div className="text-6xl mb-4">ğŸ½ï¸</div>
                        <h2 className="text-2xl font-bold mb-2">æœ¬é¤çµç®—</h2>
                        
                        <div className="bg-blue-900/50 p-4 rounded-xl w-full max-w-sm mb-6 border border-blue-700/50 text-left">
                            <h3 className="text-xs text-blue-300 mb-2 uppercase font-bold tracking-wider">ğŸ‘©â€âš•ï¸ ç‡Ÿé¤Šå¸«çš„æœ¬é¤é»è©•</h3>
                            <ul className="text-sm space-y-2">
                                {advices.map((advice, idx) => (
                                    <li key={idx} className="flex gap-2">
                                        <span>â€¢</span>
                                        <span>{advice}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="bg-white/10 p-6 rounded-2xl w-full max-w-sm mb-8 text-left shadow-sm border border-white/20">
                             <div className="flex justify-between mb-2 font-mono text-sm"><span>ç†±é‡</span><span>{dailyStats.calories} kcal</span></div>
                             <div className="flex justify-between mb-2 font-mono text-sm text-red-300"><span>è›‹ç™½è³ª</span><span>{dailyStats.totalP} g</span></div>
                             <div className="flex justify-between mb-2 font-mono text-sm text-yellow-300"><span>ç¢³æ°´</span><span>{dailyStats.totalC} g</span></div>
                             <div className="flex justify-between font-mono text-sm text-blue-300"><span>è„‚è‚ª</span><span>{dailyStats.totalF} g</span></div>
                             <MacroDistribution p={dailyStats.totalP} c={dailyStats.totalC} f={dailyStats.totalF} calories={dailyStats.calories} />
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setGameState("STAGES")} className="bg-gray-700 text-white px-6 py-3 rounded-full font-bold hover:bg-gray-600">å›åˆ°é¸å–®</button>
                            <button onClick={() => startLevel('WARMUP')} className="bg-yellow-400 text-black px-6 py-3 rounded-full font-bold hover:bg-yellow-300 shadow-lg transform transition hover:-translate-y-1">ğŸ”„ é‡æ–°æŒ‘æˆ°</button>
                        </div>
                    </div>
                )
            }

            if (gameState === "RESULT") {
                const personaId = calculatePersona(dailyStats);
                const persona = personaDatabase.find(p => p.id === personaId);
                const dailyAdvices = getNutritionFeedback(dailyStats, userProfile?.tdee || 2000);
                
                let goalResult = null;
                if (currentSubLevel && currentSubLevel.criteria) {
                    const isSuccess = currentSubLevel.criteria(dailyStats, userProfile?.tdee || 2000);
                    goalResult = {
                        success: isSuccess,
                        title: isSuccess ? "ğŸ‰ ç›®æ¨™é”æˆï¼" : "ğŸ’” ç›®æ¨™å¤±æ•—...",
                        msg: isSuccess ? currentSubLevel.successMsg : currentSubLevel.failMsg
                    };
                }

                return (
                    <div className="min-h-screen p-6 bg-slate-900 text-white flex flex-col items-center justify-center text-center fade-in overflow-y-auto">
                        {goalResult && (
                            <div className={`w-full max-w-sm p-4 rounded-xl mb-6 border-2 shadow-lg animate-[popIn_0.5s_ease-out] ${goalResult.success ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`}>
                                <h2 className={`text-2xl font-black mb-1 ${goalResult.success ? 'text-green-400' : 'text-red-400'}`}>{goalResult.title}</h2>
                                <p className="text-sm text-gray-200">{goalResult.msg}</p>
                            </div>
                        )}

                        <div className="mb-6 flex justify-center relative w-48 h-48 mx-auto">
                            {persona.image && persona.image.length > 0 ? (
                                <img 
                                    src={persona.image} 
                                    alt={persona.name} 
                                    className="w-48 h-48 object-contain drop-shadow-2xl img-bounce relative z-10"
                                />
                            ) : (
                                <div className="text-8xl animate-bounce">{persona.emoji}</div>
                            )}
                        </div>

                        <h2 className="text-2xl font-bold mb-2">è¦ºé†’äººæ ¼ï¼š{persona.name}</h2>
                        <p className="text-gray-400 mb-6 max-w-xs">{persona.desc}</p>
                        
                        <div className="bg-blue-900/50 p-4 rounded-xl w-full max-w-sm mb-6 border border-blue-700/50 text-left">
                            <h3 className="text-xs text-blue-300 mb-2 uppercase font-bold tracking-wider">ğŸ‘©â€âš•ï¸ ç‡Ÿé¤Šå¸«çš„æ¯æ—¥ç¸½è©•</h3>
                            <ul className="text-sm space-y-2">
                                {dailyAdvices.map((advice, idx) => (
                                    <li key={idx} className="flex gap-2">
                                        <span>â€¢</span>
                                        <span>{advice}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="bg-white/10 p-4 rounded-xl w-full max-w-sm mb-6 text-left">
                            <h3 className="text-xs text-gray-400 mb-2 uppercase">æœ¬æ—¥æ”å–ç¸½çµ</h3>
                            <div className="font-mono text-sm space-y-1">
                                <div className="flex justify-between"><span>ç†±é‡</span><span>{dailyStats.calories} kcal</span></div>
                                <div className="flex justify-between text-red-300"><span>è›‹ç™½è³ª</span><span>{dailyStats.totalP} g</span></div>
                                <div className="flex justify-between text-yellow-300"><span>ç¢³æ°´</span><span>{dailyStats.totalC} g</span></div>
                                <div className="flex justify-between text-blue-300"><span>è„‚è‚ª</span><span>{dailyStats.totalF} g</span></div>
                            </div>
                            <MacroDistribution p={dailyStats.totalP} c={dailyStats.totalC} f={dailyStats.totalF} calories={dailyStats.calories} />
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setGameState("STAGES")} className="bg-gray-700 text-white px-6 py-3 rounded-full font-bold hover:bg-gray-600">å›åˆ°é¸å–®</button>
                            <button onClick={() => {
                                setStoryMealIndex(0);
                                setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
                                setTray([]);
                                setGameState("STORY_PLAY");
                                setStoryModalOpen(true);
                            }} className="bg-yellow-400 text-black px-6 py-3 rounded-full font-bold hover:bg-yellow-300 shadow-lg transform transition hover:-translate-y-1">ğŸ”„ é‡æ–°æŒ‘æˆ°</button>
                        </div>
                    </div>
                );
            }

            if (gameState === "GALLERY") {
                return (
                    <div className="min-h-screen p-6 bg-gray-100 fade-in">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">é£²é£Ÿäººæ ¼åœ–é‘‘</h2><button onClick={() => setGameState("STAGES")} className="text-gray-500 hover:text-gray-800"><div className="w-6 h-6"><Icons.X /></div></button></div>
                        
                        <div className="grid grid-cols-2 gap-4">{personaDatabase.map(p=>(
                            <div 
                                key={p.id} 
                                onClick={()=>{if(unlockedPersonas.includes(p.id))setSelectedPersona(p)}} 
                                className={`bg-white p-4 rounded-xl shadow-sm flex flex-col items-center text-center transition-transform ${unlockedPersonas.includes(p.id)?'cursor-pointer hover:scale-105':'opacity-70'}`}
                            >
                                <div className={`mb-2 ${unlockedPersonas.includes(p.id)?'':'locked-persona'}`}>
                                    {p.image && p.image.length > 0 ? 
                                        <img src={p.image} alt={p.name} className="w-16 h-16 object-cover rounded-full" /> : 
                                        <div className="text-4xl">{p.emoji}</div>
                                    }
                                </div>
                                <div className="font-bold text-gray-800 text-sm mb-1">{unlockedPersonas.includes(p.id)?p.name:"???"}</div>
                            </div>
                        ))}</div>
                        <PersonaDetailModal persona={selectedPersona} onClose={() => setSelectedPersona(null)} />
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
