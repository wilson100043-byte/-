<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°ç”Ÿé£Ÿä»£ï¼šäººæ ¼è¦ºé†’</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF/Image ç”Ÿæˆå·¥å…· -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffbeb; } 
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* ç›¤å­æ¨£å¼ */
        .plate-container { width: 220px; height: 220px; border-radius: 50%; position: relative; background: radial-gradient(circle at 30% 30%, #fff, #f0f0f0); border: 6px solid #f8f9fa; margin: 0 auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.05), 0 10px 20px rgba(0,0,0,0.1); }
        .plate-slot { position: absolute; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .slot-0 { top: 10px; left: 50%; transform: translateX(-50%); }
        .slot-1 { top: 45px; right: 10px; }
        .slot-2 { bottom: 45px; right: 10px; }
        .slot-3 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .slot-4 { bottom: 45px; left: 10px; }
        .slot-5 { top: 45px; left: 10px; }

        .locked-persona { filter: brightness(0) opacity(0.3) grayscale(100%); }

        @keyframes unlockPop {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .unlock-animation {
            animation: unlockPop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* --- çµç®—åœ–ç‰‡çš„è·³å‹•å‹•ç•« --- */
        @keyframes celebrate-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px) scale(1.05); }
        }
        
        .img-bounce {
            animation: celebrate-bounce 2s infinite ease-in-out;
        }

        /* è®“ç›¤å­ä¸Šçš„é£Ÿç‰© Hover æ™‚æ™ƒå‹• */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        .hover-wiggle:hover {
            animation: wiggle 0.3s ease-in-out infinite;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.4;
            width: max-content;
            max-width: 220px;
            white-space: normal;
            text-align: center;
            z-index: 50;
            pointer-events: none;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Blob Animation for IG Card */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icons = {
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Star: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        };

        // --- 1. çœŸå¯¦è³‡æ–™åº« (å·²åˆ†é¡) ---
        const foodDatabase = [
            // éº¥ç•¶å‹ (ä¸€æ´»)
            { id: 'mcd_1', name: "å¤§éº¥å…‹", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 496, p: 26, c: 43, f: 25, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_2', name: "å‹è¾£é›è…¿å ¡", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 493, p: 22, c: 47, f: 24, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_6', name: "é›™å±¤ç‰›è‚‰å‰å£«å ¡", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 475, p: 26, c: 35, f: 14.9, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_7', name: "å«©ç…é›è…¿å ¡", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 363, p: 24, c: 40, f: 12, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_8', name: "éº¥é¦™é­š", restaurant: "éº¥ç•¶å‹", emoji: "ğŸŸ", calories: 330, p: 14, c: 36, f: 15, tags: ['fastfood', 'breakfast', 'lunch', 'dinner'] }, 
            { id: 'mcd_9', name: "èŒè‡å®‰æ ¼æ–¯ç‰›è‚‰", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 575, p: 30, c: 38, f: 34, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_10', name: "BLTå®‰æ ¼æ–¯ç‰›è‚‰", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 544, p: 30, c: 40, f: 29, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_11', name: "BLTå«©ç…é›è…¿å ¡", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ”", calories: 455, p: 27, c: 42, f: 20, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_12', name: "éº¥è„†é›", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ—", calories: 507, p: 31, c: 19.7, f: 34, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_18', name: "å››ç›å¸ç‰›è‚‰å ¡", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥©", calories: 541.3, p: 32, c: 40, f: 28, tags: ['fastfood', 'lunch', 'dinner'] },
            { id: 'mcd_3', name: "éº¥å…‹é›å¡Š(6å¡Š)", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ—", calories: 266, p: 16, c: 13, f: 17, tags: ['fastfood', 'snack', 'lunch', 'dinner'] },
            { id: 'mcd_4', name: "ä¸­è–¯", restaurant: "éº¥ç•¶å‹", emoji: "ğŸŸ", calories: 313, p: 5, c: 36, f: 17, tags: ['fastfood', 'snack', 'lunch', 'dinner'] },
            { id: 'mcd_5', name: "è˜‹æœæ´¾", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ", calories: 216.8, p: 2, c: 32, f: 9.2, tags: ['fastfood', 'snack'] },
            { id: 'mcd_19', name: "OREOå†°ç‚«é¢¨", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¦", calories: 311.7, p: 5.2, c: 49, f: 11, tags: ['fastfood', 'snack'] },
            { id: 'mcd_20', name: "å°æ¯ç‰ç±³æ¹¯", restaurant: "éº¥ç•¶å‹", emoji: "ğŸŒ½", calories: 93, p: 1.9, c: 17, f: 2.1, tags: ['fastfood', 'snack', 'breakfast'] },
            { id: 'mcd_17', name: "è—œéº¥çƒ¤é›æ²™æ‹‰", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥—", calories: 264.2, p: 22, c: 16, f: 13, tags: ['fastfood', 'healthy', 'tutorial_correct', 'breakfast'] }, 
            { id: 'mcd_13', name: "ä¸­æ¯å¯æ¨‚", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥¤", calories: 210.3, p: 0, c: 53, f: 0, tags: ['fastfood', 'drink'] },
            { id: 'mcd_14', name: "ä¸­æ¯é›¶å¡å¯æ¨‚", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥¤", calories: 0, p: 0, c: 0, f: 0, tags: ['fastfood', 'drink', 'tutorial_correct'] },
            { id: 'mcd_15', name: "ä¸­æ¯æª¸æª¬ç´…èŒ¶", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥¤", calories: 163.9, p: 0, c: 41, f: 0, tags: ['fastfood', 'drink'] },
            { id: 'mcd_16', name: "ä¸­æ¯é›ªç¢§", restaurant: "éº¥ç•¶å‹", emoji: "ğŸ¥¤", calories: 170.8, p: 0, c: 43, f: 0, tags: ['fastfood', 'drink'] },
            
            // 7-11 (è³‡æ–™æ›´æ–° - å¤§é‡è£œä¸Š breakfast æ¨™ç±¤)
            { id: 'sev_1', name: "ç‰¹é¸éº»é†¬æ¶¼éºµ", restaurant: "7-11", emoji: "ğŸœ", calories: 626, p: 14.4, c: 80.2, f: 27.5, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_2', name: "æ—¥å¼è•éº¥é¢¨å‘³éºµ", restaurant: "7-11", emoji: "ğŸœ", calories: 316, p: 12.1, c: 55.7, f: 5, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_3', name: "ç´å¥§è‰¯é¢¨å‘³é›å ¡", restaurant: "7-11", emoji: "ğŸ”", calories: 357, p: 17.1, c: 31.6, f: 18, tags: ['convenience', 'breakfast', 'lunch'] },
            { id: 'sev_4', name: "é›™è”¬é®ªé­šé£¯ç³°", restaurant: "7-11", emoji: "ğŸ™", calories: 240, p: 5.2, c: 38.5, f: 7.2, tags: ['convenience', 'breakfast'] },
            { id: 'sev_5', name: "å¾¡é¸è‚‰é¬†é£¯ç³°", restaurant: "7-11", emoji: "ğŸ™", calories: 258, p: 5.5, c: 39.8, f: 8.5, tags: ['convenience', 'breakfast'] },
            { id: 'sev_6', name: "é¾è¦é¢¨å‘³é£¯ç³°", restaurant: "7-11", emoji: "ğŸ™", calories: 228, p: 4.7, c: 38.3, f: 6.2, tags: ['convenience', 'breakfast'] },
            { id: 'sev_7', name: "æ»‘è›‹å«©é›è¦ªå­ä¸¼", restaurant: "7-11", emoji: "ğŸ›", calories: 613, p: 23.6, c: 99.2, f: 13.5, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_8', name: "ä½›è’™ç‰¹å’–å“©é›", restaurant: "7-11", emoji: "ğŸ›", calories: 781, p: 24.1, c: 120.6, f: 22.5, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_9', name: "é¦™è’œå¥¶æ²¹ç¾©éºµ", restaurant: "7-11", emoji: "ğŸ", calories: 646, p: 22.4, c: 89.6, f: 22, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_10', name: "èµ·å¸ç«è…¿è›‹ä¸‰æ˜æ²»", restaurant: "7-11", emoji: "ğŸ¥ª", calories: 230, p: 6.1, c: 25.5, f: 11.5, tags: ['convenience', 'breakfast'] },
            { id: 'sev_11', name: "åŠç¬¬è±¬è‚‰æ°´é¤ƒ", restaurant: "7-11", emoji: "ğŸ¥Ÿ", calories: 430, p: 14.8, c: 38.6, f: 24.1, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_12', name: "èµ·å¸å››é‡å¥ç†±ç‹—", restaurant: "7-11", emoji: "ğŸŒ­", calories: 452, p: 17.5, c: 33.6, f: 27.5, tags: ['convenience', 'breakfast', 'lunch'] },
            { id: 'sev_13', name: "ä¸‰èµ·å¸è‚‰é†¬ç„—é£¯", restaurant: "7-11", emoji: "ğŸ¥˜", calories: 685, p: 19.2, c: 114.5, f: 16.7, tags: ['convenience', 'lunch', 'dinner'] },
            { id: 'sev_14', name: "è³ªç«‹å¸Œè‡˜å¼å„ªæ ¼", restaurant: "7-11", emoji: "ğŸ¥£", calories: 185, p: 6.0, c: 23.6, f: 7.4, tags: ['convenience', 'snack', 'healthy', 'breakfast'] },
            { id: 'sev_15', name: "ä¸»å»šçƒ¤é›æ™‚è”¬é¤", restaurant: "7-11", emoji: "ğŸ±", calories: 432, p: 25.5, c: 45.1, f: 16.6, tags: ['convenience', 'healthy', 'lunch', 'dinner'] },
            { id: 'sev_16', name: "å¢é›è›‹ç™½é¤", restaurant: "7-11", emoji: "ğŸ±", calories: 595, p: 31.1, c: 72.4, f: 20.1, tags: ['convenience', 'healthy', 'tutorial_correct', 'lunch', 'dinner'] },
            { id: 'sev_17', name: "åºœåŸé¹½æ°´é¢¨å‘³æ„éºµ", restaurant: "7-11", emoji: "ğŸœ", calories: 552, p: 22.9, c: 73.9, f: 18.3, tags: ['convenience', 'lunch', 'dinner'] },
            { id: '9', name: "7-11 é›èƒ¸è‚‰", restaurant: "7-11", emoji: "ğŸ’ª", calories: 130, p: 24, c: 2, f: 2, tags: ['convenience', 'tutorial_correct', 'healthy', 'breakfast'] },

            // é‡Œæ´‹çƒ˜ç„™ (ä¸€æ´»)
            { id: 'ly_1', name: "é‡Œæ´‹æ³¢è˜¿éºµåŒ…", restaurant: "é‡Œæ´‹çƒ˜ç„™", emoji: "ğŸ", calories: 280, p: 7, c: 37, f: 11, tags: ['snack', 'breakfast'] },
            { id: 'ly_2', name: "ç´…è±†éºµåŒ…", restaurant: "é‡Œæ´‹çƒ˜ç„™", emoji: "ğŸ¥¯", calories: 253, p: 7, c: 45, f: 5, tags: ['snack', 'breakfast'] },
            { id: 'ly_3', name: "å¥¶é…¥éºµåŒ…", restaurant: "é‡Œæ´‹çƒ˜ç„™", emoji: "ğŸ¥", calories: 345, p: 9, c: 41, f: 16, tags: ['snack', 'breakfast'] },
            { id: 'ly_4', name: "å¥¶æ²¹æ²éºµåŒ…", restaurant: "é‡Œæ´‹çƒ˜ç„™", emoji: "ğŸ¥–", calories: 322, p: 9, c: 49, f: 10, tags: ['snack', 'breakfast'] },
            { id: 'ly_5', name: "èœ‚èœœè›‹ç³•", restaurant: "é‡Œæ´‹çƒ˜ç„™", emoji: "ğŸ°", calories: 242, p: 7, c: 42, f: 5, tags: ['snack', 'breakfast'] },

            // é£Ÿäº‹å ´ (ä¸€æ´»)
            { id: 'shishi_1', name: "é›æ’å’–å“©é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ›", calories: 751, p: 24, c: 103, f: 27, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_2', name: "ç«è…¿è›‹ç‚’é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸš", calories: 663, p: 15, c: 99, f: 23, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_3', name: "è±¬æ’è›‹ç‚’é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ¥©", calories: 742, p: 26, c: 101, f: 26, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_4', name: "é…¥ç‚¸é›è…¿é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ—", calories: 800, p: 35, c: 75, f: 40, tags: ['restaurant', 'night_market', 'lunch', 'dinner'] },
            { id: 'shishi_5', name: "å®¢å®¶å°ç‚’", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ¥¡", calories: 626, p: 28, c: 70, f: 26, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_6', name: "è”¥çˆ†è±¬è‚‰é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ±", calories: 650, p: 24, c: 71, f: 30, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_7', name: "ç³–é†‹é›ä¸é£¯", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ—", calories: 706, p: 32, c: 86, f: 26, tags: ['restaurant', 'lunch', 'dinner'] },
            { id: 'shishi_8', name: "æ˜†å¸ƒè±¬è‚‰é‹", restaurant: "é£Ÿäº‹å ´", emoji: "ğŸ²", calories: 439, p: 33, c: 43, f: 15, tags: ['restaurant', 'lunch', 'dinner'] },

            // è›‹ç™½ç›’å­ (ä¸€æ´»)
            { id: 'pb_1', name: "æ‰“æ‹‹è±¬é£¯", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ±", calories: 440, p: 13, c: 61, f: 16, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_2', name: "é›èƒ¸é£¯", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ¥—", calories: 439, p: 33, c: 61, f: 7, tags: ['healthy', 'tutorial_correct', 'lunch', 'dinner'] },
            { id: 'pb_3', name: "é›è…¿æ’é£¯", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ—", calories: 475, p: 24, c: 61, f: 15, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_4', name: "ç´ æ’éª¨é¤ç›’", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ¥¬", calories: 500, p: 19, c: 61, f: 20, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_5', name: "é’è”¥æµ·é¹½é›èƒ¸", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ¥—", calories: 460, p: 36, c: 61, f: 8, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_6', name: "éŸ“å¼è¾£é†¬è±¬", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ±", calories: 561, p: 20, c: 64, f: 25, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_7', name: "é’èŠ±æ¤’é›è…¿æ’", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ—", calories: 483, p: 26, c: 61, f: 15, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_8', name: "å£½å–œç‰›äº”èŠ±", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ¥©", calories: 594, p: 18, c: 63, f: 30, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_9', name: "æ¼¢å ¡æ’é¤ç›’", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸ”", calories: 439, p: 24, c: 61, f: 11, tags: ['healthy', 'lunch', 'dinner'] },
            { id: 'pb_10', name: "å‘³å™Œçƒ¤é±¸é­š", restaurant: "è›‹ç™½ç›’å­", emoji: "ğŸŸ", calories: 421, p: 32, c: 62, f: 5, tags: ['healthy', 'lunch', 'dinner'] },

            // ç³§æ™¨ GETé£Ÿ (ä¸€æ´»)
            { id: 'lc_1', name: "åŸ¹æ ¹è›‹é¤…", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸŒ¯", calories: 357, p: 15, c: 36, f: 17, tags: ['breakfast'] },
            { id: 'lc_2', name: "é®ªé­šè›‹åå¸", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ¥ª", calories: 442, p: 15, c: 37, f: 26, tags: ['breakfast'] },
            { id: 'lc_3', name: "è‰è“åå¸", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ", calories: 149, p: 2, c: 33, f: 1, tags: ['breakfast', 'snack'] },
            { id: 'lc_4', name: "å·§å…‹åŠ›åšç‰‡", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ«", calories: 306, p: 4, c: 50, f: 10, tags: ['breakfast', 'snack'] },
            { id: 'lc_5', name: "å¡å•¦é›è…¿è›‹å ¡", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ”", calories: 648, p: 25, c: 56, f: 36, tags: ['breakfast'] },
            { id: 'lc_6', name: "ç‰›è‚‰è›‹æ¼¢å ¡", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ”", calories: 474, p: 18, c: 51, f: 22, tags: ['breakfast'] },
            { id: 'lc_7', name: "è˜‘è‡ç‚’éºµ", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ", calories: 402, p: 11, c: 67, f: 10, tags: ['breakfast'] },
            { id: 'lc_8', name: "ç¶œåˆæµ·é®®ç¾©éºµ", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ", calories: 519, p: 24, c: 72, f: 15, tags: ['lunch'] },
            { id: 'lc_9', name: "ç«è…¿ç‰ç±³ç†±å£“", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ¥ª", calories: 389, p: 10, c: 40, f: 21, tags: ['breakfast'] },
            { id: 'lc_10', name: "è˜¿è””ç³•", restaurant: "ç³§æ™¨GETé£Ÿ", emoji: "ğŸ¥•", calories: 306, p: 2, c: 44, f: 14, tags: ['breakfast', 'snack'] },

            // å››æµ·éŠé¾ (ä¸€æ´») - è¨­å®šç‚ºä¸€ä»½8é¡†
            { id: 'sh_1', name: "æ‹›ç‰Œé‹è²¼(8é¡†)", restaurant: "å››æµ·éŠé¾", emoji: "ğŸ¥Ÿ", calories: 480, p: 16, c: 50, f: 24, tags: ['lunch', 'dinner'] }, 
            { id: 'sh_2', name: "éŸ­èœé‹è²¼(8é¡†)", restaurant: "å››æµ·éŠé¾", emoji: "ğŸ¥Ÿ", calories: 440, p: 18, c: 48, f: 20, tags: ['lunch', 'dinner'] }, 
            { id: 'sh_3', name: "ç‰ç±³æ°´é¤ƒ(8é¡†)", restaurant: "å››æµ·éŠé¾", emoji: "ğŸ¥Ÿ", calories: 360, p: 16, c: 48, f: 12, tags: ['lunch', 'dinner'] }, 
            { id: 'sh_4', name: "ç‰›æ±ä¹¾éºµ", restaurant: "å››æµ·éŠé¾", emoji: "ğŸœ", calories: 591, p: 22, c: 115, f: 5, tags: ['lunch', 'dinner'] },
            { id: 'sh_5', name: "è‚‰ç‡¥æ‹Œéºµ", restaurant: "å››æµ·éŠé¾", emoji: "ğŸœ", calories: 563, p: 20, c: 93, f: 12, tags: ['lunch', 'dinner'] },

            // æ°´é›²æœµ (ä¸€æ´»)
            { id: 'wd_1', name: "é»‘ç³–çç å¥¶èŒ¶", restaurant: "æ°´é›²æœµ", emoji: "ğŸ§‹", calories: 903, p: 1, c: 190, f: 8, tags: ['drink', 'snack'] },
            { id: 'wd_2', name: "ä¼¯çˆµé®®å¥¶èŒ¶", restaurant: "æ°´é›²æœµ", emoji: "ğŸ¥¤", calories: 246, p: 10, c: 29, f: 10, tags: ['drink'] },
            { id: 'wd_3', name: "ç”˜è”—é’èŒ¶", restaurant: "æ°´é›²æœµ", emoji: "ğŸµ", calories: 344, p: 0, c: 86, f: 0, tags: ['drink'] },
            { id: 'wd_4', name: "æœ¨ç“œç‰›å¥¶", restaurant: "æ°´é›²æœµ", emoji: "ğŸ¥›", calories: 567, p: 14, c: 95, f: 14, tags: ['drink'] },
            { id: 'wd_5', name: "å†¬ç“œèŒ¶", restaurant: "æ°´é›²æœµ", emoji: "ğŸ¹", calories: 301, p: 0, c: 75, f: 0, tags: ['drink'] },

            // å“è»’æ¨“ (ç¦®è³¢æ¨“)
            { id: 'ph_1', name: "è²´å¦ƒé›è…¿é£¯", restaurant: "å“è»’æ¨“", emoji: "ğŸ—", calories: 766, p: 38, c: 86, f: 30, tags: ['lunch', 'dinner'] },
            { id: 'ph_2', name: "é…¥ç‚¸è±¬æ’é£¯", restaurant: "å“è»’æ¨“", emoji: "ğŸ¥©", calories: 881, p: 42, c: 86, f: 41, tags: ['lunch', 'dinner'] },
            { id: 'ph_3', name: "è”¥çˆ†è±¬è‚‰é£¯", restaurant: "å“è»’æ¨“", emoji: "ğŸ±", calories: 819, p: 38, c: 88, f: 35, tags: ['lunch', 'dinner'] },
            { id: 'ph_4', name: "å®®ä¿é›ä¸é£¯", restaurant: "å“è»’æ¨“", emoji: "ğŸ›", calories: 811, p: 37, c: 87, f: 35, tags: ['lunch', 'dinner'] },
            { id: 'ph_5', name: "è’²ç‡’é¯›é­šé£¯", restaurant: "å“è»’æ¨“", emoji: "ğŸŸ", calories: 729, p: 29, c: 88, f: 29, tags: ['lunch', 'dinner'] },

            // é‡æ…¶æŠ„æ‰‹ (ç¦®è³¢æ¨“)
            { id: 'cc_1', name: "é®®è‡é›æ¹¯éºµ", restaurant: "é‡æ…¶æŠ„æ‰‹", emoji: "ğŸœ", calories: 510, p: 18, c: 76, f: 15, tags: ['lunch', 'dinner'] },
            { id: 'cc_2', name: "é›ªèœè‚‰çµ²æ¹¯éºµ", restaurant: "é‡æ…¶æŠ„æ‰‹", emoji: "ğŸœ", calories: 540, p: 24, c: 75, f: 16, tags: ['lunch', 'dinner'] },
            { id: 'cc_3', name: "åŸæ¹¯æŠ„æ‰‹æ¹¯éºµ", restaurant: "é‡æ…¶æŠ„æ‰‹", emoji: "ğŸœ", calories: 592, p: 25, c: 78, f: 20, tags: ['lunch', 'dinner'] },
            { id: 'cc_4', name: "é¦™è‡ç‚¸é†¬ä¹¾éºµ", restaurant: "é‡æ…¶æŠ„æ‰‹", emoji: "ğŸ", calories: 576, p: 22, c: 77, f: 20, tags: ['lunch', 'dinner'] },
            { id: 'cc_5', name: "é›™è‡ç´ ä¹¾éºµ", restaurant: "é‡æ…¶æŠ„æ‰‹", emoji: "ğŸ", calories: 508, p: 16, c: 75, f: 16, tags: ['lunch', 'dinner'] },

            // è·¯æ˜“è (ç¦®è³¢æ¨“)
            { id: 'louisa_1', name: "èŠåœ’ç´šæ‹¿éµ", restaurant: "è·¯æ˜“è", emoji: "â˜•", calories: 296, p: 8, c: 48, f: 8, tags: ['drink', 'breakfast'] }, 
            { id: 'louisa_2', name: "è‹±å¼å¥¶èŒ¶", restaurant: "è·¯æ˜“è", emoji: "ğŸ§‹", calories: 280, p: 8, c: 44, f: 8, tags: ['drink', 'breakfast'] }, 
            { id: 'louisa_3', name: "ç¶“å…¸æ°´æœèŒ¶", restaurant: "è·¯æ˜“è", emoji: "ğŸ¹", calories: 300, p: 0, c: 75, f: 0, tags: ['drink'] },
            { id: 'louisa_4', name: "è±¬è‚‰èµ·å¸ç‘ªèŠ¬", restaurant: "è·¯æ˜“è", emoji: "ğŸ”", calories: 448, p: 17, c: 32, f: 28, tags: ['breakfast', 'snack'] },
            { id: 'louisa_5', name: "ç‡»é›ä¸‰æ˜æ²»", restaurant: "è·¯æ˜“è", emoji: "ğŸ¥ª", calories: 419, p: 15, c: 56, f: 15, tags: ['breakfast', 'snack'] },

            // é¾å¾·ç¾…è (äºŒæ´»)
            { id: 'pond_1', name: "è²åŠ›ç‰›æ’6oz", restaurant: "é¾å¾·ç¾…è", emoji: "ğŸ¥©", calories: 386, p: 36, c: 8, f: 23, tags: ['lunch', 'dinner', 'steak'] },
            { id: 'pond_2', name: "æ²™æœ—ç‰›æ’6.5oz", restaurant: "é¾å¾·ç¾…è", emoji: "ğŸ¥©", calories: 378, p: 38, c: 10, f: 20, tags: ['lunch', 'dinner', 'steak'] },
            { id: 'pond_3', name: "ç‰›å°æ’8oz", restaurant: "é¾å¾·ç¾…è", emoji: "ğŸ¥©", calories: 592, p: 25, c: 8, f: 51, tags: ['lunch', 'dinner', 'steak'] },
            { id: 'pond_4', name: "ç‚­çƒ¤é›è…¿æ’7oz", restaurant: "é¾å¾·ç¾…è", emoji: "ğŸ—", calories: 352, p: 35, c: 8, f: 20, tags: ['lunch', 'dinner', 'steak'] },
            { id: 'pond_5', name: "ç¾å¼çƒ¤è±¬è‚‹æ’", restaurant: "é¾å¾·ç¾…è", emoji: "ğŸ–", calories: 581, p: 33, c: 8, f: 46, tags: ['lunch', 'dinner', 'steak'] },

            // å°è”¬æ­ (äºŒæ´»)
            { id: 'xsh_1', name: "å¡”é¦™æè‡", restaurant: "å°è”¬æ­", emoji: "ğŸ„", calories: 69, p: 1, c: 5, f: 5, tags: ['side', 'vegetarian'] },
            { id: 'xsh_2', name: "åšç…è˜¿è””ç³•", restaurant: "å°è”¬æ­", emoji: "ğŸ¥•", calories: 226, p: 4, c: 30, f: 10, tags: ['side', 'vegetarian'] },
            { id: 'xsh_3', name: "è€çš®å«©è‚‰", restaurant: "å°è”¬æ­", emoji: "ğŸ§Š", calories: 130, p: 7, c: 4, f: 10, tags: ['side', 'vegetarian'] },
            { id: 'xsh_4', name: "è‡­å‘³ç›¸æŠ•", restaurant: "å°è”¬æ­", emoji: "ğŸ²", calories: 200, p: 14, c: 0, f: 16, tags: ['side', 'vegetarian'] },
            { id: 'xsh_5', name: "ç‚’å¹´ç³•", restaurant: "å°è”¬æ­", emoji: "ğŸ¥˜", calories: 277, p: 7, c: 51, f: 5, tags: ['side', 'vegetarian'] },

            // SUBWAY (äºŒæ´»)
            { id: 'sub_1', name: "å«©åˆ‡é›è‚‰æ½›è‰‡å ¡", restaurant: "SUBWAY", emoji: "ğŸ¥ª", calories: 300, p: 20, c: 41, f: 6, tags: ['healthy', 'fastfood', 'lunch', 'dinner'] },
            { id: 'sub_2', name: "ç«è…¿æ½›è‰‡å ¡", restaurant: "SUBWAY", emoji: "ğŸ¥ª", calories: 317, p: 19, c: 44, f: 7, tags: ['healthy', 'fastfood', 'lunch', 'dinner'] },
            { id: 'sub_3', name: "ç‡’çƒ¤ç‰›è‚‰æ½›è‰‡å ¡", restaurant: "SUBWAY", emoji: "ğŸ¥ª", calories: 346, p: 21, c: 40, f: 7, tags: ['healthy', 'fastfood', 'lunch', 'dinner'] },
            { id: 'sub_4', name: "é®ªé­šæ½›è‰‡å ¡", restaurant: "SUBWAY", emoji: "ğŸ¥ª", calories: 507, p: 22, c: 39, f: 29, tags: ['healthy', 'fastfood', 'lunch', 'dinner'] },
            { id: 'sub_5', name: "è›‹æ²™æ‹‰æ½›è‰‡å ¡", restaurant: "SUBWAY", emoji: "ğŸ¥ª", calories: 421, p: 17, c: 41, f: 21, tags: ['healthy', 'fastfood', 'lunch', 'dinner'] },

            // æ›‰é¹¿é³´æ¨“ (äºŒæ´»)
            { id: 'xl_1', name: "éŠ·é­‚æ±å¡è‚‰", restaurant: "æ›‰é¹¿é³´æ¨“", emoji: "ğŸ¥©", calories: 461, p: 10, c: 4, f: 45, tags: ['lunch', 'dinner'] },
            { id: 'xl_2', name: "è”¥çˆ†ç‰›è‚‰çµ²", restaurant: "æ›‰é¹¿é³´æ¨“", emoji: "ğŸ¥©", calories: 194, p: 18, c: 8, f: 10, tags: ['lunch', 'dinner'] },
            { id: 'xl_3', name: "å·¦å®—æ£ é›", restaurant: "æ›‰é¹¿é³´æ¨“", emoji: "ğŸ—", calories: 118, p: 13, c: 3, f: 6, tags: ['lunch', 'dinner'] },
            { id: 'xl_4', name: "ç´…ç‡’é»ƒé­š", restaurant: "æ›‰é¹¿é³´æ¨“", emoji: "ğŸŸ", calories: 114, p: 12, c: 3, f: 6, tags: ['lunch', 'dinner'] },
            { id: 'xl_5', name: "è¦é†¬ç©ºå¿ƒèœ", restaurant: "æ›‰é¹¿é³´æ¨“", emoji: "ğŸ¥¬", calories: 100, p: 5, c: 11, f: 4, tags: ['lunch', 'dinner'] },

            // æ›‰é¹¿ç›’é£Ÿ (äºŒæ´» - ä¾¿ç•¶)
            { id: 'xlbox_1', name: "æ±å¡è‚‰ä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 785, p: 45, c: 87, f: 48, tags: ['lunch', 'dinner'] },
            { id: 'xlbox_2', name: "è»Ÿéª¨æ’ä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 728, p: 47, c: 86, f: 41, tags: ['lunch', 'dinner'] },
            { id: 'xlbox_3', name: "å·¦å®—æ£ é›ä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 736, p: 35, c: 123, f: 31, tags: ['lunch', 'dinner'] },
            { id: 'xlbox_4', name: "ç‡‰ç‰›è…©ä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 621, p: 50, c: 87, f: 33, tags: ['lunch', 'dinner'] },
            { id: 'xlbox_5', name: "ç™½å¸¶é­šä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 790, p: 37, c: 91, f: 44, tags: ['lunch', 'dinner'] },
            { id: 'xlbox_6', name: "ä¹å®®æ ¼å¾¡ä¾¿ç•¶", restaurant: "æ›‰é¹¿ç›’é£Ÿ", emoji: "ğŸ±", calories: 764, p: 43, c: 87, f: 47, tags: ['lunch', 'dinner'] },

            // è«å‡¡å½¼ (äºŒæ´»)
            { id: 'mv_1', name: "é´¨èƒ¸ç¾©å¤§åˆ©éºµ", restaurant: "è«å‡¡å½¼", emoji: "ğŸ", calories: 650, p: 28, c: 76, f: 26, tags: ['lunch', 'dinner'] },
            { id: 'mv_2', name: "æµ·é®®ç‡‰é£¯", restaurant: "è«å‡¡å½¼", emoji: "ğŸ¥˜", calories: 676, p: 28, c: 78, f: 28, tags: ['lunch', 'dinner'] },
            { id: 'mv_3', name: "ç‰›æ’é’é†¬çƒ¤é£¯", restaurant: "è«å‡¡å½¼", emoji: "ğŸ¥©", calories: 768, p: 36, c: 84, f: 32, tags: ['lunch', 'dinner'] },
            { id: 'mv_4', name: "æµ·é™¸ç¸½åŒ¯æŠ«è–©", restaurant: "è«å‡¡å½¼", emoji: "ğŸ•", calories: 732, p: 31, c: 80, f: 32, tags: ['lunch', 'dinner'] },
            { id: 'mv_5', name: "ç„—çƒ¤è”¬èœåƒå±¤éºµ", restaurant: "è«å‡¡å½¼", emoji: "ğŸ", calories: 653, p: 22, c: 76, f: 29, tags: ['lunch', 'dinner'] },

            // å°æœ¨å±‹é¬†é¤… (æ–°å£å‘³è£œå……)
            { id: 'cabin_1', name: "è—è“é¬†é¤…", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ§‡", calories: 379, p: 9, c: 66, f: 12, tags: ['snack'] },
            { id: 'cabin_2', name: "å·§å…‹åŠ›é¦™è•‰", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ§‡", calories: 587, p: 11, c: 84, f: 23, tags: ['snack'] },
            { id: 'cabin_3', name: "æŠ¹èŒ¶ç´…è±†", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ§‡", calories: 667, p: 14, c: 99, f: 24, tags: ['snack'] },
            { id: 'cabin_4', name: "é¦™è‰å¡å£«é”", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ§‡", calories: 524, p: 10, c: 86, f: 16, tags: ['snack'] },
            { id: 'cabin_5', name: "æµ·æ´¾è¦å ¡é¬†é¤…", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ¤", calories: 813, p: 21, c: 87, f: 20, tags: ['lunch', 'snack'] },
            { id: 'cabin_6', name: "é»‘å’–å–±ç‰›å ¡", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ”", calories: 614, p: 19, c: 81, f: 24, tags: ['lunch', 'snack'] },
            { id: 'cabin_7', name: "æµ·æ´¾è¦å ¡(å–®)", restaurant: "å°æœ¨å±‹é¬†é¤…", emoji: "ğŸ¤", calories: 154, p: 11, c: 11, f: 7, tags: ['snack'] },

            // æ¤°æ—ç‡’è‡˜ (æ–°å¢)
            { id: 'yl_1', name: "è”¥æ²¹é›é£¯", restaurant: "æ¤°æ—ç‡’è‡˜", emoji: "ğŸ—", calories: 672, p: 30, c: 75, f: 28, tags: ['lunch', 'dinner'] },
            { id: 'yl_2', name: "å‰ç‡’é£¯", restaurant: "æ¤°æ—ç‡’è‡˜", emoji: "ğŸ¥©", calories: 681, p: 28, c: 77, f: 29, tags: ['lunch', 'dinner'] },
            { id: 'yl_3', name: "ç‡’é´¨é£¯", restaurant: "æ¤°æ—ç‡’è‡˜", emoji: "ğŸ—", calories: 689, p: 31, c: 76, f: 29, tags: ['lunch', 'dinner'] },
            { id: 'yl_4', name: "è„†çš®ç‡’è‚‰é£¯", restaurant: "æ¤°æ—ç‡’è‡˜", emoji: "ğŸ¥©", calories: 754, p: 32, c: 80, f: 34, tags: ['lunch', 'dinner'] },
            { id: 'yl_5', name: "ä¸‰å¯¶é£¯", restaurant: "æ¤°æ—ç‡’è‡˜", emoji: "ğŸ±", calories: 658, p: 28, c: 78, f: 26, tags: ['lunch', 'dinner'] },

            // æ¯”å¸å¤š (æ–°å¢)
            { id: 'bs_1', name: "é¦™é›æ’æ¼¢å ¡è›‹", restaurant: "æ¯”å¸å¤š", emoji: "ğŸ”", calories: 554, p: 22, c: 58, f: 26, tags: ['breakfast', 'lunch'] },
            { id: 'bs_2', name: "çƒ¤ç«è…¿è›‹åå¸", restaurant: "æ¯”å¸å¤š", emoji: "ğŸ¥ª", calories: 421, p: 16, c: 40, f: 21, tags: ['breakfast'] },
            { id: 'bs_3', name: "çƒ¤é®ªé­šè›‹åå¸", restaurant: "æ¯”å¸å¤š", emoji: "ğŸ¥ª", calories: 392, p: 12, c: 41, f: 20, tags: ['breakfast'] },
            { id: 'bs_4', name: "ç‰ç±³è›‹é¤…", restaurant: "æ¯”å¸å¤š", emoji: "ğŸŒ¯", calories: 352, p: 10, c: 42, f: 16, tags: ['breakfast'] },
            { id: 'bs_5', name: "è˜¿è””ç³•", restaurant: "æ¯”å¸å¤š", emoji: "ğŸ¥•", calories: 374, p: 14, c: 48, f: 14, tags: ['breakfast', 'snack'] },

            // å£¹ç•ªå±‹ (æ–°å¢)
            { id: 'ich_1', name: "ç‚¸é›å¡Šå’–å“©é£¯", restaurant: "å£¹ç•ªå±‹", emoji: "ğŸ›", calories: 890, p: 42, c: 86, f: 42, tags: ['lunch', 'dinner', 'restaurant'] },
            { id: 'ich_2', name: "ç‚¸è±¬æ’å’–å“©é£¯", restaurant: "å£¹ç•ªå±‹", emoji: "ğŸ›", calories: 925, p: 44, c: 86, f: 45, tags: ['lunch', 'dinner', 'restaurant'] },
            { id: 'ich_3', name: "æ¼¢å ¡å’–å“©é£¯", restaurant: "å£¹ç•ªå±‹", emoji: "ğŸ›", calories: 866, p: 44, c: 87, f: 38, tags: ['lunch', 'dinner', 'restaurant'] },
            { id: 'ich_4', name: "éº»å©†å’–å“©é£¯", restaurant: "å£¹ç•ªå±‹", emoji: "ğŸ›", calories: 741, p: 33, c: 78, f: 33, tags: ['lunch', 'dinner', 'restaurant'] },
            { id: 'ich_5', name: "è”¬èœå’–å“©é£¯", restaurant: "å£¹ç•ªå±‹", emoji: "ğŸ›", calories: 684, p: 28, c: 80, f: 28, tags: ['lunch', 'dinner', 'restaurant'] },

            // å¤å¨å¤·çˆ­é®®é£¯ (æ–°å¢)
            { id: 'hw_1', name: "å£½å–œç‡’ç‰›è‚‰é£¯", restaurant: "å¤å¨å¤·", emoji: "ğŸ®", calories: 750, p: 33, c: 84, f: 32, tags: ['lunch', 'dinner'] },
            { id: 'hw_2', name: "ç”Ÿé®­é­šé£¯", restaurant: "å¤å¨å¤·", emoji: "ğŸŸ", calories: 602, p: 27, c: 82, f: 18, tags: ['lunch', 'dinner', 'healthy'] },
            { id: 'hw_3', name: "è’œå‘³é®®ç™½è¦é£¯", restaurant: "å¤å¨å¤·", emoji: "ğŸ¦", calories: 579, p: 27, c: 82, f: 16, tags: ['lunch', 'dinner', 'healthy'] },
            { id: 'hw_4', name: "é¹½å‘³èˆ’è‚¥é›é£¯", restaurant: "å¤å¨å¤·", emoji: "ğŸ¥—", calories: 581, p: 34, c: 82, f: 13, tags: ['lunch', 'dinner', 'healthy', 'tutorial_correct'] },
            { id: 'hw_5', name: "æ¤’éº»ç³–å¿ƒè›‹é£¯", restaurant: "å¤å¨å¤·", emoji: "ğŸ¥š", calories: 580, p: 25, c: 82, f: 17, tags: ['lunch', 'dinner'] },
        ];

        // --- 2. é£²é£Ÿäººæ ¼ (æ›´æ–°è©³ç´°å ±å‘Šå…§å®¹) ---
        const personaDatabase = [
            { 
                id: 'faster', 
                name: 'çµ•é£Ÿç³»ä¿®ä»™è€…', 
                emoji: 'ğŸ§˜', 
                image: './achievement_faster.png', 
                desc: 'åƒé€™éº¼å°‘ï¼Œä½ æ˜¯æº–å‚™å¾—é“æˆä»™äº†å—ï¼Ÿ', 
                color: 'bg-gray-100 text-gray-800',
                details: {
                    slogan: "ä»Šå¤©åˆæ˜¯é éˆæ°£é‹ä½œçš„ä¸€å¤©ã€‚",
                    traits: ["å¸¸å¸¸å› å¿™ç¢Œã€æ²’èƒƒå£æˆ–æ‡¶å¾—åƒï¼Œè€Œè®“ç†±é‡æ”å–åš´é‡ä¸è¶³ã€‚", "ä¸€å¤©å¯èƒ½åªåƒä¸€é¤æˆ–é é›¶é£Ÿæ’éå»ã€‚", "å°ã€Œåƒã€çš„æ„Ÿå—æ¨¡ç³Šï¼Œæœ‰æ™‚æœƒä¸å°å¿ƒåƒå¤ªå°‘ã€‚"],
                    health: {
                        title: "ä¿®è¡Œæ­¸ä¿®è¡Œï¼Œä½†èº«é«”éœ€è¦èƒ½é‡é‹ä½œå‘€ã€‚ä½ç†±é‡å¤ªä¹…ï¼Œå®¹æ˜“ï¼š",
                        items: ["å°ˆæ³¨åŠ›ä¸‹é™", "æ‰‹è…³å†°å†·ã€ç²¾ç¥ä¸æ¿Ÿ", "æƒ…ç·’èµ·ä¼è¼ƒå¤§"]
                    },
                    strategy: ["æ—©é¤å…ˆåƒé»ã€Œèƒ½é‡å°ç‰©ã€ï¼šé¦™è•‰ã€åå¸ã€å„ªæ ¼éƒ½å¾ˆå¥½ã€‚", "ç”¨ã€Œä¸€æ‹³é ­è¦å‰‡ã€ï¼šæ¯é¤è‡³å°‘è£œå……ä¸€æ‹³é ­å¤§å°çš„ä¸»é£Ÿã€‚", "æ­£é¤è‡³å°‘åƒå…©æ¨£ï¼šä¸»é£Ÿ + è›‹ç™½è³ªï¼Œå…¶ä»–è¦åƒå°±åŠ åˆ†ï¼"],
                    upgrade: ["å˜—è©¦å›ºå®šä¸‰é¤ä¸­çš„è‡³å°‘å…©é¤", "å–„ç”¨ä¾¿åˆ©å•†åº—çµ„åˆï¼šé£¯ç³°ï¼‹è±†æ¼¿ã€éºµåŒ…ï¼‹èŒ¶è‘‰è›‹", "å°‡é£²é£Ÿè¦–ç‚ºè£œå……é«”åŠ›è€Œä¸æ˜¯è² æ“”"],
                    partners: {
                        best: "è›‹ç™½è³ªçµäººï½œä»–æœƒæ‹‰ä½ ä¸€èµ·åƒè¶³é‡ã€‚",
                        bad: "å…¬é¤¨æ²¹ç‹ï½œæ²¹å¤ªé‡æœƒè®“ä½ æ›´é›£é–‹èƒƒã€‚"
                    }
                }
            },
            { 
                id: 'oil_king', 
                name: 'å…¬é¤¨æ²¹ç‹', 
                emoji: 'ğŸ›¢ï¸', 
                image: './achievement_oil_king.png', 
                desc: 'ä½ çš„è¡€ç®¡è£¡æµçš„ä¸æ˜¯è¡€ï¼Œæ˜¯é¦™æ¿ƒçš„é›æ²¹èˆ‡æ»·è‚‰æ±ã€‚', 
                color: 'bg-yellow-100 text-yellow-800',
                details: {
                    slogan: "ä½ çš„è¡€ç®¡è£¡æµçš„ä¸æ˜¯è¡€ï¼Œæ˜¯é¦™æ¿ƒçš„é›æ²¹èˆ‡æ»·è‚‰æ±ã€‚",
                    traits: ["å–œæ­¡æ¿ƒéƒã€æ²¹é¦™ã€ç‚¸ç‰©é¡é£Ÿç‰©ã€‚", "é£²é£Ÿä¸­å¸¸å‡ºç¾éš±å½¢è„‚è‚ªï¼ˆå¥¶ç²¾ã€æ»·æ±ã€é…¥çš®ï¼‰ã€‚", "åƒå®Œå®¹æ˜“è¦ºå¾—ç´¯ã€æƒ³ç¡ã€‚"],
                    health: {
                        title: "ä½ çš„èƒƒä¸æ˜¯æ²¹é‹ï¼Œèº«é«”å…¶å¯¦å–œæ­¡ã€Œå‰›å‰›å¥½ã€çš„æ²¹ã€‚éå¤šæ²¹è„‚å¯èƒ½é€ æˆï¼š",
                        items: ["ä¸‹åˆæ˜æ˜æ¬²ç¡", "èƒƒå£åè€Œè®Šå·®", "é•·æœŸè² æ“”éå¤§"]
                    },
                    strategy: ["ä»Šå¤©çš„ç‚¸ç‰©æ›ä¸€æ¬¡çƒ¤ç‰©ã€‚", "å¥¶èŒ¶æ”¹ç„¡ç³–ï¼‹å»å¥¶ç²¾ã€‚", "æ»·å‘³é¸æ°´ç…®ã€é’èœå¤šåŠ ä¸€ä»½ã€‚"],
                    upgrade: ["å°‘ä¸€é»é‡æ²¹ã€å¤šä¸€é»ä¸»èœ", "æå‡è”¬èœé‡è®“æ²¹è„‚æ›´å¥½è¢«æ¶ˆåŒ–", "å¶çˆ¾æŒ‘é¸åŸå‹é£Ÿç‰©ç•¶ä¸»è§’"],
                    partners: {
                        best: "ç‡Ÿé¤Šç²¾ç®—å¸«ï½œæœƒå¹«ä½ é»˜é»˜å¹³è¡¡æ•´å¥—é¤ã€‚",
                        bad: "æ¾±ç²‰æ•™å¾’ï½œæ²¹ï¼‹æ¾±ç²‰ï¼å¤ªå¿«æ¨‚ä½†å¾Œæœå¤ªé‡ã€‚"
                    }
                }
            },
            { 
                id: 'carb_cultist', 
                name: 'æ¾±ç²‰æ•™å¾’', 
                emoji: 'ğŸš', 
                image: './achievement_carb_cultist.png', 
                desc: 'é£¯ã€éºµã€éºµåŒ…...æ²’æœ‰æ¾±ç²‰çš„ä¸€é¤å°ä½ ä¾†èªªåªæ˜¯é»å¿ƒã€‚', 
                color: 'bg-orange-100 text-orange-800',
                details: {
                    slogan: "é£¯ã€éºµã€éºµåŒ…ï¼Œæ˜¯ä½ çš„ä¸‰å¤§æ‘¯æ„›ã€‚",
                    traits: ["ä¸»é£Ÿä»½é‡å®¹æ˜“ä¸å°å¿ƒéé‡ã€‚", "å¸¸å¸¸é¤å¾Œå…©å°æ™‚åˆé¤“ã€‚", "ä»¥æ¾±ç²‰ç‚ºä¸»è§’ï¼Œä½†è›‹ç™½è³ªåä½ã€‚"],
                    health: {
                        title: "ç¢³æ°´æ˜¯å¥½æœ‹å‹ï¼Œä½†å¤ªå¤šæœƒè®“ä½ ï¼š",
                        items: ["èƒ½é‡å…ˆé£†å¾Œæ‰", "è®Šå¾—å¾ˆå®¹æ˜“è‚šå­é¤“", "ä¸‹åˆæ³¨æ„åŠ›ä½è½"]
                    },
                    strategy: ["é£¯é‡æ¸›åŠã€åŠ ä¸€ä»½è›‹ç™½è³ªè£œè¶³ã€‚", "éºµï¼‹èŒ¶è‘‰è›‹æ˜¯ä¸€å€‹å¥½çµ„åˆã€‚", "éºµåŒ…ï¼‹ç‰›å¥¶ï¼Œè€Œä¸æ˜¯éºµåŒ…ï¼‹éºµåŒ…ã€‚"],
                    upgrade: ["ç”¨è›‹ç™½è³ªç©©ä½è¡€ç³–æ›²ç·š", "ä¸»é£Ÿä»½é‡å¯ä»¥å¾®èª¿", "è®“æ¯é¤è‡³å°‘æœ‰ä¸€ä»½ã€ŒæŠ—é¤“é£Ÿç‰©ã€"],
                    partners: {
                        best: "è›‹ç™½è³ªçµäººï½œå®Œç¾äº’è£œã€‚",
                        bad: "å…¬é¤¨æ²¹ç‹ï½œæ²¹ï¼‹æ¾±ç²‰å¤ªå®¹æ˜“å¤±æ§ã€‚"
                    }
                }
            },
            { 
                id: 'protein_hunter', 
                name: 'è›‹ç™½è³ªçµäºº', 
                emoji: 'ğŸ’ª', 
                image: './achievement_protein_hunter.png', 
                desc: 'ä½ çš„çœ¼è£¡åªæœ‰é›èƒ¸è‚‰ï¼Œé€£å–æ°´éƒ½æƒ³åŠ è›‹ç™½ç²‰ã€‚', 
                color: 'bg-red-100 text-red-800',
                details: {
                    slogan: "ä½ çš„çœ¼è£¡åªæœ‰é›èƒ¸è‚‰ã€‚",
                    traits: ["å–œæ­¡é«˜è›‹ç™½é¤é»ï¼Œè›‹ç™½è³ªæ¯”ä¾‹åé«˜ã€‚", "è”¬èœèˆ‡ä¸»é£Ÿæ”å–é‡å¯èƒ½ä¸å¤ªå‡è¡¡ã€‚", "æ˜“å‡ºç¾ä¾¿ç§˜æˆ–èƒ½é‡ä¸è¶³ã€‚"],
                    health: {
                        title: "èº«é«”ä¸æ˜¯åªæœ‰è‚Œè‚‰éœ€è¦èƒ½é‡å–”ï¼å¦‚æœè›‹ç™½è³ªå¤ªé«˜ã€å…¶ä»–å¤ªä½ï¼š",
                        items: ["æœƒè¦ºå¾—ç–²å‹", "æ’ä¾¿ä¸é †", "é‹å‹•æ¢å¾©æ…¢"]
                    },
                    strategy: ["é›èƒ¸è‚‰åŠ ä¸€ä»½é£¯æˆ–éºµã€‚", "æ¯é¤è‡³å°‘ä¸€ä»½è”¬èœã€‚", "å„ªæ ¼ã€è±†æ¼¿ä¹Ÿæ˜¯å¥½æœ‹å‹ã€‚"],
                    upgrade: ["ä¸»é£Ÿä¸å¯çœ", "è”¬èœæå‡åˆ°ã€Œçœ‹å¾—è¦‹çš„é‡ã€", "å¢è‚Œï¼ä¸æ˜¯åªæœ‰è›‹ç™½è³ª"],
                    partners: {
                        best: "æ¾±ç²‰æ•™å¾’ï½œå¤©ä½œä¹‹åˆï¼Œäº’è£œåˆ°å®Œç¾ã€‚",
                        bad: "çµ•é£Ÿç³»ä¿®ä»™è€…ï½œå…©äººéƒ½åƒä¸å¤ å®Œæ•´ã€‚"
                    }
                }
            },
            { 
                id: 'nutritionist', 
                name: 'ç‡Ÿé¤Šç²¾ç®—å¸«', 
                emoji: 'ğŸ¥—', 
                image: './achievement_nutritionist.png', 
                desc: 'ä¸‰å¤§ç‡Ÿé¤Šç´ æ¯”ä¾‹å®Œç¾ï¼Œä½ æ˜¯ AI å§ï¼Ÿ', 
                color: 'bg-green-100 text-green-800',
                details: {
                    slogan: "ä½ çš„èƒƒå¾ˆå®‰å¿ƒï¼Œå› ç‚ºä½ æ°¸é ç®—å¾—å¾ˆæº–ã€‚",
                    traits: ["PCF çµ„åˆå‡è¡¡ï¼Œç†±é‡æ¥è¿‘ TDEEã€‚", "æ¦‚å¿µæ¸…æ¥šã€é£²é£Ÿç©©å®šã€ä¸æ¥µç«¯ã€‚", "å¤§éƒ¨åˆ†é¸æ“‡éƒ½åœ¨å¯æ¥å—å¥åº·ç¯„åœå…§ã€‚"],
                    health: {
                        title: "ä½ åšå¾—å¾ˆæ£’ï¼Œä½†è¨˜å¾—ï¼š",
                        items: ["å‡è¡¡ä¸¦ä¸æ˜¯ã€Œå®Œç¾ã€ï¼Œé©åº¦å½ˆæ€§ä¹Ÿå¾ˆé‡è¦ã€‚"]
                    },
                    strategy: ["ä¸€é€±ä¸€æ¬¡äº«å—å‹é¤é»ï¼Œä¿æŒèº«å¿ƒå¹³è¡¡ã€‚", "éš¨èº«æƒ³ä¸€ä»½ã€Œç°¡å–®å‡è¡¡å¿«é¤çµ„åˆã€ã€‚", "æƒ…ç·’ä½è½æ™‚å…è¨±è‡ªå·±åƒå–œæ­¡çš„æ±è¥¿ã€‚"],
                    upgrade: ["ä¸ç”¨è¿½æ±‚å¤ªåš´æ ¼", "åšå¾—åˆ°çš„å‡è¡¡æ¯”å®Œç¾æ›´é‡è¦", "ä¿ç•™æ¨‚è¶£ï¼Œä¿æŒæŒçºŒæ€§"],
                    partners: {
                        best: "æ‰€æœ‰äººï½œä½ æ˜¯å¤§å®¶çš„æ•‘è´–ã€‚",
                        bad: null
                    }
                }
            },
            { 
                id: 'happy_chubby', 
                name: 'éš¨æ€§ç¾é£Ÿå®¶', 
                emoji: 'ğŸ˜ˆ', 
                image: './achievement_happy_chubby.png', 
                desc: 'é£²é£Ÿéš¨å¿ƒæ‰€æ¬²ï¼Œé›–ç„¶ç¨å¾®è¶…å‡ºå¥åº·æ¨™æº–ï¼Œä½†åƒå¾—é–‹å¿ƒæœ€é‡è¦ï¼', 
                color: 'bg-purple-100 text-purple-800',
                details: {
                    slogan: "åƒé£¯é å¿ƒæƒ…ï¼Œç‡Ÿé¤Šé ç·£åˆ†ã€‚ä½ åƒçš„æ˜¯å¿ƒæƒ…ï¼Œèƒƒåªæ˜¯é…åˆæ¼”å‡ºã€‚",
                    traits: ["é£²é£Ÿæ²’æœ‰å›ºå®šæ¨¡å¼ã€‚", "å¶çˆ¾å¾ˆç‡Ÿé¤Šã€å¶çˆ¾äº‚åƒï¼Œä½†å¾ˆé–‹å¿ƒã€‚", "é£²é£Ÿä¸Šæ²’æœ‰å¼·çƒˆåå¥½ï¼Œåã€Œç›´è¦ºæ´¾ã€ã€‚"],
                    health: {
                        title: "ä½ åƒå¾—å¾ˆè‡ªç”±ï¼Œä½†èº«é«”å¶çˆ¾éœ€è¦ä¸€é»è¦å¾‹ä¾†è·Ÿä¸Šä½ ã€‚å¤ªéš¨æ€§æ„Ÿåˆ°æ··äº‚æ™‚ï¼Œå®¹æ˜“ï¼š",
                        items: ["èƒ½é‡ä¸è¶³", "æƒ…ç·’ä½è½", "æ³¨æ„åŠ›è·³ä¾†è·³å»"]
                    },
                    strategy: ["æ¯é¤ä»»é¸ä¸€å€‹å›ºå®šå…ƒç´ ï¼šã€Œè›‹ç™½è³ª or è”¬èœã€ã€‚", "ä¸€é€±ç·´ç¿’ 2 é¤ã€Œæœ‰ä¸»é£Ÿã€æœ‰é…èœã€çš„å®Œæ•´çµæ§‹ã€‚", "æ¸›å°‘ã€Œé›¶é£Ÿç•¶é¤ã€ç‹€æ³ã€‚"],
                    upgrade: ["ä¿æŒå½ˆæ€§ï¼Œä½†å»ºç«‹åŸºæœ¬æ¡†æ¶", "æ¯å¤©è‡³å°‘ä¸€é¤åƒå¾—å®Œæ•´", "è®“èº«é«”è·Ÿä¸Šä½ çš„å¿«æ¨‚ç¯€å¥"],
                    partners: {
                        best: "ç‡Ÿé¤Šç²¾ç®—å¸«ï½œä»–çµ¦ä½ çµæ§‹ï¼Œä½ çµ¦ä»–å¿«æ¨‚ã€‚",
                        bad: "çµ•é£Ÿç³»ä¿®ä»™è€…ï½œå…©äººéƒ½å¤ªéš¨æ€§ï¼Œç‡Ÿé¤Šå®¹æ˜“å¤±è¡¡ã€‚"
                    }
                }
            },
        ];

        // --- 3. é—œå¡è¨­å®š ---
        const stages = {
            TUTORIAL: {
                id: 'TUTORIAL',
                title: 'ç‡Ÿé¤Šæ–°æ‰‹æ‘',
                desc: 'æŒæ¡ä¸‰å¤§ç‡Ÿé¤Šç´ çš„å¥§ç§˜ï¼',
                type: 'tutorial_menu', 
                theme: 'blue',
                icon: 'ğŸ”°',
                subLevels: [
                    {
                        id: 'tutorial_protein',
                        title: 'é—œå¡ 1ï¼šè›‹ç™½è³ªçµäºº',
                        desc: 'å¢è‚Œæ¸›è„‚çš„ç¬¬ä¸€æ­¥ï¼è«‹åœ¨æ‰€æœ‰é£Ÿç‰©ä¸­ï¼Œæ‰¾å‡ºè›‹ç™½è³ªå«é‡è±å¯Œçš„çµ„åˆã€‚',
                        objective: 'è›‹ç™½è³ªæ¯”ä¾‹ > 30%',
                        hint: "ç›®æ¨™ï¼šè›‹ç™½è³ªç†±é‡ä½”æ¯”è¶…é 30%",
                        criteria: (stats) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return pRatio > 0.3;
                        },
                        failMsg: "è›‹ç™½è³ªæ¯”ä¾‹ä¸è¶³å–”ï¼è©¦è‘—æ‰¾æ‰¾é›è‚‰ã€è›‹æˆ–è±†æ¼¿ï¼Œé¿å…å¤ªå¤šæ¾±ç²‰å’Œæ²¹ã€‚",
                        successMsg: "å¤ªæ£’äº†ï¼ä½ å·²ç¶“æŒæ¡äº†å°‹æ‰¾è›‹ç™½è³ªçš„æŠ€å·§ï¼"
                    },
                    {
                        id: 'tutorial_fat',
                        title: 'é—œå¡ 2ï¼šæ²¹è†©è†©æŒ‘æˆ°',
                        desc: 'é«”é©—ä»€éº¼å«åšè¡€ç®¡å µå¡ï¼è«‹çµ„å‡ºä¸€å€‹è¶…ç´šæ²¹è†©çš„é¤ç›¤ã€‚',
                        objective: 'æ²¹è„‚æ¯”ä¾‹ > 45%',
                        hint: "ç›®æ¨™ï¼šè„‚è‚ªç†±é‡ä½”æ¯”è¶…é 45%",
                        criteria: (stats) => {
                            const fRatio = (stats.totalF * 9) / (stats.calories || 1);
                            return fRatio > 0.45;
                        },
                        failMsg: "é‚„ä¸å¤ æ²¹å–”ï¼æ‰¾æ‰¾çœ‹ç‚¸ç‰©ã€é…¥çš®æˆ–æ˜¯åŸ¹æ ¹é¡çš„é£Ÿç‰©ã€‚",
                        successMsg: "å“‡ï¼é€™é¤çœŸçš„è¶…ç´šæ²¹ï¼è¡€ç®¡åœ¨å°–å«äº†ï¼"
                    }
                ]
            },
            WARMUP: {
                id: 'WARMUP',
                title: 'è‡ªç”±é£Ÿç¿’',
                desc: 'å…ˆä¾†åƒä¸€é¤è©¦è©¦æ°´æº«ï¼Œç†Ÿæ‚‰ä¸€ä¸‹æ“ä½œä»‹é¢ã€‚',
                type: 'meal',
                theme: 'green',
                icon: 'âš”ï¸',
                tags: [],
                hint: "é»æ“Šé¤ç›¤ä¸Šçš„é£Ÿç‰©å¯ä»¥ç§»é™¤å–”ï¼" // Updated hint
            },
            STORY: {
                id: 'STORY',
                title: 'ä¸€æ—¥ç”Ÿå­˜æˆ°',
                desc: 'é¸æ“‡ä½ çš„ç›®æ¨™ï¼ŒæŒ‘æˆ°ä¸€æ—¥ä¸‰é¤ï¼',
                type: 'story_menu',
                theme: 'purple',
                icon: 'ğŸ†',
                meals: [
                    { 
                        name: "æ—©é¤", 
                        tags: ['breakfast'], 
                        hint: "åªèƒ½é¸æ—©é¤åº—",
                        storyTitle: "â° 8:10 AM - ç¡éé ­å•¦ï¼",
                        storyDesc: "é¬§é˜éŸ¿äº†ä¸‰æ¬¡ä½ éƒ½æ²’è½åˆ°ï¼Œé†’ä¾†ç™¼ç¾è·é›¢ç¬¬ä¸€å ‚é¤¨è—ç™¼å±•åªå‰© 10 åˆ†é˜ï¼\n\næ²’æ™‚é–“å„ªé›…åœ°æ‰‹æ²–å’–å•¡äº†ï¼Œä½ å¿…é ˆåœ¨å»ç³»é¤¨çš„è·¯ä¸Šï¼Œç”¨æœ€å¿«çš„é€Ÿåº¦è§£æ±ºæ—©é¤ã€‚\n\nã€ä»»å‹™ç›®æ¨™ã€‘ è«‹åœ¨ã€Œæ—©é¤åº—ã€è¿…é€ŸæŠ“å–é£Ÿç‰©ï¼"
                    },
                    { 
                        name: "åˆé¤", 
                        tags: ['convenience', 'fastfood'], 
                        hint: "è¶•æ™‚é–“ï¼åªèƒ½åƒè¶…å•†æˆ–é€Ÿé£Ÿ",
                        storyTitle: "ğŸ•› 12:20 PM - è¦“é£Ÿçš„æˆ°å ´",
                        storyDesc: "çµ‚æ–¼ä¸‹èª²äº†ï¼Œä½†ä¸‹åˆ 1:20 é‚„æœ‰é€šè­˜èª²è¦è¶•ã€‚\n\næ ¡åœ’è£¡åˆ°è™•éƒ½æ˜¯äººï¼Œå°ç¦å‰é¢æ’éšŠæ’åˆ°å¤©è’åœ°è€ã€‚ä½ åªæœ‰ä¸åˆ°ä¸€å°æ™‚çš„æ™‚é–“ï¼Œå¿…é ˆæ±‚å¿«ã€æ±‚é£½ï¼Œé‡é»æ˜¯ä¸èƒ½è®“ä¸‹åˆçš„è‡ªå·±é¤“æ­»æˆ–æƒ³ç¡è¦ºï¼\n\nã€ä»»å‹™ç›®æ¨™ã€‘ é¸æ“‡å¿«é€Ÿå–å¾—çš„ã€Œè¶…å•†ã€æˆ–ã€Œé€Ÿé£Ÿã€è£œå……èƒ½é‡ï¼"
                    },
                    { 
                        name: "æ™šé¤", 
                        tags: [], 
                        hint: "çµ‚æ–¼ä¸‹èª²äº†ï¼å…¬é¤¨ç¾é£Ÿä»»ä½ åƒ",
                        storyTitle: "ğŸ•• 6:30 PM - è‡ªç”±çš„ç©ºæ°£",
                        storyDesc: "æ­å–œä½ ï¼çµ‚æ–¼æ’éäº†å……æ»¿æ‘§æ®˜çš„ä¸€å¤©ã€‚\n\næ­¤åˆ»çš„ä½ èº«å¿ƒä¿±ç–²ï¼Œåªæœ‰å…¬é¤¨å¤œå¸‚çš„ç‡ˆå…‰èƒ½æº«æš–ä½ çš„å¿ƒã€‚é€™æ™‚å€™ä¸ç”¨ç®¡ä»€éº¼æ•ˆç‡äº†ï¼Œæƒ³åƒä»€éº¼å°±åƒä»€éº¼ï¼Œé€™æ˜¯å±¬æ–¼å‹åˆ©è€…çš„æ™šé¤ï¼\n\nã€ä»»å‹™ç›®æ¨™ã€‘ å…¨ç¨®é¡è§£é–ï¼å»ã€Œå…¬é¤¨å•†åœˆã€æˆ–ã€Œé¤å»³ã€å¥½å¥½çŠ’è³è‡ªå·±å§ï¼"
                    }
                ],
                subLevels: [
                    {
                        id: 'story_fat_loss',
                        title: 'ğŸ”¥ ç›®æ¨™ï¼šæ¸›è„‚è¨ˆç•«',
                        desc: 'æ§åˆ¶ç†±é‡ï¼Œä¿æŒé£½è¶³æ„Ÿï¼Œç‡ƒç‡’è„‚è‚ªå§ï¼',
                        objective: 'ç†±é‡<TDEE ä¸” è›‹ç™½è³ªå……è¶³',
                        color: 'from-orange-500 to-red-500',
                        criteria: (stats, tdee) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return stats.calories < tdee * 0.95 && stats.calories > tdee * 0.6 && pRatio > 0.25;
                        },
                        analyzeFail: (stats, tdee) => {
                             const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                             if (stats.calories >= tdee * 0.95) return "å¤±æ•—åŸå› ï¼šç†±é‡å¤ªé«˜äº†ï¼æ¸›è„‚éœ€è¦å‰µé€ ã€Œç†±é‡èµ¤å­—ã€ï¼Œå°‘åƒé»ç‚¸ç‰©æˆ–æ¾±ç²‰å§ã€‚";
                             if (stats.calories <= tdee * 0.6) return "å¤±æ•—åŸå› ï¼šç†±é‡å¤ªä½äº†ï¼åƒå¤ªå°‘æœƒè®“ä»£è¬ä¸‹é™ï¼Œåè€Œç˜¦ä¸ä¸‹ä¾†å–”ã€‚";
                             if (pRatio <= 0.25) return "å¤±æ•—åŸå› ï¼šè›‹ç™½è³ªä¸è¶³ï¼æ¸›è„‚æœŸè›‹ç™½è³ªä¸å¤ æœƒå°è‡´è‚Œè‚‰æµå¤±ï¼Œå¤šåƒé»è‚‰æˆ–è›‹ã€‚";
                             return "å¤±æ•—åŸå› ï¼šæœªé”æ¨™ï¼Œè«‹é‡æ–°èª¿æ•´é£²é£Ÿæ¯”ä¾‹ã€‚";
                        },
                        successMsg: "æ¸›è„‚æŒ‘æˆ°æˆåŠŸï¼ç†±é‡æ§åˆ¶å¾—å®œï¼Œè›‹ç™½è³ªä¹Ÿè¶³å¤ ï¼Œæ˜¯å®Œç¾çš„æ¸›è„‚æ—¥ï¼",
                        failMsg: "æ¸›è„‚æŒ‘æˆ°å¤±æ•—ã€‚ç†±é‡å¯èƒ½è¶…æ¨™ï¼Œæˆ–æ˜¯è›‹ç™½è³ªæ”å–ä¸è¶³å°è‡´è‚Œè‚‰æµå¤±å–”ã€‚"
                    },
                    {
                        id: 'story_balanced',
                        title: 'âš–ï¸ ç›®æ¨™ï¼šç‡Ÿé¤Šå‡è¡¡',
                        desc: 'ä¸æ¥µç«¯é£²é£Ÿï¼Œè¿½æ±‚èº«å¿ƒéˆçš„å¹³è¡¡ã€‚',
                        objective: 'ç†±é‡ç¶­æŒ TDEEï¼ŒP/C/F å‡è¡¡',
                        color: 'from-blue-400 to-indigo-500',
                        criteria: (stats, tdee) => {
                             const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                             const fRatio = (stats.totalF * 9) / (stats.calories || 1);
                             const cRatio = (stats.totalC * 4) / (stats.calories || 1);
                             
                             const calOk = stats.calories >= tdee * 0.85 && stats.calories <= tdee * 1.15;
                             // ç¢ºä¿è„‚è‚ªæ¯”ä¾‹ä¸è¶…é 0.45 (æ²¹ç‹é–€æª») ä¸”çµ•å°å€¼ä¸è¶…é 80g
                             const ratioOk = pRatio > 0.12 && pRatio < 0.45 && 
                                             fRatio > 0.15 && fRatio <= 0.45 && 
                                             cRatio > 0.25 && cRatio < 0.70;
                             const absoluteOk = stats.totalF <= 80;

                             return calOk && ratioOk && absoluteOk;
                        },
                        analyzeFail: (stats, tdee) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            const fRatio = (stats.totalF * 9) / (stats.calories || 1);
                            const cRatio = (stats.totalC * 4) / (stats.calories || 1);

                            if (stats.calories < tdee * 0.85) return "å¤±æ•—åŸå› ï¼šç†±é‡åš´é‡ä¸è¶³ï¼å‡è¡¡é£²é£Ÿä¸æ˜¯è¦ä½ é¤“è‚šå­ã€‚";
                            if (stats.calories > tdee * 1.15) return "å¤±æ•—åŸå› ï¼šç†±é‡è¶…æ¨™å›‰ï¼å‡è¡¡é£²é£Ÿä¹Ÿè¦æ§åˆ¶ç¸½é‡ã€‚";
                            if (fRatio > 0.45 || stats.totalF > 80) return "å¤±æ•—åŸå› ï¼šå¤ªæ²¹äº†ï¼(è¶…é 45% æˆ– 80g) é€™æ¨£æœƒè®Šæˆå…¬é¤¨æ²¹ç‹å–”ã€‚";
                            if (cRatio > 0.7) return "å¤±æ•—åŸå› ï¼šæ¾±ç²‰å¤ªå¤šï¼é£¯éºµåƒå¤ªå¤šæœƒç‡Ÿé¤Šä¸å‡ã€‚";
                            if (pRatio < 0.12) return "å¤±æ•—åŸå› ï¼šè›‹ç™½è³ªå¤ªå°‘ï¼è‚Œè‚‰éœ€è¦ç‡Ÿé¤Šä¿®å¾©ã€‚";
                            return "å¤±æ•—åŸå› ï¼šä¸‰å¤§ç‡Ÿé¤Šç´ æ¯”ä¾‹å¤±è¡¡ï¼Œè«‹åƒè€ƒä¸Šæ–¹æ¯”ä¾‹æ¢èª¿æ•´ã€‚";
                        },
                        successMsg: "å‡è¡¡é£²é£ŸæˆåŠŸï¼ä½ çš„èº«é«”æ„Ÿè¬ä½ ï¼Œç¶­æŒäº†å®Œç¾çš„å¹³è¡¡ç‹€æ…‹ã€‚",
                        failMsg: "æŒ‘æˆ°å¤±æ•—ã€‚å¯èƒ½ç†±é‡å¤ªé«˜/å¤ªä½ï¼Œæˆ–è€…æŸä¸€é …ç‡Ÿé¤Šç´ æ¯”ä¾‹å¤±è¡¡å›‰ã€‚"
                    },
                    {
                        id: 'story_muscle',
                        title: 'ğŸ’ª ç›®æ¨™ï¼šå¢è‚Œç‰¹è¨“',
                        desc: 'ç‚ºäº†è®Šå¾—æ›´å¼·å£¯ï¼éœ€è¦ç†±é‡ç›ˆé¤˜èˆ‡å¤§é‡è›‹ç™½è³ªã€‚',
                        objective: 'ç†±é‡ > TDEE ä¸” é«˜è›‹ç™½',
                        color: 'from-green-500 to-emerald-600',
                        criteria: (stats, tdee) => {
                            const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                            return stats.calories > tdee * 1.05 && stats.calories < tdee * 1.4 && pRatio > 0.25;
                        },
                        analyzeFail: (stats, tdee) => {
                             const pRatio = (stats.totalP * 4) / (stats.calories || 1);
                             if (stats.calories <= tdee * 1.05) return "å¤±æ•—åŸå› ï¼šç†±é‡ä¸è¶³ï¼å¢è‚Œéœ€è¦ã€Œç†±é‡ç›ˆé¤˜ã€ï¼Œè¦æ•¢æ–¼å¤šåƒä¸€é»ï¼";
                             if (stats.calories >= tdee * 1.4) return "å¤±æ•—åŸå› ï¼šåƒå¤ªå¤šå•¦ï¼é›–ç„¶è¦å¢è‚Œï¼Œä½†åƒå¤ªå¤šæœƒè®Šèƒ–å–”ã€‚";
                             if (pRatio <= 0.25) return "å¤±æ•—åŸå› ï¼šè›‹ç™½è³ªä¸å¤ ï¼å…‰åƒç†±é‡æ²’ç”¨ï¼Œè¦æœ‰è›‹ç™½è³ªæ‰èƒ½é•·è‚Œè‚‰ã€‚";
                             return "å¤±æ•—åŸå› ï¼šæœªé”æ¨™ï¼Œè«‹å¤šåƒé»è‚‰ä¸¦å¢åŠ ç¸½ç†±é‡ã€‚";
                        },
                        successMsg: "å¢è‚ŒæŒ‘æˆ°æˆåŠŸï¼ç†±é‡ç›ˆé¤˜åŠ ä¸Šå……è¶³è›‹ç™½ï¼Œè‚Œè‚‰æ­£åœ¨ç”Ÿé•·ï¼",
                        failMsg: "æŒ‘æˆ°å¤±æ•—ã€‚ç†±é‡ä¸è¶³ä»¥æ”¯æŒè‚Œè‚‰ç”Ÿé•·ï¼Œæˆ–è€…è›‹ç™½è³ªåƒå¤ªå°‘å›‰ã€‚"
                    }
                ]
            }
        };

        const calculatePersona = (totalStats, tdee) => {
            if (totalStats.calories < 800) return 'faster';
            
            const pRatio = (totalStats.totalP * 4) / (totalStats.calories || 1);
            const fRatio = (totalStats.totalF * 9) / (totalStats.calories || 1);
            const cRatio = (totalStats.totalC * 4) / (totalStats.calories || 1);
            
            if (fRatio > 0.45 || totalStats.totalF > 80) return 'oil_king';
            if (cRatio > 0.60) return 'carb_cultist';
            if (pRatio > 0.30) return 'protein_hunter';
            
            if (tdee) {
                const calRatio = totalStats.calories / tdee;
                if (calRatio >= 0.85 && calRatio <= 1.15 && 
                    pRatio >= 0.2 && pRatio <= 0.4 && 
                    fRatio >= 0.2 && fRatio <= 0.4) {
                    return 'nutritionist';
                }
            }
            return 'happy_chubby'; 
        };

        const calculateStats = (gender, age, height, weight, activityLevel) => {
            let bmr = 10 * weight + 6.25 * height - 5 * age;
            if (gender === 'male') bmr += 5; else bmr -= 161;
            return Math.round(bmr * activityLevel);
        };

        const getNutritionFeedback = (stats, targetCalories, foods, currentLevelId) => {
            const { calories, totalP, totalC, totalF } = stats;
            const advice = [];
            
            if (calories < targetCalories * 0.5) {
                advice.push("âš ï¸ ç†±é‡ï¼šåš´é‡ä¸è¶³ (é€™æ¨£æœƒæ‰è‚Œè‚‰è®Šæ˜“èƒ–é«”è³ªå–”ï¼)");
            } else if (calories < targetCalories * 0.8) {
                if (currentLevelId === 'story_fat_loss') {
                     advice.push("âœ… ç†±é‡ï¼šæ§åˆ¶å¾—å®œ (è™•æ–¼æ¸›è„‚éœ€è¦çš„ç†±é‡èµ¤å­—å€é–“)");
                } else {
                     advice.push("ğŸ“‰ ç†±é‡ï¼šåä½ (èƒ½é‡ä¸è¶³å®¹æ˜“ç–²å‹ï¼Œä¸‹é¤è£œå›ä¾†)");
                }
            } else if (calories > targetCalories * 1.4) {
                advice.push("ğŸ”¥ ç†±é‡ï¼šåš´é‡è¶…æ¨™ (é€™é¤åƒå¾—å¤ªæ”¾ç¸±å›‰ï¼Œæ³¨æ„é«”è„‚ï¼)");
            } else if (calories > targetCalories * 1.1) {
                if (currentLevelId === 'story_muscle') {
                    advice.push("âœ… ç†±é‡ï¼šé”æ¨™ (å¢è‚Œéœ€è¦ç†±é‡ç›ˆé¤˜ï¼Œåƒé€™æ¨£å‰›å¥½ï¼)");
                } else {
                    advice.push("âš ï¸ ç†±é‡ï¼šç¨å¾®è¶…æ¨™ (å¶çˆ¾æ”¾ç¸±æ²’é—œä¿‚ï¼Œå¤šå–æ°´)");
                }
            } else {
                advice.push("âœ… ç†±é‡ï¼šæ§åˆ¶å®Œç¾ (ç¶­æŒå¾—å¾ˆæ£’ï¼Œè«‹ç¹¼çºŒä¿æŒ)");
            }

            const pRatio = (totalP * 4) / (calories || 1);
            const fRatio = (totalF * 9) / (calories || 1);
            const cRatio = (totalC * 4) / (calories || 1);

            if (pRatio < 0.15) advice.push(`ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ï¼šå¤ªå°‘ (è‚Œè‚‰ä¿®å¾©åŸæ–™ä¸è¶³ï¼Œæ˜“æµå¤±è‚Œè‚‰)`);
            else if (pRatio > 0.4) advice.push(`ğŸ’ª è›‹ç™½è³ªæ¯”ä¾‹ï¼šåé«˜ (æ²’é‡è¨“çš„è©±æœƒè®Šè…è‡Ÿè² æ“”å–”)`);
            else {
                if ((currentLevelId === 'story_fat_loss' || currentLevelId === 'story_muscle') && pRatio < 0.25) {
                    advice.push(`ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ï¼šé©ä¸­ï¼Œä½†å°æ–¼ã€Œ${currentLevelId === 'story_fat_loss' ? 'æ¸›è„‚' : 'å¢è‚Œ'}ã€ä¾†èªªé‚„ä¸å¤ å–”ï¼å»ºè­°æ‹‰é«˜åˆ° 25% ä»¥ä¸Šã€‚`);
                } else {
                    let extraMsg = "";
                    if (foods && foods.length > 0 && pRatio > 0.2) {
                         const mvp = foods.reduce((prev, current) => (prev.p > current.p) ? prev : current, foods[0]);
                         extraMsg = ` (MVP: ${mvp.name})`;
                    }
                    advice.push(`ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ï¼šé©ä¸­${extraMsg}`);
                }
            }

            if (fRatio > 0.45 || totalF > 80) {
                let culpritMsg = "";
                if (foods && foods.length > 0) {
                     const culprit = foods.reduce((prev, current) => (prev.f > current.f) ? prev : current, foods[0]);
                     culpritMsg = `ï¼Œå…‡æ‰‹æ˜¯ã€Œ${culprit.name}ã€`;
                }
                advice.push(`ğŸ›¢ï¸ æ²¹è„‚ï¼šå¤ªé«˜ (è¡€ç®¡åœ¨å°–å«äº†${culpritMsg}ï¼)`);
            } else if (fRatio < 0.15) {
                advice.push(`ğŸ¥‘ æ²¹è„‚æ¯”ä¾‹ï¼šå¤ªå°‘ (çš®è†šæœƒè®Šä¹¾æ¾€ï¼Œè·çˆ¾è’™éœ€è¦å¥½æ²¹)`);
            } else {
                advice.push(`ğŸ¥‘ æ²¹è„‚æ¯”ä¾‹ï¼šé©ä¸­ (å¾ˆæ£’ï¼ç¶­æŒèº«é«”æ©Ÿèƒ½é‹ä½œ)`);
            }

            if (cRatio > 0.65) {
                let culpritMsg = "";
                if (foods && foods.length > 0) {
                     const culprit = foods.reduce((prev, current) => (prev.c > current.c) ? prev : current, foods[0]);
                     culpritMsg = `ï¼ŒåŸä¾†æ˜¯ã€Œ${culprit.name}ã€`;
                }
                advice.push(`ğŸš æ¾±ç²‰æ¯”ä¾‹ï¼šéé‡ (è¡€ç³–æ³¢å‹•å¤§${culpritMsg}ï¼Œå°å¿ƒæƒ³ç¡)`);
            } else if (cRatio < 0.3) {
                advice.push(`ğŸ æ¾±ç²‰æ¯”ä¾‹ï¼šä¸è¶³ (å¤§è…¦åæ‡‰æœƒè®Šæ…¢ï¼Œä¹Ÿå®¹æ˜“æ²’åŠ›æ°£)`);
            } else {
                advice.push(`ğŸ æ¾±ç²‰æ¯”ä¾‹ï¼šé©ä¸­ (ç²¾ç¥é«”åŠ›ç¶­æŒå¾—å®œ)`);
            }

            return advice;
        };

        const getSmartInsights = (foods, stats, tdee) => {
            const insights = [];
            const { totalP, totalC, totalF, calories } = stats;

            if (!foods || foods.length === 0) return insights;

            const fRatio = (totalF * 9) / (calories || 1);
            if (fRatio > 0.45 || totalF > 80) { // çµ±ä¸€é–€æª»
                const culprit = foods.reduce((prev, current) => (prev.f > current.f) ? prev : current, foods[0]);
                if (culprit) insights.push({ type: 'bad', icon: 'ğŸ›¢ï¸', title: 'æ²¹è†©å…‡æ‰‹', msg: `æ²¹è„‚è¶…æ¨™ï¼ç½ªé­ç¦é¦–æ˜¯ã€Œ${culprit.name}ã€ï¼Œå®ƒè²¢ç»äº† ${Math.round(culprit.f)}g è„‚è‚ªï¼`});
            }

            const cRatio = (totalC * 4) / (calories || 1);
            if (cRatio > 0.65) { // çµ±ä¸€é–€æª»
                const culprit = foods.reduce((prev, current) => (prev.c > current.c) ? prev : current, foods[0]);
                if (culprit) insights.push({ type: 'bad', icon: 'ğŸš', title: 'æ¾±ç²‰ç‚¸å½ˆ', msg: `ã€Œ${culprit.name}ã€æ˜¯æœ€å¤§çš„é†£åˆ†ä¾†æºï¼Œå°å¿ƒè¡€ç³–é£†å‡æƒ³ç¡è¦ºï¼`});
            }

            // 3. ç”Ÿç†æ¨¡æ“¬ (é‡å°ç†±é‡)
            if (calories > tdee + 300) {
                 const runMin = Math.round((calories - tdee) / 10); // æ¦‚ç®—æ…¢è·‘æ¶ˆè€—
                 insights.push({ type: 'warn', icon: 'ğŸ”¥', title: 'ç†±é‡å›¤ç©è­¦å ±', msg: `å¤šåƒäº† ${calories - tdee} å¤§å¡ï¼Œé€™ç›¸ç•¶æ–¼è¦æ…¢è·‘ ${runMin} åˆ†é˜æ‰èƒ½æ¶ˆè€—æ‰ï¼`});
            } 
            // ç§»é™¤äº†ç†±é‡éä½åˆ¤å®šï¼Œé¿å…èª¤åˆ¤æ¸›è„‚æœŸ

            // 4. ä¿åº•é¡¯ç¤º (å¦‚æœä¸Šé¢éƒ½æ²’è§¸ç™¼ï¼Œé¡¯ç¤ºç†±é‡æœ€é«˜çš„é£Ÿç‰©)
            if (insights.length === 0) {
                const bigOne = foods.reduce((prev, current) => (prev.calories > current.calories) ? prev : current, foods[0]);
                insights.push({ type: 'neutral', icon: 'ğŸ”', title: 'ä¸»è¦ç†±é‡ä¾†æº', msg: `ä»Šå¤©åƒäº†ã€Œ${bigOne.name}ã€ï¼Œå®ƒä½”äº†ç¸½ç†±é‡çš„ ${Math.round(bigOne.calories / calories * 100)}%ã€‚`});
            }

            return insights.slice(0, 3); // æœ€å¤šé¡¯ç¤º 3 æ¢ï¼Œé¿å…ç‰ˆé¢å¤ªé•·
        };

        const TypewriterText = ({ text, speed = 30, onComplete }) => {
            const [displayedText, setDisplayedText] = useState("");
            const [index, setIndex] = useState(0);
            useEffect(() => {
                if (index < text.length) {
                    const timer = setTimeout(() => { setDisplayedText(prev => prev + text.charAt(index)); setIndex(prev => prev + 1); }, speed);
                    return () => clearTimeout(timer);
                } else if(onComplete) onComplete();
            }, [index, text, speed, onComplete]);
            return <div className="whitespace-pre-line leading-relaxed">{displayedText}<span className="cursor-blink"></span></div>;
        };

        const StoryModal = ({ title, desc, onClose }) => {
            const [isTypingComplete, setIsTypingComplete] = useState(false);
            const handleClick = () => {
                if (!isTypingComplete) { setIsTypingComplete(true); } else { onClose(); }
            };
            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-6 fade-in" onClick={handleClick}>
                    <div className="bg-white rounded-xl w-full max-w-md p-8 relative min-h-[300px] flex flex-col cursor-pointer">
                        <h2 className="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">{title}</h2>
                        <div className="flex-1 text-gray-700 text-lg mb-6 overflow-y-auto">
                            {isTypingComplete ? <div className="whitespace-pre-line leading-relaxed">{desc}</div> : <TypewriterText text={desc} onComplete={() => setIsTypingComplete(true)} />}
                        </div>
                        <div className="text-center text-gray-400 text-xs mt-auto animate-pulse border-t pt-4">{isTypingComplete ? "é»æ“Šä»»æ„è™•é–‹å§‹" : "é»æ“ŠåŠ é€Ÿé¡¯ç¤º..."}</div>
                    </div>
                </div>
            );
        };

        const MacroDistribution = ({ p, c, f, calories }) => {
            if (calories === 0) return null;
            const pPct = Math.round((p * 4 / calories) * 100);
            const cPct = Math.round((c * 4 / calories) * 100);
            const fPct = Math.round((f * 9 / calories) * 100);
            
            return (
                <div className="w-full mt-4">
                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                        <span>ç†±é‡åˆ†ä½ˆ</span>
                        <span>{Math.round(calories)} kcal</span>
                    </div>
                    <div className="h-4 w-full flex rounded-full overflow-hidden bg-gray-800">
                        <div style={{ width: `${pPct}%` }} className="bg-red-500" title={`è›‹ç™½è³ª ${pPct}%`}></div>
                        <div style={{ width: `${cPct}%` }} className="bg-yellow-500" title={`ç¢³æ°´ ${cPct}%`}></div>
                        <div style={{ width: `${fPct}%` }} className="bg-blue-500" title={`è„‚è‚ª ${fPct}%`}></div>
                    </div>
                    <div className="flex gap-4 mt-1 text-[10px] justify-center text-gray-400">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div>P {pPct}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-yellow-500"></div>C {cPct}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div>F {fPct}%</div>
                    </div>
                </div>
            );
        };

        const NutritionRatioBar = ({ p, c, f, calories }) => {
            if (!calories || calories === 0) return <div className="h-6"></div>; 

            const calFromP = p * 4;
            const calFromC = c * 4;
            const calFromF = f * 9;
            const totalCalCalc = calFromP + calFromC + calFromF;
            
            const pPct = totalCalCalc > 0 ? (calFromP / totalCalCalc) * 100 : 0;
            const cPct = totalCalCalc > 0 ? (calFromC / totalCalCalc) * 100 : 0;
            const fPct = totalCalCalc > 0 ? (calFromF / totalCalCalc) * 100 : 0;

            return (
                <div className="w-full px-4 mb-2">
                    <div className="flex justify-between text-xs text-gray-500 font-bold mb-1">
                        <span>ç‡Ÿé¤Šæ¯”ä¾‹</span>
                        <span className="font-mono">{Math.round(calories)} kcal</span>
                    </div>
                    <div className="h-3 w-full flex rounded-full overflow-hidden bg-gray-200 shadow-inner">
                        <div style={{ width: `${pPct}%` }} className="bg-red-500 transition-all duration-300"></div>
                        <div style={{ width: `${cPct}%` }} className="bg-yellow-500 transition-all duration-300"></div>
                        <div style={{ width: `${fPct}%` }} className="bg-blue-500 transition-all duration-300"></div>
                    </div>
                    <div className="flex justify-between text-[10px] font-mono mt-1 text-gray-400">
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-red-500"></div>P {Math.round(pPct)}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-yellow-500"></div>C {Math.round(cPct)}%</div>
                        <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-blue-500"></div>F {Math.round(fPct)}%</div>
                    </div>
                </div>
            );
        };

        const CurrentPlateAdvice = ({ tray }) => {
            if (tray.length === 0) return <div className="text-center text-gray-400 text-xs mt-2 h-6 flex items-center justify-center">è«‹é¸æ“‡é£Ÿç‰©æ”¾å…¥é¤ç›¤</div>;

            const totalCalories = tray.reduce((acc, f) => acc + (f.calories || 0), 0);
            const totalF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
            const totalC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
            const totalP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
            
            const fRatio = (totalF * 9) / (totalCalories || 1);
            const cRatio = (totalC * 4) / (totalCalories || 1);
            
            const warnings = [];
            
            if (fRatio > 0.45 && totalF > 12) warnings.push("ğŸ›¢ï¸æ²¹è„‚æ¯”ä¾‹åé«˜");
            if (cRatio > 0.65 && totalC > 30) warnings.push("ğŸšæ¾±ç²‰æ¯”ä¾‹éé‡");
            if (totalCalories > 800) warnings.push("ğŸ”¥ç†±é‡åé«˜");

            let displayContent = "";
            let colorClass = "text-gray-500";

            if (warnings.length > 0) {
                displayContent = warnings.join(" â€§ ");
                colorClass = "text-red-500 font-bold animate-pulse";
            } else {
                if (tray.length === 1 && totalCalories < 300) {
                    displayContent = "ğŸ’¡ å¤ªå–®èª¿å›‰ï¼Œå†å¤šé¸å¹¾æ¨£ä¸ä¸€æ¨£çš„ï¼";
                    colorClass = "text-blue-500";
                } else if (totalP > 25 && fRatio < 0.3) { 
                    displayContent = "ğŸ’ª å„ªè³ªè›‹ç™½ï¼å¾ˆæ£’çš„é¸æ“‡ï¼";
                    colorClass = "text-green-600 font-bold";
                } else {
                    displayContent = "âœ… ç‡Ÿé¤Šæ¯”ä¾‹é‚„ä¸éŒ¯ï¼Œç¹¼çºŒä¿æŒ";
                    colorClass = "text-gray-500";
                }
            }

            return <div className={`text-center text-xs mt-2 h-6 flex items-center justify-center ${colorClass} transition-all duration-300`}>{displayContent}</div>;
        };

        const FoodCard = ({ food, onClick, onInfo }) => {
            const getTags = () => {
                const t = [];
                const cal = food.calories;
                if (!cal) return t;
                const pRatio = (food.p * 4) / cal;
                const cRatio = (food.c * 4) / cal;
                const fRatio = (food.f * 9) / cal;
                if (pRatio > 0.2 && cRatio > 0.4 && food.health < 10) t.push({ text: "âš ï¸é«˜ç³–é™·é˜±", color: "text-white bg-red-500 border-red-600 font-bold" });
                if (fRatio >= 0.45 && food.f > 10) t.push({ text: "è¶…æ²¹è†©", color: "text-purple-700 bg-purple-100 border-purple-200" });
                else if (fRatio >= 0.35 && food.f > 10) t.push({ text: "æ²¹è†©", color: "text-blue-700 bg-blue-100 border-blue-200" });
                if (pRatio >= 0.30) t.push({ text: "é«˜è›‹ç™½", color: "text-red-700 bg-red-100 border-red-200" });
                else if (pRatio >= 0.20) t.push({ text: "è›‹ç™½", color: "text-red-600 bg-red-50 border-red-100" });
                if (cRatio >= 0.60) t.push({ text: "é«˜ç¢³æ°´", color: "text-yellow-700 bg-yellow-100 border-yellow-200" });
                if (food.health >= 15) t.push({ text: "å¥åº·", color: "text-green-700 bg-green-100 border-green-200" });
                if (food.mood >= 25) t.push({ text: "å¿«æ¨‚", color: "text-pink-700 bg-pink-100 border-pink-200" });
                if (cRatio < 0.2 && fRatio < 0.2) t.push({ text: "æ¸…æ·¡", color: "text-gray-600 bg-gray-100 border-gray-200" });
                return t.slice(0, 2); 
            };
            const tags = getTags();

            return (
                <button 
                    onClick={() => onClick(food)}
                    className="relative flex flex-col p-2 rounded-xl bg-white border-2 border-slate-100 hover:border-yellow-400 hover:shadow-lg transition-all active:scale-95 group text-left h-full shadow-sm overflow-hidden"
                >
                    <div className="absolute top-2 right-2 z-10">
                        <span className="text-[10px] text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded-full border border-gray-200">{food.calories} kcal</span>
                    </div>
                    <div className="w-full flex justify-center mt-8 mb-2">
                        <span className="text-4xl group-hover:scale-110 transition-transform filter drop-shadow-sm">{food.emoji}</span>
                    </div>
                    <span className="text-sm text-gray-800 font-bold w-full line-clamp-2 mb-1 leading-tight h-10 flex items-center justify-center text-center px-1">{food.name}</span>
                    <div className="flex flex-wrap gap-1 mb-2 h-5 content-center justify-center w-full">
                        {tags.map((tag, i) => (
                            <span key={i} className={`text-[9px] px-1.5 py-0.5 rounded border font-medium ${tag.color}`}>
                                {tag.text}
                            </span>
                        ))}
                    </div>
                    <div className="w-full grid grid-cols-3 gap-1 text-[9px] font-mono text-gray-500 mt-auto bg-slate-50 p-1 rounded text-center">
                        <div className="text-red-500 font-bold">P:{Math.round(food.p)}</div>
                        <div className="text-yellow-600 font-bold">C:{Math.round(food.c)}</div>
                        <div className="text-blue-500 font-bold">F:{Math.round(food.f)}</div>
                    </div>
                </button>
            );
        };

        // --- æ–°å¢ï¼šé¤å»³æŠ˜ç–Šé¸å–®å…ƒä»¶ ---
        const RestaurantAccordion = ({ foods, onAdd }) => {
            const [openRestaurant, setOpenRestaurant] = useState(null); // 'éº¥ç•¶å‹', 'é‡Œæ´‹çƒ˜ç„™', etc.

            // 1. å–å¾—æ‰€æœ‰é¤å»³åç¨± (ä¸é‡è¤‡)
            const restaurants = useMemo(() => {
                const names = foods.map(f => f.restaurant || 'å…¶ä»–');
                return [...new Set(names)];
            }, [foods]);

            const toggleRestaurant = (name) => {
                if (openRestaurant === name) {
                    setOpenRestaurant(null); // é—œé–‰
                } else {
                    setOpenRestaurant(name); // é–‹å•Ÿ
                }
            };

            return (
                <div className="w-full space-y-3 pb-8 min-h-[101%]"> {/* Added min-h-[101%] to force scroll */}
                    {restaurants.map(restName => {
                        const isOpen = openRestaurant === restName;
                        const restFoods = foods.filter(f => (f.restaurant || 'å…¶ä»–') === restName);
                        
                        return (
                            <div key={restName} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300">
                                <button 
                                    onClick={() => toggleRestaurant(restName)}
                                    className={`w-full flex justify-between items-center p-4 text-left font-bold text-gray-800 hover:bg-gray-50 transition-colors ${isOpen ? 'bg-gray-50' : ''}`}
                                >
                                    <div className="flex items-center gap-2">
                                        <span className="text-xl">
                                            {restName.includes('éº¥ç•¶å‹') ? 'ğŸ”' : 
                                             restName.includes('é‡Œæ´‹') ? 'ğŸ' :
                                             restName.includes('é£Ÿäº‹å ´') ? 'ğŸ›' :
                                             restName.includes('è›‹ç™½') ? 'ğŸ’ª' :
                                             restName.includes('ç³§æ™¨') ? 'ğŸ³' :
                                             restName.includes('å››æµ·') ? 'ğŸ¥Ÿ' :
                                             restName.includes('æ°´é›²æœµ') ? 'ğŸ§‹' : 
                                             restName.includes('å“è»’') ? 'ğŸ±' : 
                                             restName.includes('è·¯æ˜“è') ? 'â˜•' :
                                             restName.includes('é¾å¾·') ? 'ğŸ¥©' :
                                             restName.includes('å°è”¬æ­') ? 'ğŸ¥¬' :
                                             restName.includes('SUBWAY') ? 'ğŸ¥ª' :
                                             restName.includes('æ›‰é¹¿') ? 'ğŸ²' :
                                             restName.includes('è«å‡¡å½¼') ? 'ğŸ' :
                                             restName.includes('æ¤°æ—') ? 'ğŸ—' :
                                             restName.includes('æ¯”å¸å¤š') ? 'ğŸ”' :
                                             restName.includes('å£¹ç•ªå±‹') ? 'ğŸ›' :
                                             restName.includes('å¤å¨å¤·') ? 'ğŸš' : 'ğŸ½ï¸'}
                                        </span>
                                        <span>{restName}</span>
                                        <span className="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{restFoods.length}</span>
                                    </div>
                                    <div className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}>
                                        <Icons.ChevronDown />
                                    </div>
                                </button>
                                
                                <div className={`grid grid-cols-2 gap-3 p-3 bg-gray-50 border-t border-gray-100 transition-all duration-300 ${isOpen ? 'max-h-[5000px] opacity-100' : 'max-h-0 opacity-0 hidden'}`}>
                                    {restFoods.map(food => (
                                        <FoodCard key={food.id} food={food} onClick={() => onAdd(food)} onInfo={() => {}} />
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const RoundPlate = ({ tray, onRemove }) => {
            const slots = [0, 1, 2, 3, 4, 5]; 
            const totalP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
            const totalC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
            const totalF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
            const totalCalories = tray.reduce((acc, f) => acc + (f.calories || 0), 0);

            return (
                <div className="flex flex-col items-center mb-2">
                    <div className="plate-container">
                        <div className="absolute inset-0 border-4 border-dashed border-gray-200 rounded-full opacity-50 m-2"></div>
                        
                        <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center bg-white/95 rounded-full w-24 h-24 shadow-md z-0 pointer-events-none border border-gray-100 p-1">
                            <span className="text-[10px] text-gray-400 mb-0.5 font-bold">æœ¬é¤çµ±è¨ˆ</span>
                            <div className="flex items-center gap-1 text-xs font-mono mb-1">
                                <span className="text-gray-700 font-bold">{Math.round(totalCalories)}</span> 
                                <span className="text-[8px] text-gray-400">kcal</span>
                            </div>
                            <div className="w-full px-2 space-y-0.5">
                                <div className="flex justify-between text-[8px] text-red-500 font-bold"><span>P</span><span>{Math.round(totalP)}g</span></div>
                                <div className="flex justify-between text-[8px] text-yellow-500 font-bold"><span>C</span><span>{Math.round(totalC)}g</span></div>
                                <div className="flex justify-between text-[8px] text-blue-500 font-bold"><span>F</span><span>{Math.round(totalF)}g</span></div>
                            </div>
                        </div>

                        {slots.map((slotIndex) => {
                            const food = tray[slotIndex];
                            return (
                                <div 
                                    key={slotIndex} 
                                    className={`plate-slot slot-${slotIndex} cursor-pointer hover:bg-black/5 rounded-full z-10`}
                                    onClick={() => food && onRemove(slotIndex)}
                                >
                                    {food ? (
                                        <div className="flex flex-col items-center pop-in relative group">
                                            <span className="text-4xl drop-shadow-lg filter transition-transform transform group-hover:scale-105 duration-200">{food.emoji}</span>
                                            {/* X ç–ŠåŠ å±¤ */}
                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-white/60 backdrop-blur-[1px] rounded-full duration-200">
                                                <div className="text-red-500 w-8 h-8 drop-shadow-md">
                                                    <Icons.X />
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="w-10 h-10 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center opacity-40 hover:opacity-80 transition-opacity hover:scale-110 hover:border-yellow-400">
                                            <span className="text-lg text-gray-300">+</span>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onComplete }) => {
            const [gender, setGender] = useState('male');
            const [age, setAge] = useState('20');
            const [height, setHeight] = useState('170');
            const [weight, setWeight] = useState('65');
            const [activityLevel, setActivityLevel] = useState(1.375);
            const [error, setError] = useState(""); 
            const activityOptions = [
                { value: 1.2, label: "ä¹…å", desc: "å¹¾ä¹ä¸é‹å‹•" },
                { value: 1.375, label: "è¼•åº¦", desc: "æ¯é€±é‹å‹• 1-3 å¤©" },
                { value: 1.55, label: "ä¸­åº¦", desc: "æ¯é€±é‹å‹• 3-5 å¤©" },
                { value: 1.725, label: "é«˜åº¦", desc: "æ¯é€±é‹å‹• 6-7 å¤©" },
                { value: 1.9, label: "è¶…ç´š", desc: "æ¯å¤©å…©ç·´/å‹åŠ›å·¥ä½œ" },
            ];
            const handleSubmit = (e) => {
                e.preventDefault();
                
                const numAge = parseFloat(age);
                const numHeight = parseFloat(height);
                const numWeight = parseFloat(weight);

                if (!age || isNaN(numAge) || numAge < 10 || numAge > 100) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„å¹´é½¡ (10 - 100æ­²)"); return; }
                if (!height || isNaN(numHeight) || numHeight < 50 || numHeight > 250) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„èº«é«˜ (50 - 250å…¬åˆ†)"); return; }
                if (!weight || isNaN(numWeight) || numWeight < 20 || numWeight > 300) { setError("âš ï¸ è«‹è¼¸å…¥åˆç†çš„é«”é‡ (20 - 300å…¬æ–¤)"); return; }
                setError(""); 
                
                const tdee = calculateStats(gender, numAge, numHeight, numWeight, activityLevel);
                const proteinTarget = Math.round(numWeight * 2.0);
                onComplete({ isCustom: true, gender, age: numAge, height: numHeight, weight: numWeight, tdee, proteinTarget });
            };
            const handleSkip = () => { onComplete({ isCustom: false, gender: 'male', age: 20, height: 170, weight: 65, tdee: 2000, proteinTarget: 130 }); };
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-yellow-50 fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border-2 border-yellow-200 overflow-y-auto max-h-screen">
                        <div className="text-center mb-4"><div className="text-5xl mb-2">ğŸ“‹</div><h1 className="text-2xl font-bold text-gray-800">å…¥å­¸å¥åº·æª¢æŸ¥</h1><p className="text-sm text-gray-500 mt-1">è¼¸å…¥è³‡æ–™ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è¨ˆç®— TDEE èˆ‡ç‡Ÿé¤Šç›®æ¨™ã€‚</p></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {error && <div className="bg-red-50 text-red-500 text-xs p-2 rounded text-center font-bold animate-pulse">{error}</div>}
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">ç”Ÿç†æ€§åˆ¥</label><div className="flex gap-2"><button type="button" onClick={() => setGender('male')} className={`flex-1 py-2 rounded-lg border ${gender === 'male' ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>ç”·</button><button type="button" onClick={() => setGender('female')} className={`flex-1 py-2 rounded-lg border ${gender === 'female' ? 'bg-pink-100 border-pink-400 text-pink-700' : 'bg-gray-50 border-gray-200 text-gray-400'}`}>å¥³</button></div></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-700 mb-1">å¹´é½¡ (æ­²)</label>
                                    <input 
                                        type="number" 
                                        value={age} 
                                        onChange={(e) => setAge(e.target.value)} 
                                        onFocus={(e) => e.target.select()}
                                        className="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-yellow-400 outline-none transition-all" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-700 mb-1">é«”é‡ (kg)</label>
                                    <input 
                                        type="number" 
                                        value={weight} 
                                        onChange={(e) => setWeight(e.target.value)} 
                                        onFocus={(e) => e.target.select()}
                                        className="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-yellow-400 outline-none transition-all" 
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-700 mb-1">èº«é«˜ (cm)</label>
                                <input 
                                    type="number" 
                                    value={height} 
                                    onChange={(e) => setHeight(e.target.value)} 
                                    onFocus={(e) => e.target.select()}
                                    className="w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-yellow-400 outline-none transition-all" 
                                />
                            </div>
                            <div><label className="block text-xs font-bold text-gray-700 mb-1">æ¯é€±é‹å‹•é‡</label><div className="grid grid-cols-1 gap-1">{activityOptions.map((opt) => (<button key={opt.value} type="button" onClick={() => setActivityLevel(opt.value)} className={`py-2 px-3 rounded-lg border text-left flex justify-between items-center ${activityLevel === opt.value ? 'bg-yellow-100 border-yellow-400 text-yellow-800' : 'bg-white border-gray-200 text-gray-600'}`}><span className="font-bold text-sm">{opt.label}</span><span className="text-xs opacity-70">{opt.desc}</span></button>))}</div></div>
                            <button type="submit" className="w-full bg-yellow-400 text-black font-bold py-3 rounded-xl hover:bg-yellow-300 transition-colors shadow-md mt-4">é–‹å§‹ç”Ÿæˆåˆ†æå ±å‘Š</button>
                        </form>
                        <button onClick={handleSkip} className="w-full mt-3 text-gray-400 text-xs hover:text-gray-600 underline">ç•¥éï¼Œä½¿ç”¨é è¨­å€¼ (è·¯äººç”²)</button>
                    </div>
                </div>
            );
        };

        const AnalysisResult = ({ profile, onConfirm, onBack }) => {
            const dailyC = Math.round((profile.tdee * 0.5) / 4);
            const dailyP = Math.round((profile.tdee * 0.3) / 4);
            const dailyF = Math.round((profile.tdee * 0.2) / 9);
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden pop-in border-4 border-slate-800">
                        <div className="bg-slate-800 text-white p-4 text-center"><h2 className="text-xl font-bold">èº«é«”ç´ è³ªåˆ†æå ±å‘Š</h2><p className="text-xs text-slate-400">PERSONAL NUTRITION REPORT</p></div>
                        <div className="p-6 space-y-6">
                            <div className="text-center"><p className="text-sm text-gray-500 font-bold mb-1">æ‚¨çš„æ¯æ—¥ç¸½æ¶ˆè€—ç†±é‡ (TDEE)</p><div className="text-5xl font-black text-yellow-500 tracking-tighter">{profile.tdee} <span className="text-base font-normal text-gray-400">kcal</span></div><div className="text-xs text-gray-400 mt-1 bg-yellow-50 inline-block px-2 py-1 rounded">æ³¨æ„ï¼šéŠæˆ²ä¸­å–®é¤è¶…é {(profile.tdee * 0.5).toFixed(0)} kcal å³è¦–ç‚ºæš´é£Ÿ</div></div><hr className="border-gray-100"/>
                            <div><p className="text-xs text-gray-500 font-bold mb-3 text-center">å»ºè­°æ¯æ—¥æ”å–é‡ (C50/P30/F20)</p><div className="grid grid-cols-3 gap-3 text-center"><div className="bg-yellow-50 p-2 rounded-xl border border-yellow-100"><div className="text-xl font-bold text-yellow-600">{dailyC}g</div><div className="text-[10px] text-gray-500">ç¢³æ°´ 50%</div></div><div className="bg-red-50 p-2 rounded-xl border border-red-100"><div className="text-xl font-bold text-red-500">{dailyP}g</div><div className="text-[10px] text-gray-500">è›‹ç™½è³ª 30%</div></div><div className="bg-blue-50 p-2 rounded-xl border border-blue-100"><div className="text-xl font-bold text-blue-500">{dailyF}g</div><div className="text-[10px] text-gray-500">è„‚è‚ª 20%</div></div></div></div>
                            <div className="text-xs text-gray-400 text-center leading-relaxed">*é€™äº›æ•¸å€¼å°‡ç›´æ¥å½±éŸ¿éŠæˆ²é›£åº¦ã€‚<br/>è«‹åœ¨ã€Œäº«å—ç¾é£Ÿã€èˆ‡ã€Œç¶­æŒæ•¸å€¼ã€é–“å–å¾—å¹³è¡¡ï¼</div>
                            <div className="flex gap-3"><button onClick={onBack} className="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-200 transition-colors">è¿”å›ä¿®æ”¹</button><button onClick={onConfirm} className="flex-[2] bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-700 transition-colors shadow-lg flex items-center justify-center gap-2"><span>é€²å…¥éŠæˆ²</span><div className="w-4 h-4"><Icons.ArrowRight /></div></button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const FoodInfoModal = ({ food, onClose }) => {
            if (!food) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative" onClick={e=>e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400"><div className="w-6 h-6"><Icons.X/></div></button>
                        <div className="text-center">
                            <div className="text-6xl mb-4">{food.emoji}</div>
                            <h3 className="text-2xl font-bold mb-2">{food.name}</h3>
                            <div className="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-mono mb-4">{food.calories} kcal</div>
                            <p className="text-gray-600 text-sm leading-relaxed mb-6 bg-yellow-50 p-4 rounded-xl border border-yellow-100 text-left">{food.desc || "æš«ç„¡æè¿°"}</p>
                            <div className="grid grid-cols-3 gap-3 text-sm font-mono">
                                <div className="bg-red-50 p-3 rounded-xl"><div className="text-red-500 font-bold text-xl">{food.p}g</div><div className="text-[10px] text-gray-500">è›‹ç™½è³ª</div></div>
                                <div className="bg-yellow-50 p-3 rounded-xl"><div className="text-yellow-600 font-bold text-xl">{food.c}g</div><div className="text-[10px] text-gray-500">ç¢³æ°´</div></div>
                                <div className="bg-blue-50 p-3 rounded-xl"><div className="text-blue-500 font-bold text-xl">{food.f}g</div><div className="text-[10px] text-gray-500">è„‚è‚ª</div></div>
                            </div>
                        </div>
                        <button onClick={onClose} className="w-full bg-gray-100 text-gray-600 py-3 font-bold hover:bg-gray-200 transition-colors">é—œé–‰</button>
                    </div>
                </div>
            );
        };

        const TutorialFeedbackModal = ({ feedback, onClose, onRetry, onNext, onBack }) => {
            if (!feedback) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative text-center" onClick={e=>e.stopPropagation()}>
                        <div className="text-6xl mb-4">{feedback.isCorrect ? 'ğŸ‰' : 'âŒ'}</div>
                        <h3 className={`text-2xl font-bold mb-2 ${feedback.isCorrect ? 'text-green-600' : 'text-red-600'}`}>{feedback.title}</h3>
                        <p className="text-gray-600 mb-6">{feedback.desc}</p>
                        <div className="space-y-3">
                            {feedback.isCorrect ? (
                                <button onClick={onNext} className="w-full bg-green-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-600 transition-transform active:scale-95">å®ŒæˆæŒ‘æˆ°</button>
                            ) : (
                                <button onClick={onRetry} className="w-full bg-red-100 text-red-600 py-3 rounded-xl font-bold hover:bg-red-200 transition-colors">æ¸…ç©ºé‡è©¦</button>
                            )}
                            <button onClick={onBack} className="w-full bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">è¿”å›é—œå¡åˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- ä¿®æ”¹ï¼šè©³ç´°äººæ ¼å ±å‘Šæ¨¡æ…‹è¦–çª— (ä¿®å¾©åœ–ç‰‡è®Šå½¢ + æ¨¡ç³Šæ¶ˆå¤±å•é¡Œ + èª¿æ•´æ’ç‰ˆ) ---
        const PersonaDetailModal = ({ persona, onClose }) => {
            if (!persona) return null;
            const details = persona.details;

            // è¼”åŠ©å‡½å¼ï¼šæ ¹æ“šé£¯å‹åå­—æ‰¾åœ–ç‰‡
            const getPartnerData = (text) => {
                if (!text) return null;
                const name = text.split('ï½œ')[0]; 
                const desc = text.split('ï½œ')[1]; 
                const partner = personaDatabase.find(p => p.name === name);
                return { name, desc, image: partner?.image, emoji: partner?.emoji };
            };

            const partners = {
                best: getPartnerData(details.partners.best),
                bad: getPartnerData(details.partners.bad),
            };

            const handleShare = async (e) => {
                const btn = e.currentTarget;
                const originalText = btn.innerText;
                btn.innerText = "ç”Ÿæˆå ±å‘Šä¸­...";
                btn.disabled = true;

                // Fix: ID must match the rendered JSX
                const element = document.getElementById('share-card');
                if (!element) return;
                
                if (!window.html2canvas) {
                    alert("ç¹ªåœ–å·¥å…·è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...");
                    btn.innerText = originalText;
                    btn.disabled = false;
                    return;
                }

                try {
                    // 1. è¤‡è£½ DOM
                    const clone = element.cloneNode(true);
                    
                    // 2. è¨­å®šæ¨£å¼ï¼šå¯¬åº¦è¨­ç‚º 375px (æ¨™æº–æ‰‹æ©Ÿå¯¬åº¦)ï¼Œç¢ºä¿æ¯”ä¾‹æ¥è¿‘ 9:16
                    Object.assign(clone.style, {
                        width: '375px', 
                        height: 'auto',
                        position: 'absolute',
                        top: '-9999px',
                        left: '-9999px',
                        zIndex: '-1',
                        backgroundColor: '#ffffff'
                    });

                    // --- 3. å¤–ç§‘æ‰‹è¡“ä¿®æ­£ï¼šä¿®å¾©åœ–ç‰‡è®Šå½¢èˆ‡æ¨¡ç³Šæ¶ˆå¤± ---
                    
                    // (A) ä¿®å¾©åœ–ç‰‡è®Šå½¢ï¼šå°‡ img è½‰ç‚º background-image div
                    const images = clone.querySelectorAll('img');
                    images.forEach(img => {
                        const div = document.createElement('div');
                        // è¤‡è£½åŸæœ¬ img çš„ class (ä¿ç•™å°ºå¯¸è¨­å®š w-32 h-32 ç­‰)
                        div.className = img.className; 
                        // å¼·åˆ¶è¦†è“‹é¡¯ç¤ºæ¨£å¼
                        Object.assign(div.style, {
                            backgroundImage: `url(${img.src})`,
                            backgroundSize: 'contain', // é—œéµï¼šä½¿ç”¨ contain ä¿æŒæ¯”ä¾‹
                            backgroundPosition: 'center',
                            backgroundRepeat: 'no-repeat',
                            display: 'block'
                        });
                        // ç§»é™¤å¯èƒ½å½±éŸ¿æ’ç‰ˆçš„ class
                        div.classList.remove('object-contain'); 
                        img.parentNode.replaceChild(div, img);
                    });

                    // (B) ä¿®å¾©æ¨¡ç³Šæ¶ˆå¤± & ç§»é™¤å‹•ç•«ï¼šå°‡ blur filter æ”¹ç‚º radial-gradient
                    const blobs = clone.querySelectorAll('.animate-blob');
                    blobs.forEach(blob => {
                        blob.classList.remove('animate-blob'); // åœæ­¢å‹•ç•«
                        blob.classList.remove('filter');       // ç§»é™¤æ¿¾é¡
                        blob.classList.remove('blur-xl');
                        blob.classList.remove('mix-blend-multiply');
                        
                        // è®€å–åŸæœ¬çš„é¡è‰² (yellow æˆ– pink)
                        const isYellow = blob.classList.contains('bg-yellow-300');
                        const color = isYellow ? '253, 224, 71' : '249, 168, 212'; // Tailwind yellow-300 / pink-300 rgb
                        
                        // æ”¹ç”¨æ¼¸å±¤æ¨¡æ“¬æ¨¡ç³Š (Canvas æ”¯æ´åº¦æ¥µä½³)
                        blob.style.background = `radial-gradient(circle, rgba(${color}, 0.6) 0%, rgba(${color}, 0) 70%)`;
                        blob.style.opacity = '1'; // ç¢ºä¿å¯è¦‹
                    });

                    // (C) ç§»é™¤å…¶ä»–å‹•ç•«
                    const bounces = clone.querySelectorAll('.animate-bounce');
                    bounces.forEach(el => el.classList.remove('animate-bounce'));

                    document.body.appendChild(clone);

                    // 4. æˆªåœ–
                    const canvas = await window.html2canvas(clone, { 
                        scale: 3, 
                        useCORS: true,
                        backgroundColor: "#ffffff"
                    });
                    
                    document.body.removeChild(clone);

                    // 5. åˆ†äº«æµç¨‹
                    canvas.toBlob(async (blob) => {
                        if (!blob) {
                            alert("åœ–ç‰‡ç”Ÿæˆå¤±æ•—");
                            return;
                        }
                        const file = new File([blob], `æ–°ç”Ÿé£Ÿä»£_${persona.name}.png`, { type: "image/png" });

                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: 'æ–°ç”Ÿé£Ÿä»£ï¼šäººæ ¼è¦ºé†’',
                                    text: `æˆ‘æ˜¯ã€Œ${persona.name}ã€ï¼å¿«ä¾†æ¸¬æ¸¬ä½ çš„é£²é£Ÿäººæ ¼å§ï¼`,
                                });
                            } catch (shareError) {
                                console.log("åˆ†äº«å–æ¶ˆ");
                            }
                        } else {
                            const link = document.createElement('a');
                            link.href = canvas.toDataURL('image/png');
                            link.download = `æ–°ç”Ÿé£Ÿä»£_${persona.name}.png`;
                            link.click();
                            alert("åœ–ç‰‡å·²ä¸‹è¼‰ï¼è«‹æ‰‹å‹•ä¸Šå‚³åˆ°ç¤¾ç¾¤è»Ÿé«”ã€‚");
                        }

                        btn.innerText = originalText;
                        btn.disabled = false;
                    }, 'image/png');

                } catch (err) {
                    console.error(err);
                    alert("åˆ†äº«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 fade-in" onClick={onClose}>
                    <div className="w-full max-w-sm max-h-[90vh] overflow-y-auto no-scrollbar relative" onClick={e => e.stopPropagation()}>
                        
                        <button onClick={onClose} className="fixed top-4 right-4 z-50 bg-black/50 text-white p-2 rounded-full hover:bg-black/70"><Icons.X /></button>

                        {/* --- share-card å€åŸŸ --- */}
                        <div id="share-card" className="bg-gradient-to-br from-orange-50 to-yellow-100 rounded-2xl overflow-hidden shadow-2xl border-4 border-white">
                            
                            {/* é ­éƒ¨ (ç¸®æ¸›é«˜åº¦) */}
                            <div className="pt-5 pb-3 text-center bg-white/60 backdrop-blur-sm relative overflow-hidden">
                                {/* è£é£¾åœ“çƒ (Blobs) */}
                                <div className="absolute top-[-50px] right-[-50px] w-40 h-40 bg-yellow-300 rounded-full animate-blob"></div>
                                <div className="absolute top-[-50px] left-[-50px] w-40 h-40 bg-pink-300 rounded-full animate-blob animation-delay-2000"></div>
                                
                                <div className="relative z-10 mb-2 flex justify-center">
                                    {persona.image && persona.image.length > 0 ? (
                                        <img src={persona.image} alt={persona.name} className="w-28 h-28 object-contain drop-shadow-2xl" />
                                    ) : (
                                        <div className="text-7xl animate-bounce">{persona.emoji}</div>
                                    )}
                                </div>
                                <div className="relative z-10">
                                    <span className="bg-black text-white text-[10px] px-2 py-1 rounded-full font-bold tracking-widest uppercase mb-1 inline-block">Food Persona</span>
                                    <h3 className={`text-2xl font-black mb-1 text-gray-800`}>{persona.name}</h3>
                                    <div className="px-4 italic text-gray-600 font-serif text-[10px] leading-relaxed">
                                        "{details.slogan}"
                                    </div>
                                </div>
                            </div>

                            {/* å…§å®¹å€ (ç·Šæ¹ŠåŒ–) */}
                            <div className="p-4 space-y-2">
                                {/* ç‰¹å¾µ (æ–‡å­—é å·¦) */}
                                <div className="bg-white/80 p-2.5 rounded-xl shadow-sm text-left">
                                    <h4 className="font-black text-gray-800 mb-1 flex items-center gap-1.5 text-xs"><span className="text-sm">ğŸ”</span> é£²é£Ÿè¡Œç‚ºç‰¹å¾µ</h4>
                                    <ul className="list-disc list-outside ml-3.5 text-[10px] text-gray-600 space-y-0.5 leading-tight">
                                        {details.traits.map((trait, i) => <li key={i}>{trait}</li>)}
                                    </ul>
                                </div>

                                {/* ç­–ç•¥èˆ‡å‡ç´š */}
                                <div className="bg-white/80 p-2.5 rounded-xl shadow-sm border-l-4 border-green-400 text-left">
                                    <h4 className="font-black text-gray-800 mb-1 flex items-center gap-1.5 text-xs"><span className="text-sm">ğŸŒ±</span> å°æ­¥ç­–ç•¥</h4>
                                    <div className="space-y-1">
                                        {details.strategy.map((strat, i) => (
                                            <div key={i} className="flex gap-1.5 items-start text-[10px] text-gray-600 leading-tight">
                                                <div className="mt-1 min-w-[3px] h-[3px] rounded-full bg-green-400"></div>
                                                <span>{strat}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* é£¯å‹ (æ”¹ç‚ºå…©æ¬„ä¸¦æ’ä»¥é¡¯ç¤ºå…©å€‹) */}
                                <div>
                                    <h4 className="font-black text-gray-800 mb-1.5 flex items-center gap-1.5 text-xs"><span className="text-sm">ğŸ¤</span> é£¯å‹é…å°</h4>
                                    <div className="grid grid-cols-2 gap-2">
                                        {/* Best Partner */}
                                        {partners.best ? (
                                            <div className="bg-white/90 p-2 rounded-xl flex flex-col gap-1.5 shadow-sm ring-1 ring-pink-100 items-center text-center">
                                                <div className="w-8 h-8 bg-pink-50 rounded-full flex items-center justify-center flex-shrink-0 text-lg border border-pink-200 overflow-hidden">
                                                    {partners.best.image ? <img src={partners.best.image} className="w-full h-full object-contain"/> : partners.best.emoji}
                                                </div>
                                                <div>
                                                    <div className="inline-block text-[8px] text-white bg-pink-400 px-1.5 py-0.5 rounded font-bold uppercase mb-0.5">Best</div>
                                                    <div className="font-bold text-gray-800 text-[10px] whitespace-nowrap overflow-hidden text-ellipsis max-w-full">{partners.best.name}</div>
                                                    <div className="text-[8px] text-gray-500 leading-tight mt-0.5 line-clamp-2 text-left">{partners.best.desc}</div>
                                                </div>
                                            </div>
                                        ) : <div className="hidden"></div>}
                                        
                                        {/* Bad Partner */}
                                        {partners.bad ? (
                                            <div className="bg-white/90 p-2 rounded-xl flex flex-col gap-1.5 shadow-sm ring-1 ring-gray-200 items-center text-center">
                                                <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center flex-shrink-0 text-lg border border-gray-200 overflow-hidden">
                                                     {partners.bad.image ? <img src={partners.bad.image} className="w-full h-full object-contain"/> : partners.bad.emoji}
                                                </div>
                                                <div>
                                                    <div className="inline-block text-[8px] text-white bg-gray-400 px-1.5 py-0.5 rounded font-bold uppercase mb-0.5">Avoid</div>
                                                    <div className="font-bold text-gray-800 text-[10px] whitespace-nowrap overflow-hidden text-ellipsis max-w-full">{partners.bad.name}</div>
                                                    <div className="text-[8px] text-gray-500 leading-tight mt-0.5 line-clamp-2 text-left">{partners.bad.desc}</div>
                                                </div>
                                            </div>
                                        ) : <div className="hidden"></div>}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-gray-900 p-2 text-center">
                                <p className="text-white text-[9px] font-bold tracking-widest opacity-80">æ–°ç”Ÿé£Ÿä»£ï¼šäººæ ¼è¦ºé†’</p>
                                <p className="text-gray-500 text-[8px]">å°å¤§æ ¡åœ’é£²é£Ÿæ¨å»£è¨ˆç•«</p>
                            </div>
                        </div>

                        <div className="mt-4 sticky bottom-4 z-50">
                            <button onClick={handleShare} className="w-full bg-gradient-to-r from-pink-500 to-orange-500 text-white py-3.5 rounded-xl font-bold shadow-lg hover:brightness-110 active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                <span>ä¸‹è¼‰å ±å‘Š</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState("HOME"); 
            const [userProfile, setUserProfile] = useState(null);
            const [currentStage, setCurrentStage] = useState(null);
            const [currentSubLevel, setCurrentSubLevel] = useState(null); 
            const [storyMealIndex, setStoryMealIndex] = useState(0); 
            const [dailyStats, setDailyStats] = useState({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
            const [unlockedPersonas, setUnlockedPersonas] = useState([]); 
            const [tray, setTray] = useState([]);
            const [selectedFoodInfo, setSelectedFoodInfo] = useState(null);
            const [tutorialFeedback, setTutorialFeedback] = useState(null); 
            const [selectedPersona, setSelectedPersona] = useState(null); 
            const [storyModalOpen, setStoryModalOpen] = useState(false);
            const [eatenFoods, setEatenFoods] = useState([]); 
            const [isHeaderShrunk, setIsHeaderShrunk] = useState(false);
            const touchStart = useRef(0);
            const startScrollTop = useRef(0);

            const addFood = (food) => {
                if (tray.length < 6) {
                    setTray([...tray, food]);
                }
            };
            
            const removeFromTray = (index) => {
                const newTray = [...tray];
                newTray.splice(index, 1);
                setTray(newTray);
            };

            const unlockPersona = (personaId) => {
                if (!unlockedPersonas.includes(personaId)) {
                    setUnlockedPersonas([...unlockedPersonas, personaId]);
                }
            };

            const startLevel = (stageKey) => {
                const stage = stages[stageKey];
                setCurrentStage(stage);
                setTray([]);
                setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
                setEatenFoods([]); // Reset
                setIsHeaderShrunk(false);
                
                if (stage.type === 'tutorial_menu') {
                    setGameState("TUTORIAL_MENU");
                } else if (stage.type === 'meal') {
                    setGameState("WARMUP_PLAY");
                } else if (stage.type === 'story_menu') { 
                     setGameState("STORY_MENU");
                } else if (stage.type === 'story') {
                    setStoryMealIndex(0);
                    setGameState("STORY_PLAY");
                    setStoryModalOpen(true);
                }
            };

            const startSubLevel = (subLevel) => {
                setCurrentSubLevel(subLevel);
                setTray([]);
                
                if (currentStage.id === 'TUTORIAL') {
                    setGameState("TUTORIAL_PLAY");
                } else if (currentStage.id === 'STORY') {
                    setStoryMealIndex(0);
                    setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 }); 
                    setEatenFoods([]); // Reset
                    setGameState("STORY_PLAY");
                    setStoryModalOpen(true);
                }
            };

            const calculateDailyStatsFromMeals = (meals) => {
                let stats = { health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 };
                meals.forEach(meal => {
                    meal.forEach(f => {
                        stats.calories += f.calories;
                        stats.totalP += f.p;
                        stats.totalC += f.c;
                        stats.totalF += f.f;
                        stats.health = Math.min(100, Math.max(0, stats.health + (f.health || 0)));
                        stats.mood = Math.min(100, Math.max(0, stats.mood + (f.mood || 0)));
                    });
                });
                return stats;
            };

            const confirmMeal = () => {
                if (tray.length === 0) return;

                const mP = tray.reduce((a, f) => a + f.p, 0); const mC = tray.reduce((a, f) => a + f.c, 0); const mF = tray.reduce((a, f) => a + f.f, 0); const mCal = tray.reduce((a, f) => a + f.calories, 0);
                const currentStats = { calories: mCal, totalP: mP, totalC: mC, totalF: mF };

                if (gameState === "TUTORIAL_PLAY") {
                    if (currentSubLevel && currentSubLevel.criteria(currentStats)) {
                        setTutorialFeedback({ isCorrect: true, title: "æŒ‘æˆ°æˆåŠŸï¼", desc: currentSubLevel.successMsg });
                    } else {
                        setTutorialFeedback({ isCorrect: false, title: "æŒ‘æˆ°å¤±æ•—", desc: currentSubLevel.failMsg });
                    }
                    return; 
                }

                // Story / Warmup logic: accumulate meal history
                const newMeals = [...eatenFoods, tray];
                const newStats = calculateDailyStatsFromMeals(newMeals);
                
                setEatenFoods(newMeals);
                setDailyStats(newStats); 
                setTray([]);

                if (gameState === "WARMUP_PLAY") { setGameState("WARMUP_RESULT"); } 
                else if (gameState === "STORY_PLAY") { 
                    if (storyMealIndex < 2) { 
                        setStoryMealIndex(storyMealIndex + 1); 
                        setStoryModalOpen(true);
                    } else { 
                        const personaId = calculatePersona(newStats, userProfile?.tdee); 
                        unlockPersona(personaId); 
                        setGameState("RESULT"); 
                    } 
                }
            };

            const handlePreviousMeal = () => {
                if (storyMealIndex > 0) {
                    const newMeals = eatenFoods.slice(0, -1);
                    setEatenFoods(newMeals);
                    setDailyStats(calculateDailyStatsFromMeals(newMeals));
                    setStoryMealIndex(storyMealIndex - 1);
                    setStoryModalOpen(true); // Re-open the story modal to show context
                }
            };

            const handleOnboardingComplete = (profile) => { setUserProfile(profile); setGameState("ANALYSIS"); };

            if (gameState === "HOME") {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-yellow-50 to-orange-100 fade-in">
                        <div className="text-center mb-10">
                            <div className="text-8xl mb-4 animate-bounce">ğŸ±</div>
                            <h1 className="text-5xl font-black text-gray-800 tracking-tight mb-4 drop-shadow-sm">
                                æ–°ç”Ÿ<span className="text-orange-500">é£Ÿä»£</span>
                            </h1>
                            <p className="text-xl text-gray-600 font-bold tracking-widest">äººæ ¼è¦ºé†’</p>
                        </div>
                        
                        <button 
                            onClick={() => setGameState("ONBOARDING")}
                            className="w-full max-w-xs bg-gray-900 text-white text-xl font-bold py-4 rounded-2xl shadow-xl hover:bg-gray-800 hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3"
                        >
                            <span>é–‹å§‹é«”æª¢</span>
                            <Icons.ArrowRight />
                        </button>
                        
                        <p className="mt-8 text-sm text-gray-400">åƒå¾—é£½ä¹Ÿè¦åƒçš„å¥åº·</p>
                    </div>
                );
            }

            if (gameState === "ONBOARDING") { return <Onboarding onComplete={handleOnboardingComplete} />; }
            if (gameState === "ANALYSIS") { return <AnalysisResult profile={userProfile} onConfirm={() => setGameState("STAGES")} onBack={() => setGameState("ONBOARDING")} />; }

            if (gameState === "MENU" || gameState === "STAGES") {
                return (
                    <div className="min-h-screen p-6 bg-gradient-to-br from-yellow-50 to-orange-100 flex flex-col items-center justify-center fade-in relative">
                        <div className="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-10">
                            <button onClick={() => setGameState("ONBOARDING")} className="bg-white/80 backdrop-blur px-3 py-2 rounded-lg text-xs font-bold text-gray-600 shadow-sm hover:bg-white flex items-center gap-2"><div className="w-4 h-4"><Icons.Refresh /></div> é‡æ¸¬</button>
                            <button onClick={() => setGameState("GALLERY")} className="bg-white/80 backdrop-blur px-3 py-2 rounded-lg text-gray-700 shadow-sm hover:bg-yellow-100 hover:text-yellow-700 transition-colors flex items-center gap-2"><div className="w-5 h-5"><Icons.Book /></div><span className="text-xs font-bold">åœ–é‘‘</span></button>
                        </div>
                        
                        <div className="text-center mb-10 z-10">
                            <h1 className="text-5xl font-black text-gray-800 tracking-tight mb-2 drop-shadow-sm">æ–°ç”Ÿ<span className="text-orange-500">é£Ÿä»£</span></h1>
                            <p className="text-gray-600 font-medium">åƒå¾—é£½ä¹Ÿè¦åƒçš„å¥åº·</p>
                        </div>

                        <div className="w-full max-w-sm grid gap-4 z-10">
                            <button onClick={() => startLevel('TUTORIAL')} className="group relative w-full bg-white p-6 rounded-2xl shadow-lg border border-blue-100 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 overflow-hidden">
                                <div className="absolute top-0 left-0 w-2 h-full bg-blue-500 group-hover:w-full transition-all duration-500 opacity-10"></div>
                                <div className="relative flex items-center gap-4">
                                    <div className="text-4xl bg-blue-50 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ”°</div>
                                    <div className="text-left">
                                        <div className="font-bold text-xl text-gray-800 group-hover:text-blue-600 transition-colors">ç‡Ÿé¤Šæ–°æ‰‹æ‘</div>
                                        <div className="text-sm text-gray-500">å¯¦æˆ°æ¼”ç·´ï¼Œæ‰¾å‡ºç›®æ¨™ç‡Ÿé¤Šï¼</div>
                                    </div>
                                </div>
                            </button>

                            <button onClick={() => startLevel('WARMUP')} className="group relative w-full bg-white p-6 rounded-2xl shadow-lg border border-green-100 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 overflow-hidden">
                                <div className="absolute top-0 left-0 w-2 h-full bg-green-500 group-hover:w-full transition-all duration-500 opacity-10"></div>
                                <div className="relative flex items-center gap-4">
                                    <div className="text-4xl bg-green-50 p-3 rounded-xl group-hover:scale-110 transition-transform">âš”ï¸</div>
                                    <div className="text-left">
                                        <div className="font-bold text-xl text-gray-800 group-hover:text-green-600 transition-colors">è‡ªç”±é£Ÿç¿’</div>
                                        <div className="text-sm text-gray-500">Stage 1ï¼šç·´ç¿’åƒä¸€é¤ (ç„¡é™åˆ¶)</div>
                                    </div>
                                </div>
                            </button>

                            <button onClick={() => startLevel('STORY')} className="group relative w-full bg-white p-6 rounded-2xl shadow-lg border border-purple-100 hover:shadow-xl hover:scale-[1.02] transition-all duration-300 overflow-hidden">
                                <div className="absolute top-0 left-0 w-2 h-full bg-purple-500 group-hover:w-full transition-all duration-500 opacity-10"></div>
                                <div className="relative flex items-center gap-4">
                                    <div className="text-4xl bg-purple-50 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ†</div>
                                    <div className="text-left">
                                        <div className="font-bold text-xl text-gray-800 group-hover:text-purple-600 transition-colors">ä¸€æ—¥ç”Ÿå­˜æˆ°</div>
                                        <div className="text-sm text-gray-500">Stage 2ï¼šæŒ‘æˆ°ä¸€æ—¥ä¸‰é¤ï¼Œè§£é–äººæ ¼ï¼</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === "TUTORIAL_MENU") {
                return (
                    <div className="min-h-screen p-6 bg-blue-50 flex flex-col items-center justify-center text-center fade-in">
                        <div className="w-full max-w-sm">
                            <div className="mb-8">
                                <span className="text-6xl mb-2 block">ğŸ“</span>
                                <h2 className="text-3xl font-black text-blue-900">ç‡Ÿé¤Šæ–°æ‰‹æ‘</h2>
                                <p className="text-blue-600/70 text-sm mt-2">é¸æ“‡ä¸€å€‹èª²é¡Œé–‹å§‹ä½ çš„ä¿®ç·´</p>
                            </div>
                            
                            <div className="grid gap-4">
                                {stages.TUTORIAL.subLevels.map(level => (
                                    <button 
                                        key={level.id}
                                        onClick={() => startSubLevel(level)}
                                        className="w-full bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border-2 border-transparent hover:border-blue-300 transition-all group relative overflow-hidden"
                                    >
                                        <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                                        <div className="relative flex flex-col items-start text-left">
                                            <div className="font-bold text-lg text-gray-800 mb-1 group-hover:text-blue-600">{level.title}</div>
                                            <div className="text-xs text-gray-500 mb-3">{level.desc}</div>
                                            <div className="text-[10px] font-bold tracking-wider uppercase bg-blue-100 text-blue-600 px-2 py-1 rounded">
                                                ğŸ¯ {level.objective}
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setGameState("STAGES")} className="mt-8 px-6 py-3 rounded-xl text-gray-400 hover:text-gray-600 hover:bg-gray-100 text-sm font-bold transition-colors">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            }

            if (gameState === "STORY_MENU") {
                return (
                    <div className="min-h-screen p-6 bg-purple-50 flex flex-col items-center justify-center text-center fade-in">
                        <div className="w-full max-w-sm">
                            <div className="mb-8">
                                <span className="text-6xl mb-2 block">ğŸ“…</span>
                                <h2 className="text-3xl font-black text-purple-900">ä¸€æ—¥ç”Ÿå­˜æˆ°</h2>
                                <p className="text-purple-600/70 text-sm mt-2">ä½ æƒ³åº¦éæ€éº¼æ¨£çš„ä¸€å¤©ï¼Ÿ</p>
                            </div>

                            <div className="grid gap-4">
                                {stages.STORY.subLevels.map(level => (
                                    <button 
                                        key={level.id}
                                        onClick={() => startSubLevel(level)}
                                        className="w-full bg-white p-5 rounded-2xl shadow-sm hover:shadow-md border-2 border-transparent hover:border-purple-300 transition-all group relative overflow-hidden"
                                    >
                                        <div className={`absolute right-0 top-0 w-32 h-32 bg-gradient-to-br ${level.color} opacity-10 rounded-full -mr-10 -mt-10 group-hover:scale-125 transition-transform duration-500`}></div>
                                        <div className="relative flex flex-col items-start text-left">
                                            <div className="font-bold text-lg text-gray-800 mb-1 group-hover:text-purple-700">{level.title}</div>
                                            <div className="text-xs text-gray-500 mb-3 leading-relaxed">{level.desc}</div>
                                            <div className="text-[10px] font-bold tracking-wider uppercase bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                                ğŸ¯ {level.objective}
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setGameState("STAGES")} className="mt-8 px-6 py-3 rounded-xl text-gray-400 hover:text-gray-600 hover:bg-gray-100 text-sm font-bold transition-colors">è¿”å›ä¸»é¸å–®</button>
                        </div>
                    </div>
                );
            }

            if (["TUTORIAL_PLAY", "WARMUP_PLAY", "STORY_PLAY"].includes(gameState)) {
                let title = "";
                let hint = "";
                let storyInfo = null;

                if (gameState === "TUTORIAL_PLAY") { 
                    title = currentSubLevel.title; 
                    hint = currentSubLevel.hint; 
                } 
                else if (gameState === "WARMUP_PLAY") { title = "è‡ªç”±é£Ÿç¿’"; hint = "é»æ“Šé¤ç›¤ä¸Šçš„é£Ÿç‰©å¯ä»¥ç§»é™¤å–”ï¼"; } // Updated hint
                else { 
                    const meal = currentStage.meals[storyMealIndex]; 
                    title = `Day 1 - ${meal.name}`; 
                    hint = meal.hint;
                    storyInfo = { title: meal.storyTitle, desc: meal.storyDesc };
                }
                
                // --- ä¿®æ”¹ï¼šä½¿ç”¨ RestaurantAccordion ä¾†é¡¯ç¤ºé£Ÿç‰© ---
                let availableFoods = foodDatabase;
                if (gameState === "STORY_PLAY") {
                    const meal = currentStage.meals[storyMealIndex];
                    if (meal.tags && meal.tags.length > 0) {
                        availableFoods = foodDatabase.filter(f => f.tags.some(t => meal.tags.includes(t)));
                    }
                }

                const trayP = tray.reduce((acc, f) => acc + (f.p || 0), 0);
                const trayC = tray.reduce((acc, f) => acc + (f.c || 0), 0);
                const trayF = tray.reduce((acc, f) => acc + (f.f || 0), 0);
                const trayCal = tray.reduce((acc, f) => acc + (f.calories || 0), 0);

                const handleBack = () => {
                    if (gameState === "TUTORIAL_PLAY") setGameState("TUTORIAL_MENU");
                    else if (gameState === "STORY_PLAY") setGameState("STORY_MENU");
                    else setGameState("STAGES");
                };

                // åœ¨ STORY_PLAY ä¸­é¡¯ç¤ºæœ¬æ—¥ç´¯ç©ç†±é‡
                const tdee = userProfile?.tdee || 2000;
                const currentTotalCal = (gameState === "STORY_PLAY" ? dailyStats.calories : 0) + trayCal;

                return (
                    <div className="h-screen bg-slate-50 flex flex-col relative fade-in overflow-hidden">
                        <div className={`bg-white shadow-md z-20 flex-shrink-0 flex flex-col items-center transition-all duration-300 ${isHeaderShrunk ? 'py-1' : 'pb-2'}`}>
                            <div className="w-full p-2 flex justify-between items-center border-b">
                                <button onClick={handleBack} className="text-gray-400"><div className="w-6 h-6"><Icons.X /></div></button>
                                <h2 className="font-bold text-gray-800 line-clamp-1">{title}</h2>
                                <div className="w-6"></div>
                            </div>
                            
                            {/* --- Story Mode ç´¯ç©ç†±é‡é€²åº¦æ¢ --- */}
                            {gameState === "STORY_PLAY" && (
                                <div className="w-full px-4 py-2 bg-purple-50 border-b border-purple-100 mb-2">
                                    <div className="flex justify-between items-end mb-1">
                                        <span className="text-xs font-bold text-purple-800">ğŸ”¥ æœ¬æ—¥ç´¯ç©ç†±é‡</span>
                                        <span className="text-xs font-mono text-purple-600">{Math.round(currentTotalCal)} / {tdee} kcal</span>
                                    </div>
                                    <div className="w-full bg-purple-200 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div 
                                            className={`h-full rounded-full transition-all duration-500 ${currentTotalCal > tdee ? 'bg-red-500' : (currentTotalCal > tdee * 0.9 ? 'bg-yellow-500' : 'bg-green-500')}`} 
                                            style={{ width: `${Math.min(100, (currentTotalCal / tdee) * 100)}%` }}
                                        ></div>
                                    </div>
                                </div>
                            )}

                            {/* ç‡Ÿé¤Šæ¯”ä¾‹æ¢ï¼šç¸®å°æ™‚éš±è—æˆ–è®Šå° */}
                            <div className={`w-full mt-2 transition-all duration-300 ${isHeaderShrunk ? 'opacity-0 h-0 overflow-hidden' : 'opacity-100 h-auto'}`}>
                                <NutritionRatioBar p={trayP} c={trayC} f={trayF} calories={trayCal} />
                            </div>

                            {!isHeaderShrunk && <div className="bg-yellow-50 text-yellow-800 text-xs px-3 py-1 rounded-full my-1 font-bold transition-all">ğŸ’¡ {hint}</div>}
                            
                            <div className={`transition-all duration-300 origin-center ${isHeaderShrunk ? 'scale-50 -my-12' : 'scale-90 -my-2'}`}>
                                <RoundPlate tray={tray} onRemove={removeFromTray} />
                            </div>

                            <CurrentPlateAdvice tray={tray} />

                            <div className="w-11/12 flex gap-2">
                                {gameState === "STORY_PLAY" && storyMealIndex > 0 && (
                                    <button onClick={handlePreviousMeal} className="flex-1 py-2 rounded-xl font-bold shadow-md text-sm bg-gray-200 text-gray-600">
                                        ä¸Šä¸€é¤
                                    </button>
                                )}
                                <button onClick={confirmMeal} disabled={tray.length === 0} className={`flex-[2] py-2 rounded-xl font-bold shadow-md text-sm ${tray.length > 0 ? 'bg-yellow-400 text-black' : 'bg-gray-200 text-gray-400'}`}>
                                    {gameState === "STORY_PLAY" && storyMealIndex < 2 ? "ä¸‹ä¸€é¤" : "å®Œé£Ÿçµç®—"}
                                </button>
                            </div>
                        </div>

                        <div 
                            className="flex-1 overflow-y-auto p-4 bg-slate-50 no-scrollbar"
                            onTouchStart={(e) => {
                                touchStart.current = e.targetTouches[0].clientY;
                                startScrollTop.current = e.currentTarget.scrollTop;
                            }}
                            onTouchMove={(e) => {
                                const touchY = e.targetTouches[0].clientY;
                                const diff = touchStart.current - touchY; 
                                
                                if (diff > 10) { 
                                    if (!isHeaderShrunk) setIsHeaderShrunk(true);
                                } 
                                else if (diff < -10 && startScrollTop.current === 0 && e.currentTarget.scrollTop <= 0) {
                                    if (isHeaderShrunk) setIsHeaderShrunk(false);
                                }
                            }}
                            onScroll={(e) => {
                                const scrollTop = e.currentTarget.scrollTop;
                                // å‘ä¸‹æ»¾å‹•è¶…é 40px æ™‚ç¸®å°
                                if (scrollTop > 40 && !isHeaderShrunk) {
                                    setIsHeaderShrunk(true);
                                }
                                // å‘ä¸Šæ»¾å‹•å›åˆ°æœ€é ‚ç«¯ (0) æ™‚æ‰æ”¾å¤§
                                if (scrollTop === 0 && isHeaderShrunk) {
                                    setIsHeaderShrunk(false);
                                }
                            }}
                        >
                            <h3 className="font-bold text-gray-500 mb-2 text-sm">é¸æ“‡é£Ÿç‰©</h3>
                            {/* --- æ”¹ç‚ºä½¿ç”¨ RestaurantAccordion é¡¯ç¤ºé£Ÿç‰© --- */}
                            <RestaurantAccordion foods={availableFoods} onAdd={addFood} />
                            <div className="h-4"></div>
                        </div>

                        <FoodInfoModal food={selectedFoodInfo} onClose={() => setSelectedFoodInfo(null)} />
                        
                        {gameState === "TUTORIAL_PLAY" && (
                            <TutorialFeedbackModal 
                                feedback={tutorialFeedback} 
                                onClose={() => setTutorialFeedback(null)} 
                                onRetry={() => { setTutorialFeedback(null); setTray([]); }} 
                                onNext={() => { setTutorialFeedback(null); setGameState("TUTORIAL_MENU"); }} 
                                onBack={() => { setTutorialFeedback(null); setGameState("TUTORIAL_MENU"); }} 
                            />
                        )}
                        
                        {gameState === "STORY_PLAY" && storyModalOpen && storyInfo && (
                            <StoryModal 
                                title={storyInfo.title} 
                                desc={storyInfo.desc} 
                                onClose={() => setStoryModalOpen(false)} 
                            />
                        )}
                    </div>
                );
            }

            if (gameState === "WARMUP_RESULT") {
                const userTDEE = userProfile?.tdee || 2000;
                const mealTarget = Math.round(userTDEE / 3); 
                // å‚³å…¥ eatenFoods (å–®é¤) - eatenFoods is array of arrays now, so flatten it
                const advices = getNutritionFeedback(dailyStats, mealTarget, eatenFoods.length > 0 ? eatenFoods.flat() : tray);
                const smartInsights = getSmartInsights(eatenFoods.length > 0 ? eatenFoods.flat() : tray, dailyStats, mealTarget); 

                return (
                    <div className="min-h-screen p-6 bg-slate-900 text-white flex flex-col items-center justify-center text-center fade-in overflow-y-auto">
                        <div className="text-6xl mb-4">ğŸ½ï¸</div>
                        <h2 className="text-2xl font-bold mb-4">æœ¬é¤çµç®—</h2>
                        
                        {/* --- æ™ºæ…§æ´å¯Ÿå¡ç‰‡ (æ¨£å¼å„ªåŒ–) --- */}
                        <div className="w-full max-w-sm grid gap-3 mb-6">
                            {smartInsights.map((insight, idx) => (
                                <div key={idx} className={`p-4 rounded-xl border-l-8 text-left shadow-lg bg-white text-gray-800 transform transition-all hover:scale-[1.02] ${insight.type === 'good' ? 'border-green-500' : (insight.type === 'bad' ? 'border-red-500' : (insight.type === 'warn' ? 'border-orange-500' : 'border-blue-400'))}`}>
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-2xl bg-gray-100 rounded-full p-1 w-10 h-10 flex items-center justify-center shadow-sm">{insight.icon}</span>
                                        <div>
                                            <span className={`font-black text-sm block uppercase tracking-wider ${insight.type === 'good' ? 'text-green-600' : (insight.type === 'bad' ? 'text-red-600' : (insight.type === 'warn' ? 'text-orange-600' : 'text-blue-500'))}`}>{insight.title}</span>
                                            <p className="text-sm font-medium text-gray-700 leading-snug">{insight.msg}</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="bg-blue-900/50 p-4 rounded-xl w-full max-w-sm mb-6 border border-blue-700/50 text-left">
                            <h3 className="text-xs text-blue-300 mb-2 uppercase font-bold tracking-wider">ğŸ‘©â€âš•ï¸ ç‡Ÿé¤Šå¸«çš„æœ¬é¤é»è©•</h3>
                            <ul className="text-sm space-y-2">
                                {advices.map((advice, idx) => (
                                    <li key={idx} className="flex gap-2 items-start">
                                        <span className="mt-1">â€¢</span>
                                        <span>{advice}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="bg-white/10 p-6 rounded-2xl w-full max-w-sm mb-8 text-left shadow-sm border border-white/20">
                             <div className="flex justify-between mb-2 font-mono text-sm"><span>ç†±é‡</span><span>{dailyStats.calories} kcal</span></div>
                             <div className="flex justify-between mb-2 font-mono text-sm text-red-300"><span>è›‹ç™½è³ª</span><span>{dailyStats.totalP} g</span></div>
                             <div className="flex justify-between mb-2 font-mono text-sm text-yellow-300"><span>ç¢³æ°´</span><span>{dailyStats.totalC} g</span></div>
                             <div className="flex justify-between font-mono text-sm text-blue-300"><span>è„‚è‚ª</span><span>{dailyStats.totalF} g</span></div>
                             <MacroDistribution p={dailyStats.totalP} c={dailyStats.totalC} f={dailyStats.totalF} calories={dailyStats.calories} />
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setGameState("STAGES")} className="bg-gray-700 text-white px-6 py-3 rounded-full font-bold hover:bg-gray-600">å›åˆ°é¸å–®</button>
                            <button onClick={() => startLevel('WARMUP')} className="bg-yellow-400 text-black px-6 py-3 rounded-full font-bold hover:bg-yellow-300 shadow-lg transform transition hover:-translate-y-1">ğŸ”„ é‡æ–°æŒ‘æˆ°</button>
                        </div>
                    </div>
                )
            }

            if (gameState === "RESULT") {
                const personaId = calculatePersona(dailyStats, userProfile?.tdee || 2000);
                const persona = personaDatabase.find(p => p.id === personaId);
                // å‚³å…¥ eatenFoods (æ•´æ—¥) - eatenFoods is array of arrays, so flatten it
                const dailyAdvices = getNutritionFeedback(dailyStats, userProfile?.tdee || 2000, eatenFoods.flat(), currentSubLevel?.id);
                
                // å–å¾—æ™ºæ…§æ´å¯Ÿ (æ•´æ—¥ç´€éŒ„)
                const smartInsights = getSmartInsights(eatenFoods.flat(), dailyStats, userProfile?.tdee || 2000);
                
                let goalResult = null;
                if (currentSubLevel && currentSubLevel.criteria) {
                    const isSuccess = currentSubLevel.criteria(dailyStats, userProfile?.tdee || 2000);
                    let msg = isSuccess ? currentSubLevel.successMsg : currentSubLevel.failMsg;
                    
                    if (!isSuccess && currentSubLevel.analyzeFail) {
                        msg = currentSubLevel.analyzeFail(dailyStats, userProfile?.tdee || 2000);
                    }

                    goalResult = {
                        success: isSuccess,
                        title: isSuccess ? "ğŸ‰ ç›®æ¨™é”æˆï¼" : "ğŸ’” ç›®æ¨™å¤±æ•—...",
                        msg: msg
                    };
                }

                return (
                    <div className="min-h-screen p-6 bg-slate-900 text-white flex flex-col items-center justify-center text-center fade-in overflow-y-auto">
                        {goalResult && (
                            <div className={`w-full max-w-sm p-4 rounded-xl mb-6 border-2 shadow-lg animate-[popIn_0.5s_ease-out] ${goalResult.success ? 'bg-green-900/40 border-green-500' : 'bg-red-900/40 border-red-500'}`}>
                                <h2 className={`text-2xl font-black mb-1 ${goalResult.success ? 'text-green-400' : 'text-red-400'}`}>{goalResult.title}</h2>
                                <p className="text-sm text-gray-200">{goalResult.msg}</p>
                            </div>
                        )}

                        <div className="mb-6 flex justify-center relative w-48 h-48 mx-auto">
                            {persona.image && persona.image.length > 0 ? (
                                <img 
                                    src={persona.image} 
                                    alt={persona.name} 
                                    className="w-48 h-48 object-contain drop-shadow-2xl img-bounce relative z-10"
                                />
                            ) : (
                                <div className="text-8xl animate-bounce">{persona.emoji}</div>
                            )}
                        </div>

                        <h2 className="text-2xl font-bold mb-2">è¦ºé†’äººæ ¼ï¼š{persona.name}</h2>
                        <p className="text-gray-400 mb-6 max-w-xs">{persona.desc}</p>
                        
                        {/* --- æ™ºæ…§æ´å¯Ÿå¡ç‰‡ --- */}
                        <div className="w-full max-w-sm grid gap-3 mb-6">
                            {smartInsights.map((insight, idx) => (
                                <div key={idx} className={`p-4 rounded-xl border-l-8 text-left shadow-lg bg-white text-gray-800 transform transition-all hover:scale-[1.02] ${insight.type === 'good' ? 'border-green-500' : (insight.type === 'bad' ? 'border-red-500' : (insight.type === 'warn' ? 'border-orange-500' : 'border-blue-400'))}`}>
                                    <div className="flex items-center gap-3 mb-1">
                                        <span className="text-2xl bg-gray-100 rounded-full p-1 w-10 h-10 flex items-center justify-center shadow-sm">{insight.icon}</span>
                                        <div>
                                            <span className={`font-black text-sm block uppercase tracking-wider ${insight.type === 'good' ? 'text-green-600' : (insight.type === 'bad' ? 'text-red-600' : (insight.type === 'warn' ? 'text-orange-600' : 'text-blue-500'))}`}>{insight.title}</span>
                                            <p className="text-sm font-medium text-gray-700 leading-snug">{insight.msg}</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="bg-blue-900/50 p-4 rounded-xl w-full max-w-sm mb-6 border border-blue-700/50 text-left">
                            <h3 className="text-xs text-blue-300 mb-2 uppercase font-bold tracking-wider">ğŸ‘©â€âš•ï¸ ç‡Ÿé¤Šå¸«çš„æ¯æ—¥ç¸½è©•</h3>
                            <ul className="text-sm space-y-2">
                                {dailyAdvices.map((advice, idx) => (
                                    <li key={idx} className="flex gap-2 items-start">
                                        <span className="mt-1">â€¢</span>
                                        <span>{advice}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="bg-white/10 p-4 rounded-xl w-full max-w-sm mb-6 text-left">
                            <h3 className="text-xs text-gray-400 mb-2 uppercase">æœ¬æ—¥æ”å–ç¸½çµ</h3>
                            <div className="font-mono text-sm space-y-1">
                                <div className="flex justify-between"><span>ç†±é‡</span><span>{dailyStats.calories} kcal</span></div>
                                <div className="flex justify-between text-red-300"><span>è›‹ç™½è³ª</span><span>{dailyStats.totalP} g</span></div>
                                <div className="flex justify-between text-yellow-300"><span>ç¢³æ°´</span><span>{dailyStats.totalC} g</span></div>
                                <div className="flex justify-between text-blue-300"><span>è„‚è‚ª</span><span>{dailyStats.totalF} g</span></div>
                            </div>
                            <MacroDistribution p={dailyStats.totalP} c={dailyStats.totalC} f={dailyStats.totalF} calories={dailyStats.calories} />
                        </div>
                        
                        <div className="w-full max-w-sm space-y-4 mb-8">
                            {/* --- æ–°å¢æŒ‰éˆ•ï¼šæŸ¥çœ‹è©³ç´°äººæ ¼å ±å‘Š --- */}
                            <button 
                                onClick={() => setSelectedPersona(persona)}
                                className="w-full bg-yellow-500 text-black py-3 rounded-xl font-bold shadow-lg hover:bg-yellow-400 transition-transform hover:scale-[1.02] flex items-center justify-center gap-2 mb-6"
                            >
                                <span>ğŸ“œ æŸ¥çœ‹è©³ç´°äººæ ¼å ±å‘Š</span>
                                <Icons.ArrowRight />
                            </button>

                            <div className="flex gap-4">
                                <button onClick={() => setGameState("STAGES")} className="flex-1 bg-gray-700 text-white px-4 py-3 rounded-full font-bold hover:bg-gray-600 text-sm">å›åˆ°é¸å–®</button>
                                <button onClick={() => {
                                    setStoryMealIndex(0);
                                    setDailyStats({ health: 50, mood: 50, calories: 0, totalP: 0, totalC: 0, totalF: 0 });
                                    setTray([]);
                                    setEatenFoods([]); // Reset
                                    setGameState("STORY_PLAY");
                                    setStoryModalOpen(true);
                                }} className="flex-1 bg-white text-black px-4 py-3 rounded-full font-bold hover:bg-gray-100 shadow-lg transform transition hover:-translate-y-1 text-sm">ğŸ”„ é‡æ–°æŒ‘æˆ°</button>
                            </div>
                        </div>

                        {/* é€™è£¡éœ€è¦ç¢ºä¿ PersonaDetailModal ä¹Ÿæœƒåœ¨ RESULT ç‹€æ…‹ä¸‹è¢«æ¸²æŸ“ */}
                        <PersonaDetailModal persona={selectedPersona} onClose={() => setSelectedPersona(null)} />
                    </div>
                );
            }

            if (gameState === "GALLERY") {
                return (
                    <div className="min-h-screen p-6 bg-gray-100 fade-in">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-gray-800">é£²é£Ÿäººæ ¼åœ–é‘‘</h2><button onClick={() => setGameState("STAGES")} className="text-gray-500 hover:text-gray-800"><div className="w-6 h-6"><Icons.X /></div></button></div>
                        
                        <div className="grid grid-cols-2 gap-4">{personaDatabase.map(p=>(
                            <div 
                                key={p.id} 
                                onClick={()=>{if(unlockedPersonas.includes(p.id))setSelectedPersona(p)}} 
                                className={`bg-white p-4 rounded-xl shadow-sm flex flex-col items-center text-center transition-transform ${unlockedPersonas.includes(p.id)?'cursor-pointer hover:scale-105':'opacity-70'}`}
                            >
                                <div className={`mb-2 ${unlockedPersonas.includes(p.id)?'':'locked-persona'}`}>
                                    {p.image && p.image.length > 0 ? 
                                        <img src={p.image} alt={p.name} className="w-16 h-16 object-cover rounded-full" /> : 
                                        <div className="text-4xl">{p.emoji}</div>
                                    }
                                </div>
                                <div className="font-bold text-gray-800 text-sm mb-1">{unlockedPersonas.includes(p.id)?p.name:"???"}</div>
                            </div>
                        ))}</div>
                        <PersonaDetailModal persona={selectedPersona} onClose={() => setSelectedPersona(null)} />
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
